---
title: "Calculating the Lives Saved with Deceased Donor Kidney Transplantation"
author: "William F Parker, MD, MS,^1^, Yolanda Becker MD^1^, Robert Gibbons, PhD^1^" 
date: "^1^University of Chicago"
thanks: "This is the preliminary working draft of a commissioned paper for the National Academies of Sciences, Engineering, and Medicine study committee: A Fairer and More Equitable Cost-Effective and Transparent System of Donor Organ Procurement, Allocation, and Distribution. It has not undergone peer review and will undergo substantial changes after feedback from the committee."
output:
  pdf_document:
    latex_engine: xelatex
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
bibliography: references.bib
csl: national-academy-science-letters.csl
urlcolor: blue
---

```{r packages, include = FALSE, cache = FALSE, echo = FALSE}
library(survival)
library(coxme)
library(tidyverse)
library(gtsummary)
library(furrr)
```

```{r global_options, include=FALSE, cache = FALSE}
library(knitr)
opts_chunk$set(cache = TRUE, echo=FALSE, warning=FALSE, message=FALSE, linewidth=60)
```

```{r functions}
#Convenience functions 
numextract <- function(string){
  as.numeric(str_extract(string, "\\-*\\d+\\.*\\d*"))
}
comma <- function(x) format(x, digits = 3, big.mark = ",")
comma_1 <- function(x) format(x, digits = 1, big.mark = ",")
comma_2 <- function(x) format(x, digits = 2, big.mark = ",")
comma_p <- function(x){
  if (x < 0.001){
    return("< 0.001")
  }
  if (x<0.01 & x>=0.001){
    paste("=", format(x, digits = 3, big.mark = ","))
  }
  else{
    paste("=", format(x, digits = 2, big.mark = ","))
  }
} 
```

```{r load_raw_data_for_run, eval = FALSE}
to_model <- read_csv("clean_data.csv")
```

```{r recip_df, eval= FALSE}
kdpi_mapping_table <- read_csv("kdpi_mapping_table_2019.csv") %>%
  mutate(midpoint = (max-min)/2 + min,
         kdpi = row_number()-1) %>%
  filter(kdpi>0 & kdpi<100)
  

KDRI_raw <- function(KDPI, scaling_factor = 1.28991045343964, mapping_table = kdpi_mapping_table){

    KDRI_median <- filter(mapping_table, kdpi == KDPI)$midpoint
  
    KDRI_rao <- KDRI_median*scaling_factor
  
    log(KDRI_rao)
}

KDPI_mapper <- function(kdri, scaling_factor = 1.28991045343964, 
                        mapping_table = kdpi_mapping_table){

  KDRI_rao <- exp(kdri)
  KDRI_median <- KDRI_rao/scaling_factor

  df <- mapping_table %>%
    mutate(cur_KDRI_median = KDRI_median) %>%
    filter(KDRI_median> min & KDRI_median < max)

  KDRI_max <- max(mapping_table$max)
  KDRI_min <- min(mapping_table$min)

  if(is.na(KDRI_median)){
    return(KDRI_median)
  }

  if (nrow(df) > 0){
    return(df$kdpi)
  }
  if (KDRI_median > KDRI_max){
    return(100)
  }
  if (KDRI_median < KDRI_min) {
    return(0)
  }
}

recips <- to_model %>%
  filter(tx ==1) %>% 
  mutate(time = t_2 - t_1,
         i_time_quartile = cut_number(ischemic_time, 4))


no_cores <- availableCores() - 1
plan(multisession, workers = no_cores)

recip_kdpi <- future_map_dbl(recips$tx_kdri, KDPI_mapper)


recips <- recips %>%
  cbind(kdpi = recip_kdpi)

recips <- recips %>% 
  mutate(i_time_quartile = cut_number(ischemic_time, 4))


levels_i_time <- c(levels(recips$i_time_quartile), "unknown")

recips <- recips %>%
  mutate(i_time_quartile = ifelse(is.na(i_time_quartile), "unknown", as.character(i_time_quartile)),
         i_time_quartile = factor(i_time_quartile, levels = levels_i_time)
  )
```

```{r shift_kdri_ischemic_time, eval=FALSE}

min_tx_kdri <- min(to_model$tx_kdri, na.rm = TRUE)

shift_kdri <- function(x, min_kdri =min_tx_kdri ) ifelse(x ==0, 0 ,x + abs(min_kdri) + 1)

to_model <- to_model %>%
    mutate(shifted_tx_kdri = shift_kdri(tx_kdri))


# add ischemic time terms
to_model <- to_model %>% 
  left_join(recips %>% select(PX_ID, i_time_quartile)) %>% 
  mutate(i_time_low = case_when(
    tx == 1 & i_time_quartile == levels(recips$i_time_quartile)[[1]] ~ 1,
    TRUE ~ 0
  ),
  i_time_high = case_when(
    tx == 1 & i_time_quartile == levels(recips$i_time_quartile)[[4]] ~ 1,
    TRUE ~ 0
  ),
  i_time_unknown = case_when(
    tx ==1 & i_time_quartile == levels(recips$i_time_quartile)[[5]] ~ 1,
    TRUE ~ 0
  )
  )
```

```{r fit_fe_models, eval = FALSE}
#empty_model <- "Surv(t_1, t_2, dead) ~ tx"

# epts_kdri <- "Surv(t_1, t_2, dead) ~ raw_epts*tx + tx_kdri + tx_kdri:raw_epts"

# full_can_cov_kdri <-  "Surv(t_1, t_2, dead) ~ (mean_centered_age + dialysis_time_years + diabetes + CAN_PREV_TX)*tx + tx_kdri + (mean_centered_age + dialysis_time_years + diabetes + CAN_PREV_TX):tx_kdri"

epts_covariates <- "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + shifted_tx_kdri + (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):shifted_tx_kdri + ischemic_time + ischemic_time:shifted_tx_kdri"

# no_shift_kdri <-  "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + tx_kdri + (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):tx_kdri + ischemic_time + ischemic_time:tx_kdri"

full_plus_i_time_quartiles <- "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + shifted_tx_kdri + (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):shifted_tx_kdri + i_time_low + i_time_high + i_time_unknown + i_time_low:shifted_tx_kdri + i_time_high:shifted_tx_kdri + i_time_unknown:shifted_tx_kdri"
  
formulas <- c(epts_covariates, full_plus_i_time_quartiles)

fe_models <- vector(mode = "list", length(formulas))
hz_list <- vector(mode = "list", length(formulas))

for (i in seq_along(formulas)) {
  coxph_fe <- coxph(as.formula(formulas[[i]]), to_model)
  print(formulas[[i]])
  print(coxph_fe)
  fe_models[[i]] <- coxph_fe

  #estimate baseline hazard function when all covariates equal to zero 
  # Status 1A, after "Status 1A", low risk donor
  basehz <- basehaz(coxph_fe, centered=FALSE) 
  # %>% 
  #   mutate(hz_t = if_else(time ==1, hazard, (hazard - lag(hazard))/(time -lag(time))), 
  #          hz_t_time = if_else(time ==1, hz_t*time, hz_t*(time -lag(time))), 
  #          cum_hz = cumsum(hz_t_time)) %>% select(time, hz_t)

  hz_list[[i]] <- basehz
}
```

```{r display_fe_model_1, eval = FALSE}
fe_models[[1]]
```

```{r display_fe_model_2, eval = FALSE}
fe_models[[2]]
```

```{r fit_me_model, eval = FALSE}
me_models <-  vector(mode = "list", length(formulas))  

for (i in seq_along(formulas)) {
  f_coxme <- as.formula(paste(formulas[[i]], " + (1+ tx|center)"))
  start_time <- Sys.time()
  cur_model <- coxme(f_coxme, data = to_model)
  me_models[[i]] <- cur_model
  end_time <- Sys.time()
  diff_time <- end_time - start_time
  print(f_coxme)
  print(diff_time)
}

save.image("model_fit.RData")
```

```{r load_data}
load("model_fit.RData")
```

```{r identify_full_model}
full_me_model <- me_models[[2]]
full_base_hz  <- hz_list[[2]]

save(full_me_model, full_base_hz, file = "full_model_results.Rdata")
```

```{=tex}
\centering
\raggedright
```
**Abstract**

Deceased donor organs are the definitive treatment for terminal organ failure, however this life saving treatment is absolutely scarce. The shortage is most severe for deceased donor kidney transplantation, as more than one patient dies every hour waiting for an organ. Despite this, 1 in 5 deceased donor kidneys recovered for transplantation are discarded due to perceived low benefit. We use modern survival analysis methodology to model the survival benefit of deceased donor kidney transplantation and present the results in an easy to use web application. This model has the potential to improve shared decision-making between transplant programs and patients when making accept-reject decisions and to better align kidney allocation policies with federal regulations.

```{=tex}
\newpage
\tableofcontents
```
\pagebreak

# Introduction

Deceased donor organs are absolutely scarce. This means that thousands of patients fortunate enough to get listed will die on the waiting list every year [@national], and countless others who would benefit from a transplant will not even be considered. While efforts to expand the donor pool and encourage transplantation of marginal donors are critical to minimize the shortage, the fact remains that demand for organ transplantation will exceed supply in the US for the foreseeable future. Policymakers at the Organ Procurement and Transplant Network (OPTN) are faced with a tragic choice; they must rank order human beings for a life-saving, medically necessary therapy.

The Department of Health and Human Services' Final Rule directs the OPTN to design organ allocation policies "to achieve the best use of donated organs" [@e-cfr:t]. Specifically, candidates must be ranked from "most to least medically urgent" while "taking into account... that life sustaining technology allows alternative approaches." The survival benefit from transplant, each individual candidates' improvement in survival from organ transplantation, represents a direct quantification of the efficiency principles in the Final Rule, statistically quantifying the "lives saved" from each transplant. While typically applied to liver, heart, and lung transplantation,[@krakauer2005**;** @merion2005; @singh2014; @parker2019] kidney transplantation also dramatically improves recipient survival compared to remaining on dialysis [@wolfe1999; @schnitzler2005; @orandi2016]. Despite the life-saving potential of deceased donor kidney transplantation, U.S. transplant programs discarded 1 in 5 kidneys recovered in 2019 for transplantation [@hart2021]. While centers have been more likely to accept hepatitis C-positive donors over time, donors sorted into a lower allocation sequence by the Kidney Donor Profile Index (KDPI) score have a substantially higher probability of discard. Less than 5% of sequence A and B kidneys (KDPI \< 35%) were discarded compared to 20% of sequence C kidneys (KDPI 35-85%) and 60% of sequence D kidneys (KDPI\> 85%) [@hart2021]. It has been repeatedly shown that accepting a "lower quality" kidney- indicated by either Extended Donor Criteria, increased risk for disease transmission (IRD), or Kidney Donor Profile Index (KDPI) over 70%- leads to a significant survival benefit at 5-years post-transplant compared to waiting for a better organ for the vast majority of patients [@merion2005a; @massie2014; @bowring2018]. Similarly, graft survival at three-years is higher with accepting a high KDPI now rather than waiting for a better graft, unless the candidate is very high priority in high local donor supply environment [@wey2018]. The high discard rate reduces both the total lives saved by the system and outcomes for individual patients.

Part of the low acceptance rates of higher KDPI kidneys may be that patients and transplant physicians have an incomplete representation of the survival benefit of kidney transplantation relative to remaining on the waitlist. We aimed to produce a survival benefit model of deceased donor kidney transplantation (DDKT) that improves upon the existing literature by

1.  Estimating the **lives saved** with each transplant over a defined time interval (5 years) instead of preforming longer-term extrapolations to calculate the total Life-Years From Transplant (LFYT) [@wolfe2008]. We argue that the lives saved per transplant can be more reliably estimated with the available data and is more in line with the ethical principles of the Final Rule than LFYT, which calculates the number of life-years saved with each transplant.
2.  Use modern survival analysis methodology to account for center effects, time-dependent covariates, and interactions between candidate and donor variables.
3.  Develop an accessible end-application for shared decision making between transplant programs and patients to compare deceased donor kidney offers that presents more information than KDPI alone.

\pagebreak

# Data Source and Study Population

This study was a secondary analysis of de-identified, pre-collected data and was granted exemption status by the University of Chicago Biological Sciences Division/University of Chicago Medical Center IRB to be performed without patient consent. This study used data from the [SRTR (Scientific Registry of Transplant Recipients)](https://www.srtr.org/about-the-data/the-srtr-database/). The SRTR data system includes data on all donors, wait-listed candidates, and transplant recipients in the United States, submitted by the members of the OPTN. The Health Resources and Services Administration, U.S. Department of Health and Human Services provides oversight to the activities of the OPTN and SRTR contractors.

We extracted records on all adult ($\geq 18$ years of age at listing), kidney-alone candidates listed between January 1st, 2005 and December 31st, 2010 (N = `r to_model %>% filter(tx ==0) %>% nrow() %>% comma()`). We extracted the candidate covariates included in the Estimated Post-Transplant Survival Model (EPTS) [@eptscal]: age, dialysis time, diabetic status, and history of previous organ transplant (**Table 1A**). We included one initial observation per candidate, defining the beginning of the waitlist period as the date of the first registration for candidates with multiple registrations. The observation time interval spans from the date of initial listing until transplant, death (including deaths after delisting), or last time observed on the waitlist (for untransplanted candidates who do not have a recorded death date). The SRTR dataset includes monthly updates from the National Technical Information Service's (NTIS) [**Death Master File**](https://dmf.ntis.gov/) to capture deaths after delisting that are not recorded by transplant programs.

For the N = `r recips %>% nrow()`candidates that survived and received a deceased donor kidney transplant, we created a second observation with their updated candidate covariates, donor KDRI, and cold ischemic time (**Table 1B**). This observation begins at the time of transplant and ends at death or the date of last-followup. The timing of post-transplant graft failure does not directly influence the model.

## Table 1A: Candidate characteristics at time of listing

```{r candidate_table, results = 'asis'}
tbl_summary(to_model %>% 
              filter(tx ==0) %>%
              select(-PX_ID, -PERS_ID, -center, -tx) %>% 
              mutate("Follow-up time (censored by transplant)" = t_2-t_1) %>% 
              select("Age" = age,
                     "Dialysis time (years)" = dialysis_time_years,
                     "Listed pre-dialysis" = no_dial,
                     "History of diabetes" = diabetes,
                     "History of previous organ transplant" = CAN_PREV_TX,
                     "Raw Estimated Post-transplant Survival (EPTS) score" = raw_epts,
                     "Follow-up time (censored by transplant)",
                     "Observed pre-transplant deaths" = dead)
) %>% as_gt()
```

## Table 1B: Recipient characteristics at time of transplant

```{r recip_table, results = 'asis'}
tbl_summary(recips %>%
              mutate("Post-transplant follow-up time (years)" = (t_2 - t_1)/365)%>% 
              select("Age" = age,
                     "Time on waitlist pre-transplant (days)" = t_1,
                     "Dialysis time (years)" = dialysis_time_years,
                     "History of diabetes" = diabetes,
                     "History of previous organ transplant" = CAN_PREV_TX,
                     "Raw Estimated Post-transplant Survival (EPTS) score" = raw_epts,
                     "Transplant date range" = REC_TX_DT,
                     "Waiting time pre-transplant" = t_1,
                     "KDPI % (2019 mapping table)" = kdpi,
                     "Ischemic time (hours)" = ischemic_time,
                     "Post-transplant follow-up time (years)",
                     "Observed post-transplant deaths" = dead
            )
) %>% as_gt()
```

Next, we arranged the data into a longitudinal dataset (**Table 2**) where candidates had either 1 observation (if they did not receive a transplant) or 2 (if transplanted). The first observation begins at the time of listing and ends with transplant, death without a transplant (including deaths after delisting), or censoring at the last recorded status date on the waitlist (for un-transplanted candidates without a recorded death date). The second observation (present only for recipients) begins at the time of transplant and ends at death or censoring at the date of last-followup. Candidates and recipients were followed up through March 1st, 2021.

## Table 2: Sample of final analytic dataset

```{r example_data}
to_model %>% 
  select(PX_ID, center, t_1, t_2, tx, dead, age, dialysis_time_years, diabetes, CAN_PREV_TX, tx_kdri, ischemic_time) %>%
  mutate(tx_kdri = ifelse(tx ==1, round(exp(tx_kdri), 2), ""),
         ischemic_time = ifelse(tx ==1, ischemic_time, "")) %>%
  head() %>%
  kable(col.names = c("Patient", "Ctr.", "t_1", "t_2", "Transplant", "Dead", "Age", "Dialysis time", "DM", "Hx transplant", "KDRI Rao", "Ischemic Time"), digits = 2)
```

Sample of four patient records in final analytic dataset.

-   Patient 500064 waited $206$ days for before DDKT with a KDRI Rao $1.1$ kidney with $14$ hours of ischemic time. After receiving this transplant, patient 500064 lived $2,476 - 206 = 2,270$ days before death.

-   Patient 470987 waited $684$ days before delisting and did not have a recorded death date so was censored at the time of delisting.

-   Patient 480003 waited $2,540$ days before transplant a KDRI Rao $1.59$ kidney with $12$ hours of ischemic time. Patient 480003 was still alive at last follow-up $4,001 - 2,540 = 1,461$ days post-transplant

-   Patient 648174 waited $117$ days before dying without a transplant

\pagebreak

# Survival benefit calculation

## Mixed-effect Cox Proportional Hazards Model

### Formal Description of the Data

With candidates subscript by $i$, centers by $k$, and donors by $j$, denote the data as:

-   A vector of candidate covariates $X_{ik}(t)$, specifically the **EPTS variables** with their corresponding transformations

    -   $Max(Age\, (years)-25, 0)$
    -   $log(Years \, on \, dialysis + 1)$
    -   $I\{ Years , on , dialysis = 0\}$
    -   $Diabetes$
    -   $Prior \, Solid \, Organ \, Transplant$

-   Candidate death status ($Y_{ik} \in (0,1)$) and follow-up time ( $T_{ik}$)

    -   Includes deaths after delisting for untransplanted candidates and post-transplant deaths

-   Time-dependent indicator variable for transplantation $Tx_{i}(t)$

    -   For each observed transplant:

        -   Donor quality $W_{j}$ (**KDRI Rao**)
        -   Ischemic time $I_{ikj}$, categorized as (\<12 hours, 12-22 hours, \>22 hours, or missing)

### Model Equation

To estimate the primary outcome of survival benefit associated with DDKT, we fit a mixed-effects Cox proportional hazard model with transplant treated as a time-dependent predictor variable [@parker2019].

$$
\begin{aligned} 
h_{ik}(t) = & h_0(t)*exp(\beta_{0k} + X_{ikt} + \beta_{1k}Tx_{ik} + \Pi(W_j * Tx_{ik}) + \gamma*(I_{ijk}*Tx_{ik}) + \alpha(W_j *T_{ik}*X_{ij}))
\end{aligned}
$$

Where: $$\beta_{0k} = \nu_{k0}$$ $$\beta_{1k} = \beta_1 + \nu_{k1}$$ $$(\nu_{k0}, \nu_{k1}) \sim N(0, \Sigma)$$

$$\Sigma = \begin{pmatrix} \sigma_0^2 & \sigma_{01} \\
\sigma_{01} & \sigma_1^2
\end{pmatrix}$$

this model includes:

-   A random intercept $\nu_{0k}$ for each center, representing waitlist risk at that center. Note there is no fixed effect intercept (as this is a proportional hazards model, so the "intercept" is the baseline hazard function $h_0(t)$)

-   A random transplant effect $\beta_{1k}$, which represents the change in hazard from transplant at a particular center

-   A covariance matrix $\Sigma$ for the random effects, which allows for the intercept at transplant effect to be correlated

-   Interaction effects with transplantation to allow the survival benefit of DDKT to vary by

    -   $\Pi$: donor characteristics $W_j$
    -   $\gamma$: ischemic time
    -   $\alpha$: candidate and donor interactions $W_j * X_{ik}(t)$

## Model results

We estimated our model with maximum likelihood estimation using the `coxme` package in `R` [@therneau2018_coxme]. The results are below with the coefficients represented on the log hazard scale. Transplantation is associated with a large negative hazard (better survival) and there are significant interaction effects with candidate age, dialysis time, and history of diabetes. While many of the interaction terms between the candidate covariates and KDRI are small in magnitude and not statistically significant, we chose to retain them to control for selection behaviors by transplant physicians and because of known significant interactions between KDPI and EPTS [@bae2019a] .

```{r include=FALSE}
no_miss <- to_model %>% 
  select(PX_ID, center, t_1, t_2,dead, age_floor_25, log_dial_time, no_dial, CAN_PREV_TX, tx, shifted_tx_kdri, i_time_low, i_time_high, i_time_unknown) %>%
  na.omit()

missing <- to_model %>% 
    select(PX_ID, center, t_1, t_2,dead, age_floor_25, log_dial_time, no_dial, CAN_PREV_TX, tx, shifted_tx_kdri, i_time_low, i_time_high, i_time_unknown) %>%
  anti_join(no_miss)

missing_value_N <- colSums(is.na(to_model %>% select(center, t_1, t_2,dead, age_floor_25, log_dial_time, no_dial, CAN_PREV_TX, tx, shifted_tx_kdri, i_time_low, i_time_high, i_time_unknown)))
```

## Mixed-effects cox proportional hazards model results

### Table 3A: Fixed Effect Coefficients

```{r summarise_main_model}
coefs <- full_me_model$coefficients

w_break <- c(coefs, "")

names(w_break) <- c(names(coefs), "Transplant and interaction terms")

id  <- c( seq_along(coefs), 5+0.5 )
w_break <- w_break[order(id)]

w_break_se <- c(vcov(full_me_model) %>% diag() %>% sqrt(), "")

w_break_se <- w_break_se[order(id)]

tibble(variable = names(w_break),
       coef = w_break,
       se = w_break_se) %>%
  mutate(coef = as.numeric(w_break),
         se = as.numeric(se),
         up_ci = round(coef + 1.96*se, digits = 3),
         low_ci = round(coef - 1.96*se,digits = 3),
         coef = round(coef, digits =3),
         ci = paste0("(", low_ci, ",", up_ci, ")"),
       variable = case_when(
    variable == "age_floor_25" ~ "Max(age -25, 0)",
    variable == "log_dial_time" ~ "log(years on dialysis + 1)",
    variable == "no_dial" ~ "Never dialyzed (pre-emeptive listing)",
    variable == "diabetes" ~ "Diabetes",
    variable == "CAN_PREV_TX" ~ "History of previous solid organ transplant",
    variable == "tx" ~ "Transplantation",
    variable == "shifted_tx_kdri" ~ "KDRI linear component score",
    variable == "i_time_low" ~ "ischemic time < 12 hours",
    variable == "i_time_high" ~ "ischemic time > 22 hours",
    variable == "i_time_unknown" ~ "ischemic time not recorded",
    variable == "age_floor_25:tx" ~ "transplantation:Max(age -25, 0):",
    variable == "log_dial_time:tx" ~ "transplantation:log(years on dialysis + 1)",
    variable == "no_dial:tx" ~ "transplantation:Never dialyzed (pre-emeptive listing)",
    variable == "diabetes:tx" ~ "transplantation:Diabetes",
    variable == "CAN_PREV_TX:tx" ~ "transplantation:History of previous solid organ transplant",
    variable == "age_floor_25:shifted_tx_kdri" ~ "KDRI linear score:Max(age-25,0)",
    variable == "log_dial_time:shifted_tx_kdri" ~ "KDRI linear score:log(years on dialysis + 1)",
    variable == "no_dial:shifted_tx_kdri" ~ "KDRI linear score:Never dialyzed (pre-emeptive listing)",
    variable == "diabetes:shifted_tx_kdri" ~"KDRI linear score:Diabetes",
    variable == "CAN_PREV_TX:shifted_tx_kdri" ~ "KDRI linear score:CAN_PREV_TX",
    variable == "shifted_tx_kdri:i_time_low" ~ "KDRI linear score:ischemic time < 12 hours",
    variable == "shifted_tx_kdri:i_time_high" ~ "KDRI linear score:ischemic time > 22 hours",
    variable == "shifted_tx_kdri:i_time_unknown" ~ "KDRI linear score:ischemic time not recorded",
    TRUE ~ variable
  )) %>%
  select(Variable = variable, Coefficent = coef, "95% CI" = ci) %>%
  mutate_all(function(x) ifelse(is.na(x) == TRUE, "---", x)) %>%
  mutate(`95% CI` = ifelse(`95% CI` == "(NA,NA)", "---", `95% CI`)) %>%
  kable(digits = 2)
```



```{r}
summary(full_me_model)
intercept_Var <- VarCorr(full_me_model)$center[1,1]
transplant_Var <-VarCorr(full_me_model)$center[2,2]
correlation <- VarCorr(full_me_model)$center[1,2]

# tibble(name = c("Intercept (Waitlist) variance", "Transplant Effect", "Correlation"),
#        values = c(VarCorr(full_me_model)$center[1,1], VarCorr(full_me_model)$center[2,2], VarCorr(full_me_model)$center[1,2]))
```
### Table 3B:  Center-level random effects
| Term                                    | Value                                   |
|-----------------------------------------|-----------------------------------------|
| Variance of waitlist risk ($\nu_0$ )    | `r intercept_Var %>% round(digits =2)`  |
| Variance of transplant effect ($\nu_1$) | `r transplant_Var %>% round(digits =2)` |
| Correlation ($Corr(\nu_0, \nu_1)$ )      | `r correlation %>% round(digits =2)`    |

This fit is from N = `rmodel_sum$n[2] %>% comma()` adult candidates listed for kidney alone deceased donor transplant from 2005 to 2010, there were N = `r comma(model_sum$n[1])`. `r nrow(missing) %>% comma()` observations were excluded for missing data, `r missing_value_N['shifted_tx_kdri']` for missing KDRI components and `r missing_value_N['center']` for missing center code. The negative log likelihood was `r full_me_model$loglik['Integrated']`.

### Standard deviation of 5-year survival benefit between centers on log hazard scale

The between-center variance in survival benefit of transplant on the log hazard scale ($B_i = \nu_{1i} - \nu_{0i}$) is the variance of the difference between the two center effects, or

$Var(\nu_{i1} - \nu_{i0}) = Var(v_{1i}) + Var(\nu_{0i}) - 2*Corr(v_{1i}, v_{0i})*\sigma_{v_{0i}}\sigma_{v_{1i}}$

```{r var_tx_benefit}
variance_survival_benefit <- function(me_cox){
  variance_est <- me_cox$vcoef[[1]]
  
  var_wait <- variance_est[[1,1]]
  var_tx <- variance_est[[2,2]]
  cov_tx_wait <- variance_est[[1,2]]*sqrt(variance_est[[1,1]])*sqrt(variance_est[[2,2]])
  
  return(var_wait + var_tx - 2*cov_tx_wait)
}


```

So for the model estimated here, the between-center standard deviation of the survival benefit on the log hazard scale is `r variance_survival_benefit(full_me_model) %>% sqrt() %>% round(digits = 2)`


### Center-level effect on survival benefit
```{r re_effect_centers}
ranef(full_me_model)$center %>% 
  as_tibble() %>% 
  cbind(center = rownames(ranef(full_me_model)$center)) %>% 
  select(center, Intercept, tx) %>%
  arrange(Intercept) %>%
  ggplot(aes(x = Intercept, y = tx)) +
  geom_point() + labs(x = "Intercept (waitlist risk)", y = "transplant effect")
```

Plot of empirical bayes estimates of each center waitlist and transplant effect on the log hazard scale. Values are relative to the mean center (0,0). There is a significant positive correlation between the risk of death on the waitlist and the effect of transplant.



## Estimating survival benefit of DDKT

While a hazard ratio of transplantation for each specific candidate-donor pair can be calculated directly from the coefficients in **Table 3**, more work is required to calculate the improvement in absolute survival with DDKT. Following the previously published methodology of @parker2019, we construct estimates of survival with transplant $S(t|transplant)_{ijk}$ and survival without transplant $S(t|waitlist)_{ijk}$ from the estimated model coefficients and a non-parametric estimate of the baseline hazard function $\hat{h}_{0}(t)$ .

Specifically, assume candidate $X_{ik}$ has waited $t_{tx}$ days and receives an offer for kidney $W_j$ which will suffer ischemic time $I_{ikj}$ in transit. The model can generate counterfactuals for survival with and without transplant.

1.  Calculate the hazard function for the patient with and without transplant

    -   **with transplant**: $$\hat{h}_{ijk}(t|transplant) = \hat{h}_0(t)*(exp(\hat{\beta}_{0k} + X_{ikt}\hat{\beta} + \hat{\beta}_{1k}  + \hat{\Pi}*(W_{j}) + \hat{\gamma}(I_{ikj})) + \hat{\alpha}(W_{j}*X_{ik})$$

    -   **without transplant** $$\hat{h}_{ijk}(t|waitlist) = \hat{h}_0(t)*(exp(\hat{\beta}_{0k} + X_{ikt}\hat{\beta} )$$

2.  Construct survival functions from the hazard functions, comparing transplantation to remaining on the waitlist.

    -   **with transplant**: $$\hat{S}(t|transplant)_{ijk} = exp(-\int_{t_{tx}}^t \hat{h}_{ijk}(t|transplant)) dt$$

    -   **without transplant**: $$\hat{S}(t|wait)_{ik} = exp(-\int_{t_{tx}}^t \hat{h}_{ik}(t|wait)) dt$$

Noting that the **baseline survival function** is $\hat{S}_0(t) = exp(-\int_0^t \hat{h}_0(u)du)$, we can re-write these counterfactual estimates as

-   **with transplant:**

$$
\hat{S}(t|transplant)_{ijk} = \hat{S}_0(t)^{exp(\hat{\beta}_{0k} + X_{ikt}\hat{\beta} + \hat{\beta}_{1k}  + \hat{\Pi}*(W_{j}) + \hat{\gamma}(I_{ikj})) + \hat{\alpha}(W_{j}*X_{ik}))}
$$

-   **without transplant:**

$$
\hat{S}(t|wait)_{ik} = \hat{S}_0(t)^{exp(\hat{\beta}_{0k} + X_{ikt}\hat{\beta})}
$$

3.  Calculate the estimated absolute survival benefit at the specified points in time

    -   $Benefit(1-year)_{ijk} = \hat{S}(365 \, days|transplant)_{ijk} - \hat{S}(365 \, days|wait)_{ik}$
    -   $Benefit(5-year)_{ijk} = \hat{S}(1825 \,days|transplant)_{ijk} - \hat{S}(1825 \,days|wait)_{ik}$

```{r define_ischemic_time_cuts}
i_time_cuts <- quantile(recips$ischemic_time, na.rm = TRUE, probs = c(0.25, 0.75))
```

```{r log_hazard_w_tx_function}
log_hazard_w_tx <- function(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, model= full_me_model, icuts = i_time_cuts, ...){
  # 
  # if(between(kdpi, 1, 99) != TRUE){
  #   return("please enter an integer KDPI value between 1-99")
  # }

  no_dial <- ifelse(d_time == 0, 1,0)
  age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
  log_dial_time <- log(d_time + 1)
  tx_kdri <- KDRI_raw(kdpi)
  #print(tx_kdri)
  shifted_tx_kdri <- shift_kdri(tx_kdri)
  
  
  i_time_low <- ifelse(ischemic_time <= icuts[[1]], 1, 0)
  i_time_high <- ifelse(ischemic_time > icuts[[2]], 1, 0)
  #print(shifted_tx_kdri)
  
  user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX, i_time_low, i_time_high, shifted_tx_kdri)
  
  names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX",
                                  "i_time_low", "i_time_high", "shifted_tx_kdri")
  
  model <- full_me_model
  
  fixed_effects <- fixef(model)
  x_vars <- names(fixed_effects)
  ref <- data.frame(ranef(model)[[1]])
  ref$center <- row.names(ref)
  tx_ref <- filter(ref, center == ctr_id)$tx
  int_ref <- filter(ref, center == ctr_id)$Intercept
  
  #print(paste0("center intercept =", int_ref))
  #print(paste0("center tx effect  =", tx_ref))
  
  h_out <- tx_ref + unname(fixed_effects['tx']) +int_ref + 
    i_time_low*unname(fixed_effects['i_time_low'])+ 
    i_time_high*unname(fixed_effects['i_time_high'])+ 
    shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri']) +
    i_time_low*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:i_time_low'])+ 
    i_time_high*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:i_time_high'])
  
  #print(paste0("log hazard after ischemic time", h_out))

  
  for (x in names(user_patient_params)) {
        value <- unname(user_patient_params[x])
          #print(x)
          #print(value)
        if (!x %in% c("shifted_tx_kdri", "i_time_low", "i_time_high")){
          
          #print("added")
          int_var <- paste0(x, ":tx")
          kdri_int <- paste0(x, ":shifted_tx_kdri")
          
          
          # print(fixed_effects[x])
          # print(fixed_effects[int_var])
          # print(unname(fixed_effects[kdri_int]))
          
          add_hz <- value*(unname(fixed_effects[x]) + 
                             unname(fixed_effects[int_var]) + 
                             unname(fixed_effects[kdri_int])*shifted_tx_kdri)
          
          #print(add_hz)
          
      	  h_out <- h_out + add_hz
        } 
  }
  
  
  return(h_out)

}

```

```{r log_hazard_w_tx_no_re}
log_hazard_w_tx_no_re <- function(Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                  model= full_me_model, icuts = i_time_cuts, ...){
  # 
  # if(between(kdpi, 1, 99) != TRUE){
  #   return("please enter an integer KDPI value between 1-99")
  # }

  no_dial <- ifelse(d_time == 0, 1,0)
  age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
  log_dial_time <- log(d_time + 1)
  tx_kdri <- KDRI_raw(kdpi)
  #print(tx_kdri)
  shifted_tx_kdri <- shift_kdri(tx_kdri)
  
  
  i_time_low <- ifelse(ischemic_time <= icuts[[1]], 1, 0)
  i_time_high <- ifelse(ischemic_time > icuts[[2]], 1, 0)
  #print(shifted_tx_kdri)
  
  #print(c(Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi))
  user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX, i_time_low, i_time_high, shifted_tx_kdri)
  
  #print(user_patient_params)
  names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX",
                                  "i_time_low", "i_time_high", "shifted_tx_kdri")
  
  model <- full_me_model
  
  fixed_effects <- fixef(model)
  x_vars <- names(fixed_effects)
  
  #print(paste0("center intercept =", int_ref))
  #print(paste0("center tx effect  =", tx_ref))
  
  h_out <- unname(fixed_effects['tx']) +
    i_time_low*unname(fixed_effects['i_time_low'])+ 
    i_time_high*unname(fixed_effects['i_time_high'])+ 
    shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri']) +
    i_time_low*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:i_time_low'])+ 
    i_time_high*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:i_time_high'])
  
  #print(paste0("log hazard after ischemic time", h_out))

  
  for (x in names(user_patient_params)) {
        value <- unname(user_patient_params[x])
          #print(x)
          #print(value)
        if (!x %in% c("shifted_tx_kdri", "i_time_low", "i_time_high")){
          
          #print("added")
          int_var <- paste0(x, ":tx")
          kdri_int <- paste0(x, ":shifted_tx_kdri")
          
          
          # print(fixed_effects[x])
          # print(fixed_effects[int_var])
          # print(unname(fixed_effects[kdri_int]))
          
          add_hz <- value*(unname(fixed_effects[x]) + 
                             unname(fixed_effects[int_var]) + 
                             unname(fixed_effects[kdri_int])*shifted_tx_kdri)
          
          #print(add_hz)
          
      	  h_out <- h_out + add_hz
        } 
  }
  
  
  return(h_out)

}


```

```{r log_hazard_waitlist}
log_hazard_waitlist <- function(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, model= full_me_model, ...){
  no_dial <- ifelse(d_time == 0, 1,0)
  age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
  log_dial_time <- log(d_time + 1)
  
  user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX)
  
  names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX")
  
  fixed_effects <- fixef(model)
  x_vars <- names(fixed_effects)
  ref <- data.frame(ranef(model)[[1]])
  ref$center <- row.names(ref)
  int_ref <- filter(ref, center == ctr_id)$Intercept
  
  h_out <- int_ref
  
  for (x in names(user_patient_params)) {
        value <- unname(user_patient_params[x])
          add_hz <- value*(unname(fixed_effects[x]))
      	  h_out <- h_out + add_hz
  }
  
  return(h_out)

}
```

```{r log_hazard_waitlist_no_re}
log_hazard_waitlist_no_re <- function(Age, d_time, diabetes, CAN_PREV_TX, model= full_me_model, ...){
  no_dial <- ifelse(d_time == 0, 1,0)
  age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
  log_dial_time <- log(d_time + 1)
  
  user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX)
  
  names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX")
  
  fixed_effects <- fixef(model)
  x_vars <- names(fixed_effects)

  h_out <- 0
  
  for (x in names(user_patient_params)) {
        value <- unname(user_patient_params[x])
          add_hz <- value*(unname(fixed_effects[x]))
      	  h_out <- h_out + add_hz
  }
  
  return(h_out)

}
```

```{r quality_checks_candidates, eval = FALSE}
# Quality checks for functions

# subset <- to_model %>%
#   select(center, tx, age_floor_25, log_dial_time, no_dial, CAN_PREV_TX, tx_kdri)
# 
# lp_coxme <- predict(full_me_model, type = "lp")
# 
# data_w_predictions <- to_model %>%
#   na.omit() %>%
#   filter(t_2 > t_1) %>%
#   cbind(lp_coxme)

# 
# candidates <- data_w_predictions %>%
#   filter(tx ==0) %>% 
#   filter(row_number() <100) %>%
#   select(center, age, dialysis_time_years, diabetes, CAN_PREV_TX, lp_coxme)
# 
# 
# 
# 
# l <- list(ctr_id = candidates$center, 
#           Age <- candidates$age, 
#           d_time <- candidates$dialysis_time_years, 
#           diabetes <- candidates$diabetes, 
#           CAN_PREV_TX <- candidates$CAN_PREV_TX)
# 
# wait_predictions <- pmap_dbl(l, log_hazard_waitlist)
# 
# candidates %>%
#   cbind(wait_predictions)
```

```{r quality_checks_recipients, eval = FALSE}
#Quality checks for functions
lp_coxme <- predict(full_me_model, type = "lp")

data_w_predictions <- to_model %>%
  select(PX_ID, center, t_1, t_2, tx, age, dialysis_time_years, diabetes, CAN_PREV_TX, tx_kdri, shifted_tx_kdri, i_time_low, i_time_high, i_time_unknown) %>%
  na.omit() %>%
  filter(t_2 > t_1) %>%
  cbind(lp_coxme)


recips_test <- data_w_predictions %>%
  filter(tx ==1) %>%
  left_join(recips %>% select(PX_ID, ischemic_time)) %>%
  filter(is.na(ischemic_time) == FALSE) %>%
  filter(row_number() < 50) %>% 
  select(center, tx, age, dialysis_time_years, diabetes, CAN_PREV_TX, tx_kdri, shifted_tx_kdri, ischemic_time, lp_coxme)

recip_kdpi <- map_dbl(recips_test$tx_kdri, KDPI_mapper)

recips_test <- recips_test %>%
  cbind(kdpi = recip_kdpi)

#ctr_id, Age, d_time, diabetes, CAN_PREV_TX, kdpi
l <- list(ctr_id = recips_test$center,
          Age <- recips_test$age,
          d_time <- recips_test$dialysis_time_years,
          diabetes <- recips_test$diabetes,
          CAN_PREV_TX <- recips_test$CAN_PREV_TX,
          ischemic_time <- recips_test$ischemic_time,
          kdpi <- recips_test$kdpi)



recip_predicts <- pmap_dbl(l, log_hazard_w_tx)

recips_test %>%
  cbind(function_pred = unlist(recip_predicts)) %>%
  mutate(diff = function_pred - lp_coxme) %>%
  ggplot(aes(x = diff)) + 
  geom_histogram()
```

### Figure 1: Baseline survival function $\hat{S}_0(t)$

```{r baseline_hazard_plot}
full_base_hz %>%
  mutate(survival = exp(-hazard)) %>%
  ggplot(aes(x = time, y = survival)) +
  geom_step() + lims(y = c(0,1)) + scale_x_continuous(breaks = seq(0, 16*365, 365))
```

Non-parametric estimate of the baseline waitlist survival for a candidate with 0 for all covariates (so age of 25 or under, no diabetes, just started on dialysis but has not yet accrued any dialysis time, and no history of previous transplant) who never receives a DDKT. There is heavy censoring in the last year of follow-up, so the tail of this survival curve is likely biased downward by informative censoring [@parker_it_2020]. Therefore we have restricted our analysis to the first 5-years following transplant which is less than the average post-transplant follow-up time.

\pagebreak

# Example survival benefit estimates

As we have discussed above, the absolute survival benefit of DDKT is highly non-linear, depending on candidate covariates, time on the waitlist, KDPI, and (to a lesser extent) ischemic time. Therefore we developed a application to visualize the results of our model for any given specification of variables:

<https://wparker-uchicago.shinyapps.io/DDKT_survival_benefit/>

We present a few examples of the model results in this paper.

## Example 1: The median recipient

```{r}
median_t_transplant <-  round(median(recips$t_1, na.rm = TRUE))
median_d_time <- round(median(recips$dialysis_time_years, na.rm = TRUE), digits =1)
median_dm <- median(recips$diabetes)
median_prev_transplant <- median(recips$CAN_PREV_TX, na.rm = TRUE)
median_age <- round(median(recips$age, na.rm = TRUE))
median_ischemic_time <- mean(recips$ischemic_time, na.rm = TRUE)
median_kdpi <- median(recips$kdpi, na.rm = TRUE)

```

Model counterfactual outcomes for the "median" recipient: `r median_age` years old, listed and transplanted at the average center, on dialysis for `r median_d_time` years without a history diabetes or prior organ transplant who has the option of DDKT after `r median_t_transplant` days of waiting with a `r median_kdpi`% KDPI kidney with `r round(median_ischemic_time)` hours of ischemic time.

```{r survival_benefit_function}
percent <- function(x, digits = 1, format = "f", ...) {      
  paste0(formatC(x * 100, format = format, digits = digits, ...), "%")
}

survival_benefit <-  function(t_transplant, ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi,
                              output = "plot",  me_model = full_me_model, isch_cuts = i_time_cuts, b_hazard = full_base_hz){
  
  
  cum_hz <- filter(b_hazard, time == t_transplant)$hazard
  
  df <- b_hazard %>%
  mutate(log_hr_tx = log_hazard_w_tx(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                     model = me_model, icuts = isch_cuts),
         log_hr_wait = log_hazard_waitlist(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, model = me_model),
         hazard = hazard - cum_hz) %>%
  filter(time >= t_transplant) %>%
  mutate(
         H_tx = hazard*exp(log_hr_tx),
         H_wait = hazard*exp(log_hr_wait),
         S_tx = exp(-H_tx),
         S_wait = exp(-H_wait)) %>%
  select(time, S_tx, S_wait) 
  
  
  if (output == "plot"){
      return(df %>%
              filter(time < t_transplant + 365*5) %>%
              mutate(years_from_transplant = (time - t_transplant)/365,
                     tx_dot = ifelse(years_from_transplant==0, 1, NA)) %>%
              ggplot(aes(x = years_from_transplant)) +
              geom_ribbon(aes(ymin = S_wait, ymax = S_tx, fill = "Survival Benefit of DDKT"), alpha = 0.75) + 
              geom_step(aes(y = S_tx, color = "Post-Transplant"), size = 1.2) +
              geom_step(aes(y = S_wait, color = "Waitlist"), size = 1.2) +
              geom_point(aes(y= tx_dot, shape= "Transplant"), size = 5, colour = "darkgreen") +
                scale_x_continuous(breaks = seq(0, 5)) +
               scale_color_manual(name = "Survival function", values=c("blue", "red")) +
                scale_fill_manual(name = NULL, values=c("skyblue")) +
               ggthemes::theme_gdocs() +
               #theme_minimal() +
                lims(y = c(0,1)) + labs(y = "Survival", x = "Time (years after transplant)", shape = "") +
                guides(shape = guide_legend(order = 1), color = guide_legend(order = 2), fill = guide_legend(order = 3))
             )
  }
  
  if (output == "rmst"){
    rmst_df <-df %>%
        mutate(days = (S_tx - S_wait)*(time-lag(time)),
               days = ifelse(row_number() == 1, 0, days),
         rmst = cumsum(days)) 
      return(
         paste0("DDKT would improve survival by ", round(filter(rmst_df, time == t_transplant + 5*365)$rmst/365, digits = 1), " years on average within the first 5 years following transplant")
        )
    }
  if (output == "table"){
        benefit_df <- df %>%
      filter(time %in% c(t_transplant + 365, t_transplant + 3*365,t_transplant + 5*365))
    
    
    return(
      benefit_df %>%
      mutate(S_tx = S_tx,
             S_wait = S_wait,
             surv_benefit = S_tx - S_wait,
             years_from_transplant = (time - t_transplant)/365) %>%
      select("Years from transplant" = years_from_transplant, 
             "Survival (transplant)" = S_tx, 
             "Survival (waitlist)" = S_wait, 
             "Absolute Survival Benefit" = surv_benefit) %>%
          mutate(across(c(2,3,4), percent)) %>%
        kable()
      )
    
  }

}
```

```{r survival_benefit_function_no_re}
survival_benefit_no_re <-  function(t_transplant, Age, d_time, diabetes, CAN_PREV_TX, 
                              ischemic_time, kdpi,
                              output = "plot", me_model = full_me_model, isch_cuts =  i_time_cuts, b_hazard = full_base_hz){
    
    
    cum_hz <- filter(b_hazard, time == t_transplant)$hazard
    
    df <- b_hazard %>%
        mutate(log_hr_tx = log_hazard_w_tx_no_re(Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                           model = me_model, icuts = isch_cuts),
               log_hr_wait = log_hazard_waitlist_no_re(Age, d_time, diabetes, CAN_PREV_TX, model = me_model),
               hazard = hazard - cum_hz) %>%
        filter(time >= t_transplant) %>%
        mutate(
            H_tx = hazard*exp(log_hr_tx),
            H_wait = hazard*exp(log_hr_wait),
            S_tx = exp(-H_tx),
            S_wait = exp(-H_wait)) %>%
        select(time, S_tx, S_wait) 
  
  if (output == "plot"){
      return(df %>%
              filter(time < t_transplant + 365*5) %>%
              mutate(years_from_transplant = (time - t_transplant)/365,
                     tx_dot = ifelse(years_from_transplant==0, 1, NA)) %>%
              ggplot(aes(x = years_from_transplant)) +
              geom_ribbon(aes(ymin = S_wait, ymax = S_tx, fill = "Survival Benefit of DDKT"), alpha = 0.75) + 
              geom_step(aes(y = S_tx, color = "Post-Transplant"), size = 1.2) +
              geom_step(aes(y = S_wait, color = "Waitlist"), size = 1.2) +
              geom_point(aes(y= tx_dot, shape= "Transplant"), size = 5, colour = "darkgreen") +
                scale_x_continuous(breaks = seq(0, 5)) +
               scale_color_manual(name = "Survival function", values=c("blue", "red")) +
                scale_fill_manual(name = NULL, values=c("skyblue")) +
               ggthemes::theme_gdocs() +
               #theme_minimal() +
                lims(y = c(0,1)) + labs(y = "Survival", x = "Time (years after transplant)", shape = "") +
                guides(shape = guide_legend(order = 1), color = guide_legend(order = 2), fill = guide_legend(order = 3))
             )
  }
  
  if (output == "rmst"){
    rmst_df <-df %>%
        mutate(days = (S_tx - S_wait)*(time-lag(time)),
               days = ifelse(row_number() == 1, 0, days),
         rmst = cumsum(days)) 
      return(
         paste0("DDKT would improve survival by ", round(filter(rmst_df, time == t_transplant + 5*365)$rmst/365, digits = 1), " years on average within the first 5 years following transplant")
        )
    }
  
  if (output == "table"){
      benefit_df <- df %>%
    filter(time %in% c(t_transplant + 365, t_transplant + 3*365,t_transplant + 5*365))
  
  
    return(
      benefit_df %>%
      mutate(S_tx = S_tx,
             S_wait = S_wait,
             surv_benefit = S_tx - S_wait,
             years_from_transplant = (time - t_transplant)/365) %>%
      select("Years from transplant" = years_from_transplant, 
             "Survival (transplant)" = S_tx, 
             "Survival (waitlist)" = S_wait, 
             "Absolute Survival Benefit" = surv_benefit) %>%
          mutate(across(c(2,3,4), percent)) %>%
        kable()
      )
    
  }


    
}


```

```{r benefit_plot_example_1}
survival_benefit_no_re(t_transplant = median_t_transplant, 
                       median_age, median_d_time, 
                      median_dm, median_prev_transplant,
                      median_ischemic_time, 
                      median_kdpi,
                       output = "plot")
```

```{r example_1_table, results='asis'}
survival_benefit_no_re(t_transplant = median_t_transplant, 
                       median_age, median_d_time, 
                      median_dm, median_prev_transplant,
                      median_ischemic_time, 
                      median_kdpi, output = "table")
```

```{r example_HR_transplant}
HR_transplant_median <- exp(log_hazard_w_tx_no_re(median_age, median_d_time, 
                      median_dm, median_prev_transplant,
                      median_ischemic_time, 
                      median_kdpi) - 
  log_hazard_waitlist_no_re(median_age, median_d_time, 
                      median_dm, median_prev_transplant))

days_gained_median <- survival_benefit_no_re(t_transplant = median_t_transplant, 
                       median_age, median_d_time, 
                      median_dm, median_prev_transplant,
                      median_ischemic_time, 
                      median_kdpi, output = "rmst")
```

The hazard ratio of transplantation with KDPI `r median_kdpi`% for this median patient is `r round(HR_transplant_median, digits = 2)`, indicating a `r 100*(1-round(HR_transplant_median, digits = 2))`% relative increase in survival with transplantation. The absolute benefit of DDKT increases over time after transplantation, growing each year. Calculating the lives "saved" from DDKT requires a time point to assess survival. For example, the +30% survival benefit at 5-year means that for every 10 "median" DDKT performed will lead to 3 more patients alive at 5-years. Alternatively, the number needed to transplant to save one life (within 5 years) is 3.3.

Calculating the area under a survival function generates a difference in restricted mean survival time [@Royston2013], a metric utilized in the lung allocation score [@egan2006]. The blue shaded area between the two survival functions is an alternative survival benefit metric. In this example, `r days_gained_median`.

### KDPI effect on survival benefit

Here we present the effect of ranging the KDPI from 15% to 80% on the survival benefit of DDKT, holding the characteristics of the "median" recipient constant (`r median_age` years old, listed and transplanted at the average center, on dialysis for `r median_d_time` years, `r median_t_transplant` days of waiting),  (with `r round(median_ischemic_time)` hours of ischemic time). 

#### Median Recipient with KDPI 15% kidney

```{r example_1_KDPI_1_table, results='asis'}
survival_benefit_no_re(t_transplant = median_t_transplant, 
                       median_age, median_d_time, 
                      median_dm, median_prev_transplant,
                      median_ischemic_time, 
                      15, output = "table")
```

#### Median Recipient with KDPI 80% kidney

```{r example_99_KDPI_1_table, results='asis'}
survival_benefit(t_transplant = 500, 782, 59, 2, 1, 0, 15, 80,  output = "table")
```

The post-transplant survival varies significantly by KDPI but the survival benefit of a KDPI 15% kidney over a KDPI 80% is small (\<3%) relative to the risk of death on the waitlist.

\pagebreak

## Example 2: A young patient

Survival benefit from deceased donor kidney transplant at 500 days for a 25 year old patient, on dialysis for 2 years with a past medical history of diabetes transplanted with 15% KDPI kidney with 15 hours of ischemic time

```{r young_example}
survival_benefit(t_transplant = 500, 782, 25, 2, 1, 0, 15, 15)
```

```{r young_example_KPDI_1}
survival_benefit(t_transplant = 500, 782, 25, 2, 1, 0, 15, 1,output = "table")
```

### KDPI 80%

```{r young_example_KDPI_99}
survival_benefit(t_transplant = 500, 782, 25, 2, 1, 0, 15, 80, output = "table") 
```

This younger candidate is less likely to die without a transplant than the median DDKT recipient. So while absolute estimated post-transplant survival (EPTS) for this potential recipient is higher, they actually experience *less* survival benefit than the median recipient.

When comparing outcomes at different KDPI levels, the absolute survival benefit difference between a KDPI 15% and KDPI 80% kidney is significantly less because they are unlikely to die under either counterfactual

## Example 3: An older patient

Survival benefit from deceased donor kidney transplant at 500 days for a 70 year old patient, on dialysis for 2 years with a past medical history of diabetes transplanted with 15% KDPI kidney with 15 hours of ischemic time

```{r old_example}
survival_benefit(t_transplant = 500, 782, 70, 2, 1, 0, 15, 15)
```

```{r old_example_KDPI_1}
survival_benefit(t_transplant = 500, 782, 70, 2, 1, 0,15, 1, output = "table")
```

## KDPI 80%

```{r old_example_KDPI_99}
survival_benefit(t_transplant = 500, 782, 70, 2, 1, 0, 15, 80, output = "table")
```

Despite a lower estimated post-transplant survival, the older patient gets a much higher absolute survival benefit from DDKT driven by a very low survival *without* transplant.

The older recipient gets a higher absolute benefit from lower KDPI kidneys. So while preferentially allocating top 20% KDPI kidneys to top 20% EPTS candidates may lead to higher graft survival, it will save fewer lives at 5-years than directing top 20% kidneys to the candidates at higher risk of death on the waitlist. The latter is arguably more consistent with the Final Rule's directive to allocate organs to the "most urgent" candidates.

We encourage the reader to explore our [web application](https://wparker-uchicago.shinyapps.io/DDKT_survival_benefit/)) to appreciate the full non-linear complexity of calculating the survival benefit of DDKT.

\pagebreak

## Summaring the interactions between candidate and donor characteristics

```{r functions_w_kdri_input}
log_hazard_w_tx_no_re_kdri <- function(Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, tx_kdri, icuts = i_time_cuts, model= full_me_model, ...){
  # 
  # if(between(kdpi, 1, 99) != TRUE){
  #   return("please enter an integer KDPI value between 1-99")
  # }

  no_dial <- ifelse(d_time == 0, 1,0)
  age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
  log_dial_time <- log(d_time + 1)
  #print(tx_kdri)
  shifted_tx_kdri <- shift_kdri(tx_kdri)
  #print(shifted_tx_kdri)
  
  i_time_low <- ifelse(ischemic_time <= icuts[[1]], 1, 0)
  i_time_high <- ifelse(ischemic_time > icuts[[2]], 1, 0)
  #print(shifted_tx_kdri)
  
  user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX, i_time_low, i_time_high, shifted_tx_kdri)
  
  names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX",
                                  "i_time_low", "i_time_high", "shifted_tx_kdri")
  
  model <- full_me_model
  
  fixed_effects <- fixef(model)
  x_vars <- names(fixed_effects)
  
  #print(paste0("center intercept =", int_ref))
  #print(paste0("center tx effect  =", tx_ref))
  
  h_out <- unname(fixed_effects['tx']) +
    i_time_low*unname(fixed_effects['i_time_low'])+ 
    i_time_high*unname(fixed_effects['i_time_high'])+ 
    shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri']) +
    i_time_low*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:i_time_low'])+ 
    i_time_high*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:i_time_high'])
  
  #print(paste0("log hazard after ischemic time", h_out))

  
  for (x in names(user_patient_params)) {
        value <- unname(user_patient_params[x])
          #print(x)
          #print(value)
        if (!x %in% c("shifted_tx_kdri", "i_time_low", "i_time_high")){
          
          #print("added")
          int_var <- paste0(x, ":tx")
          kdri_int <- paste0(x, ":shifted_tx_kdri")
          
          
          # print(fixed_effects[x])
          # print(fixed_effects[int_var])
          # print(unname(fixed_effects[kdri_int]))
          
          add_hz <- value*(unname(fixed_effects[x]) + 
                             unname(fixed_effects[int_var]) + 
                             unname(fixed_effects[kdri_int])*shifted_tx_kdri)
          
          #print(add_hz)
          
      	  h_out <- h_out + add_hz
        } 
  }
  
  
  return(h_out)

}


survival_benefit_at_time_no_re <-  function(t_transplant, Age, d_time, diabetes, CAN_PREV_TX, 
                              ischemic_time, tx_kdri,
                              t_benefit = 1825,
                              isch_cuts = i_time_cuts,
                              me_model = full_me_model, b_hazard = full_base_hz){
    
    
    cum_hz <- filter(b_hazard, time == t_transplant)$hazard
    
    df <- b_hazard %>%
        mutate(log_hr_tx = log_hazard_w_tx_no_re_kdri(Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, tx_kdri,
                                                      icuts = isch_cuts,
                                           model = me_model),
               log_hr_wait = log_hazard_waitlist_no_re(Age, d_time, diabetes, CAN_PREV_TX, model = me_model),
               hazard = hazard - cum_hz) %>%
        filter(time >= t_transplant) %>%
        mutate(
            H_tx = hazard*exp(log_hr_tx),
            H_wait = hazard*exp(log_hr_wait),
            S_tx = exp(-H_tx),
            S_wait = exp(-H_wait)) %>%
        select(time, S_tx, S_wait) 
    

    benefit_df <- df %>%
        filter(time == t_transplant + t_benefit)
    
    if (nrow(benefit_df) ==1){
      return(benefit_df$S_tx - benefit_df$S_wait)
    } else {
      return(NA)
    }
}
```

```{r}
# candidates <- to_model %>% group_by(PX_ID) %>% filter(row_number() ==1) %>% ungroup()
# recips <- to_model %>% filter(tx ==1)
#survival_benefit_at_time_no_re(t_transplant = 100, Age = 70, d_time = 1, diabetes = 0, CAN_PREV_TX = 0, ischemic_time = 15, kdpi = 50)
```

```{r}
# recips <- to_model %>% filter(tx ==1)
# 

# 
# #ctr_id, Age, d_time, diabetes, CAN_PREV_TX, kdpi
# l <- list(t_transplant <- recips$t_1,
#           Age <- recips$age,
#           d_time <- recips$dialysis_time_years,
#           diabetes <- recips$diabetes,
#           CAN_PREV_TX <- recips$CAN_PREV_TX,
#           ischemic_time <- recips$ischemic_time,
#           tx_kdri <- recips$tx_kdri)
# 
# 
# recipient_5yr_survival_benefit <- pmap(l, survival_benefit_at_time_no_re)
# 
# 
# recips %>% 
#   cbind(benefit_5yr = unlist(recipient_5yr_survival_benefit))
```

### 5-year survival benefit by KDPI, Age, and Diabetic Status

```{r survival_benefit_at_time_kdpi}
survival_benefit_at_time_no_re_kdpi <-  function(t_transplant, Age, d_time, diabetes, CAN_PREV_TX, 
                              ischemic_time, kdpi,
                              t_benefit = 1825,
                              me_model = full_me_model, b_hazard = full_base_hz){
    
    
    cum_hz <- filter(b_hazard, time == t_transplant)$hazard
    
    df <- b_hazard %>%
        mutate(log_hr_tx = log_hazard_w_tx_no_re(Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                           model = me_model),
               log_hr_wait = log_hazard_waitlist_no_re(Age, d_time, diabetes, CAN_PREV_TX, model = me_model),
               hazard = hazard - cum_hz) %>%
        filter(time >= t_transplant) %>%
        mutate(
            H_tx = hazard*exp(log_hr_tx),
            H_wait = hazard*exp(log_hr_wait),
            S_tx = exp(-H_tx),
            S_wait = exp(-H_wait)) %>%
        select(time, S_tx, S_wait) 
    

    benefit_df <- df %>%
        filter(time == t_transplant + t_benefit)

    return(benefit_df$S_tx - benefit_df$S_wait)
    
    
}


# plot_sb5_by_kdpi <- function (t_tx, age, dtime, dm, prev_tx, isch_time){
#   l <- list(t_transplant <- rep(t_tx, 99),
#           Age <- rep(age, 99),
#           d_time <- rep(dtime, 99),
#           diabetes <- rep(dm, 99),
#           CAN_PREV_TX <- rep(prev_tx,99),
#           ischemic_time <- rep(isch_time, 99),
#           kdpi <- seq(1, 99, 1))
# 
#   sb_by_kdpi <- pmap(l, survival_benefit_at_time_no_re_kdpi)
#   
#   
#   
#   tibble(KDPI = seq(1,99,1)) %>%
#     cbind(sb_5yr = unlist(sb_by_kdpi)) %>%
#     ggplot(aes(x = KDPI, y = sb_5yr)) + 
#     geom_line() + labs(x = "KDPI (%)", y = "5-year survival benefit") +
#     lims(y = c(0,1))
#   
# }
```

```{r}
sb5_by_kdpi <- function (t_tx, age, dtime, dm, prev_tx, isch_time){
  l <- list(t_transplant <- rep(t_tx, 99),
          Age <- rep(age, 99),
          d_time <- rep(dtime, 99),
          diabetes <- rep(dm, 99),
          CAN_PREV_TX <- rep(prev_tx,99),
          ischemic_time <- rep(isch_time, 99),
          kdpi <- seq(1, 99, 1))

  sb_by_kdpi <- pmap(l, survival_benefit_at_time_no_re_kdpi)
  
  tibble(KDPI = seq(1,99,1)) %>%
    cbind(sb_5yr = unlist(sb_by_kdpi)) %>%
    mutate(Age = age,
           Diabetes = ifelse(dm == 1, "Diabetes", "No Diabetes"),
           dialysis_time = dtime,
           ischemic_time= isch_time)
  
}


benefit_by_kdpi <- sb5_by_kdpi(median_t_transplant, 30, median_d_time, 0, 0, median_ischemic_time) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 40, median_d_time, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 50, median_d_time, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, median_d_time, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 70, median_d_time, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, median_d_time, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 40, median_d_time, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 50, median_d_time, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, median_d_time, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 70, median_d_time, 1, 0, median_ischemic_time))
```

```{r}
benefit_by_kdpi %>%
    ggplot(aes(x = KDPI, y = sb_5yr, color = factor(Age))) + 
    geom_line(size = 1.2) + 
  facet_wrap(~Diabetes) + 
  ggthemes::theme_gdocs() + 
  labs(x = "KDPI (%)", y = "5-year survival benefit", color = "Age at transplant") +
    lims(y = c(0,0.5))
```

5-year improvement in survival following deceased donor kidney transplantation after `r median_t_transplant` days of waiting and `r round(median_d_time, digits =1)` years of dialysis with `r round(median_ischemic_time)` hours of ischemic time. In general, older recipients have greater survival benefit than younger recipients (except for patients with diabetes with KDPI \>75%).

### 5-year survival benefit by dialysis time, age, diabetic status, and KDPI

```{r}
benefit_by_dtime_kdpi <- sb5_by_kdpi(median_t_transplant, 30, 0, 0, 0, median_ischemic_time) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 2, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 4, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 6, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 8, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 0, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 2, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 4, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 6, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 8, 0, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 0, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 2, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 4, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 6, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 30, 8, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 0, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 2, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 4, 1, 0, median_ischemic_time)) %>%
  rbind(sb5_by_kdpi(median_t_transplant, 60, 6, 1, 0, median_ischemic_time)) %>% 
rbind(sb5_by_kdpi(median_t_transplant, 60, 8, 1, 0, median_ischemic_time))
```

```{r}
benefit_by_dtime_kdpi %>%
  filter(dialysis_time !=0) %>% 
      ggplot(aes(x = KDPI, y = sb_5yr, color = factor(dialysis_time), linetype = factor(Age))) + 
    geom_line(size = 1.2) + 
  facet_wrap(~Diabetes) + 
  labs(x = "KDPI (%)", y = "5-year survival benefit", 
       color = "Dialysis time at transplant", linetype = "Age at transplant") +
  ggthemes::theme_gdocs() + 
  scale_color_brewer(palette = "Reds") + 
  #scale_color_viridis_d(option = "B", direction = -1) + 
    lims(y = c(0,0.5))
```

Improvement in survival at 5-years from DDKT after `r median_t_transplant` days of waiting with `r round(median_ischemic_time)` hours of ischemic time by years of dialysis, age, and KDPI.

Candidates with more dialysis time at transplant have greater survival benefit, mediated by poor survival on the waitlist. The effect is non-linear (modeled as $log(years \, on \, dialysis + 1)$, consistent with the EPTS model).

\pagebreak

# Discussion

## Implications for Estimated-Post Transplant Survival based allocation

Under the current Kidney Allocation System (KAS), candidates in the top 20% of estimated post-transplant survival (EPTS) receive higher priority for Sequence A kidneys (KDPI 0-20%). The main goal of this component of the allocation system is to improve graft survival of the highest quality kidneys.

![Kidney Allocation System summary (December 2020 update)](simplified_table.png)

```{r}
recips_test <- recips %>% 
  select(PX_ID, t_1, age, dialysis_time_years, diabetes, 
         CAN_PREV_TX, ischemic_time, kdpi, tx_kdri, 
         age_floor_25, log_dial_time, no_dial) %>%
  na.omit() %>%
  #filter(row_number() <5100) %>%
  mutate(kdpi = ifelse(kdpi == 100, 99, kdpi))

# l <- list(trans_time <- recips_test$t_1,
#           Age <- recips_test$age,
#           d_time <- recips_test$dialysis_time_years,
#           diabetes <- recips_test$diabetes,
#           CAN_PREV_TX <- recips_test$CAN_PREV_TX,
#           ischemic_time <- recips_test$ischemic_time,
#           kdpi <- recips_test$kdpi)
# 
# 
# recip_5yr_no_re <- pmap_dbl(l, survival_benefit_at_time_no_re_kdpi)


l <- list(trans_time <- recips_test$t_1,
          Age <- recips_test$age,
          d_time <- recips_test$dialysis_time_years,
          diabetes <- recips_test$diabetes,
          CAN_PREV_TX <- recips_test$CAN_PREV_TX,
          ischemic_time <- recips_test$ischemic_time,
          tx_kdri <- recips_test$tx_kdri)

possibly_sb_at_time <- possibly(survival_benefit_at_time_no_re, NA)

recip_5yr_no_re_kdri <- pmap_dbl(l, possibly_sb_at_time)
```

```{r epts_mapping_function}
epts_mapping_table <-read_csv("epts_mapping_table_2019.csv") %>%
  mutate(midpoint = (max-min)/2 + min,
         EPTS = row_number()-1) %>%
  filter(EPTS > 0 & EPTS<100)


EPTS_mapper <- function(raw_EPTS, mapping_table =epts_mapping_table){
    df <- mapping_table %>%
    mutate(cur_EPTS = raw_EPTS) %>%
    filter(cur_EPTS> min & cur_EPTS < max)
    
  EPTS_max <- max(mapping_table$max)
  EPTS_min <- min(mapping_table$min)

  if (nrow(df) > 0){
    return(df$EPTS)
  }
  if (raw_EPTS > EPTS_max){
    return(100)
  }
  if (raw_EPTS < EPTS_min) {
    return(0)
  }
}
```

```{r map_EPTS_recips}
recips_test <- recips_test %>% 
  mutate(raw_epts = 0.047*age_floor_25 - 0.015*diabetes*age_floor_25+
           0.398*CAN_PREV_TX- 0.237*diabetes*CAN_PREV_TX+
           0.315*log(dialysis_time_years + 1)- 0.099*diabetes*log(dialysis_time_years + 1) +
           0.130*no_dial - 0.348*no_dial +  
           1.262*diabetes
         )


EPTS <- future_map_dbl(recips_test$raw_epts, EPTS_mapper)
```

### Figure: 5-year survival benefit by EPTS percentile

```{r plot_EPTS_vs_survival_benefit}
recips_test %>%
  cbind(EPTS) %>%
  cbind(survival_benefit = recip_5yr_no_re_kdri) %>%
  group_by(EPTS) %>%
  summarise(mean = mean(survival_benefit, na.rm = TRUE),
            sd = sd(survival_benefit, na.rm = TRUE),
            count = n()) %>%
  mutate(up_ci = mean + 1.96*sqrt(sd/count),
         low_ci = mean - 1.96*sqrt(sd/count),
         top_20 = ifelse(EPTS < 21, "Top 20%", ">20%")) %>%
  ggplot(aes(x = EPTS, y = 100*mean, ymin = 100*low_ci, ymax = 100*up_ci, color = top_20)) +
  geom_point() + geom_errorbar() +
  labs(x = "EPTS % (2019)", y = "Survival Benefit (5-year)", color = "EPTS group")
```

Mean 5-year survival benefit for the the N=`r recips %>% nrow() %>% comma()` transplant recipients in the study cohort by EPTS % (2019 mapping table). The survival benefit of transplant increases as estimated post-transplant survival decreases because the waitlist survival of candidates in the higher EPTS % is much lower than the top 20% EPTS candidates.

This finding is consistent with the work of @bae2019- candidates at higher risk of death on the waitlist have greater survival benefit at 5 years.

### Table: 5-year survival benefit by EPTS quintile

```{r}
recips_test %>% 
  cbind(survival_benefit = recip_5yr_no_re_kdri) %>%
  mutate(epts_quintile = cut(EPTS, breaks = seq(0, 100, 20)))%>%
  group_by(epts_quintile) %>%
  summarise(median_survival_benefit = median(survival_benefit, na.rm = TRUE)) %>%
  mutate(median_survival_benefit = percent(median_survival_benefit)) %>%
  filter(is.na(epts_quintile) == FALSE) %>% 
  kable(col.names = c("EPTS Quintile", "Median 5-year survival benefit"))
```

Top 20% EPTS candidates have the lowest predicted 5-year survival benefit. So while allocating the highest quality kidneys to this group may improve graft longevity in transplant recipients, arguably *this component* of KAS will decrease the number of lives saved by the system.

\pagebreak

## Waiting for a better kidney

### Formal description

The comparison counter-factual thus far in the analysis has been remaining on the waitlist *without* transplantation. However, turning down a particular kidney does not may give a candidate the ability to accept a subsequent offer for a better graft (assuming they survive to receive the next offer).

Our model can construct counterfactuals for this decision.

1.  Accept kidney $W_{j}$ after $t_a$ time on the waitlist. This is the same as the standard post-transplant survival function generated by our model

$$\hat{S}(t|accept \, W_j)_{ijk} = exp(-\int_{t_{a}}^t \hat{h}_{ijk}(t|transplant \, W_{j})) dt$$

2.  Reject kidney $W_{j}$ and wait until time $t_b = t_a + \Delta t$ to get a better kidney $W_{m}$. This patient experiences a discontinuity in hazard, starting off at higher risk during the waiting period- $\hat{h}(wait)$ for time $(t_a, t_b)$- and then improving to lower risk after accepting the better kidney $W_m$ ($\hat{h}(transplant \, W_m)$ for all time after $t_b$)

$$\hat{S}(t|wait \,for \, W_m)_{ijk} = exp(-(\int_{t_{a}}^{t_b} \hat{h}_{ijk}(t|wait)dt + \int_{t_b}^t\hat{h}_{ijk}(t|transplant \, W_{m})dt))$$

## Web application: Take the offer or wait for better?

The decision to take a kidney offer now or wait for a better one depends on all the key variables above. We have developed an online webtool to assist physicians and patients in shared-decision making.

<https://wparker-uchicago.shinyapps.io/DDKT_survival_benefit_compare/>

### Example output

```{r waiting_vs_transplant}
wait_for_better <- function(t_a, kdpi_a, i_time_a,
                            t_b, kdpi_b, i_time_b,
                            Age, d_time, diabetes, CAN_PREV_TX, ctr_id = "mean center", 
                            output = "plot",  me_model = full_me_model, 
                            isch_cuts = i_time_cuts, b_hazard = full_base_hz){
    
    cum_hz <- filter(b_hazard, time == t_a)$hazard
    
    df <- b_hazard
    
    d_time_b <- d_time + (t_b - t_a)/365
    #print(d_time_b)
    Age_b <- Age + (t_b - t_a)/365
    #print(Age_b)
    
    if (ctr_id == "mean center"){
        df <- df %>% 
            filter(time >= t_a) %>%
            mutate(hazard = hazard- lag(hazard),
                   hazard = ifelse(is.na(hazard), 0, hazard)) %>% 
            mutate(log_hr_a = log_hazard_w_tx_no_re(Age, d_time, diabetes,CAN_PREV_TX,
                                                    i_time_a, kdpi_a, 
                                                    model = me_model, icuts = isch_cuts),
                   
                   log_hr_wait = log_hazard_waitlist_no_re( 
                       Age, d_time, diabetes, CAN_PREV_TX, 
                       model = me_model),
                   log_hr_tx_b = log_hazard_w_tx_no_re(Age_b, d_time_b, diabetes,CAN_PREV_TX,
                                                       i_time_b, kdpi_b, 
                                                       model = me_model, icuts = isch_cuts),
                   log_hr_b = ifelse(time >= t_b, log_hr_tx_b, log_hr_wait),
                   h_a = hazard*exp(log_hr_a),
                   h_b = hazard*exp(log_hr_b),
                   h_wait = hazard*exp(log_hr_wait),
                   H_a = cumsum(h_a),
                   H_b = cumsum(h_b),
                   H_wait = cumsum(h_wait),
                   S_a = exp(-H_a),
                   S_b = exp(-H_b),
                   S_wait = exp(-H_wait),
                   years_from_first_offer = (time - t_a)/365,
                   kidney_a = case_when(years_from_first_offer == 0 ~ S_a),
                   kidney_b = case_when(time == t_b ~ S_b),
                   transplant = case_when(
                       #years_from_first_offer == 0 ~ "First Offer",
                       time == t_b ~ "Receive Kidney B"
                   ),
                   transplant_surv = case_when(
                       #years_from_first_offer == 0 ~ S_a,
                       time == t_b ~ S_b
                   ),
                   s_a_better = ifelse(S_a >= S_b, S_a, NA),
                   s_a_worse = ifelse(S_b >= S_a, S_a, NA),
                   s_b_better = ifelse(S_b >= S_a, S_b, NA),
                   s_b_worse = ifelse(S_a >= S_b, S_b, NA)
            ) %>%
            filter(time < t_b + 365*5)
    } else {df <- df %>% 
        filter(time >= t_a) %>%
        mutate(hazard = hazard- lag(hazard),
               hazard = ifelse(is.na(hazard), 0, hazard)) %>% 
        mutate(log_hr_a = log_hazard_w_tx(ctr_id, Age, d_time, diabetes,CAN_PREV_TX,
                                          i_time_a, kdpi_a, 
                                          model = me_model, icuts = isch_cuts),
               
               log_hr_wait = log_hazard_waitlist(ctr_id, 
                                                 Age, d_time, diabetes, CAN_PREV_TX, 
                                                 model = me_model),
               log_hr_tx_b = log_hazard_w_tx(ctr_id, Age_b, d_time_b, diabetes,CAN_PREV_TX,
                                             i_time_b, kdpi_b, 
                                             model = me_model, icuts = isch_cuts),
               log_hr_b = ifelse(time >= t_b, log_hr_tx_b, log_hr_wait),
               h_a = hazard*exp(log_hr_a),
               h_b = hazard*exp(log_hr_b),
               h_wait = hazard*exp(log_hr_wait),
               H_a = cumsum(h_a),
               H_b = cumsum(h_b),
               H_wait = cumsum(h_wait),
               S_a = exp(-H_a),
               S_b = exp(-H_b),
               S_wait = exp(-H_wait),
               years_from_first_offer = (time - t_a)/365,
               kidney_a = case_when(years_from_first_offer == 0 ~ S_a),
               kidney_b = case_when(time == t_b ~ S_b),
               transplant = case_when(
                   #years_from_first_offer == 0 ~ "First Offer",
                   time == t_b ~ "Receive Kidney B"
               ),
               transplant_surv = case_when(
                   #years_from_first_offer == 0 ~ S_a,
                   time == t_b ~ S_b
               ),
               s_a_better = ifelse(S_a >= S_b, S_a, NA),
               s_a_worse = ifelse(S_b >= S_a, S_a, NA),
               s_b_better = ifelse(S_b >= S_a, S_b, NA),
               s_b_worse = ifelse(S_a >= S_b, S_b, NA)
        ) %>%
        filter(time < t_b + 365*5)
    }
    
    if (min(df$S_a) > max(df$S_b)){
        p <- df %>% 
            ggplot(aes(x =years_from_first_offer)) +
            geom_ribbon(aes(ymax = s_a_better, ymin = s_b_worse, fill = "Survival benefit of A over B"), alpha = 0.75) 
        #geom_ribbon(aes(ymax = s_b_better, ymin = s_a_worse, fill = "Survival benefit of B over A"), alpha = 0.75)
        
    } else {
        p <- df %>% 
            ggplot(aes(x =years_from_first_offer)) +
            geom_ribbon(aes(ymax = s_a_better, ymin = s_b_worse, fill = "Survival benefit of A over B"), alpha = 0.75) +
            geom_ribbon(aes(ymax = s_b_better, ymin = s_a_worse, fill = "Survival benefit of B over A"), alpha = 0.75)
    }
    
    
    p <- p +            
        lims(y = c(0, 1)) +
        ggthemes::theme_gdocs() +
        scale_x_continuous(breaks = seq(0,10, 1)) + 
        scale_color_manual(values = c("darkgreen", "blue", "red")) + 
        scale_fill_manual(values = c("forestgreen", "skyblue")) + 
        labs(x = "Years from first offer", 
             y = "Survival",
             shape = "Transplant",
             color = "Scenario",
             fill = "")
    
    if (output == "plot") {

        out <- p +        
            geom_step(aes(y = S_a, color = "Take kidney A now"), size = 1.2) +
            geom_step(aes(y = S_b, color = "Wait for kidney B"), size = 1.2) +
            geom_point(aes(y = kidney_a, shape ="Kidney A"), size = 3) + 
            geom_point(aes(y = kidney_b, shape ="Kidney B"), size = 3) +
            ggrepel::geom_label_repel(aes(y = transplant_surv, label = transplant),
                                      min.segment.length = 0,
                                      nudge_y = -0.15)
    } 
    
    if (output == "wait_plot"){

        out <- p + 
            geom_step(aes(y = S_a, color = "Take kidney A now"), size = 1.2) +
            geom_step(aes(y = S_wait, color = "Remain on waitlist"), size = 1.2)+
            geom_step(aes(y = S_b, color = "Wait for kidney B"), size = 1.2) +
            geom_point(aes(y = kidney_a, shape ="Kidney A"), size = 3) + 
            geom_point(aes(y = kidney_b, shape ="Kidney B"), size = 3) +
            ggrepel::geom_label_repel(aes(y = transplant_surv, label = transplant),
                                      min.segment.length = 0,
                                      nudge_y = -0.15)
            
    }
    
    
    if (output == "rmst"){
        
        df <- df %>%
            mutate(surv_diff = S_a - S_b)
        
        prob_death_pre_b <- (1- filter(df, time == t_b)$S_b)
        
        
        rmst_df <-df %>%
            mutate(days = (S_a - S_b)*(time-lag(time)),
                   days = ifelse(row_number() == 1, 0, days),
                   rmst = cumsum(days)) 
        
        days_a <- round(filter(rmst_df, time == t_a + 5*365)$rmst, digits = 1)
        
        if (days_a < 0){
            out <-  paste0("Waiting ", 
                           (t_b - t_a), " days for Kidney B would increase survival by ", 
                           (-days_a), " days on average within the first 5 years following transplant. The probability the patient dies while waiting is for Kidney B is ", 
                           round(100*prob_death_pre_b), "%.")
        } else {
            out <-  paste0("Accepting Kidney A now would increase survival by ", 
                           days_a, " days on average within the first 5 years following transplant compared to waiting ",(t_b - t_a), " days for Kidney B. The probability the patient dies while waiting for Kidney B is ", round(100*prob_death_pre_b), "%.")
            
        }
        
    }
    
    if (output == "table"){
        benefit_df <- df %>%
            filter(time %in% c(t_a + 365, t_a + 3*365,t_a + 5*365))
        
        
        out <- benefit_df %>%
            mutate(surv_benefit = S_a - S_b,
                   sb_a = S_a - S_wait,
                   sb_b = S_b - S_wait,
                   years_from_first_offer = (time - t_a)/365) %>%
            select("Years from first offer" = years_from_first_offer , 
                   "Survival (accept A)" = S_a,
                   "Survival (wait for B)" = S_b,
                   "Survival (waitlist)" = S_wait, 
                   "Survival Benefit of Accepting A compared to waiting forever" = sb_a,
                   "Survival Benefit of wating for B compared to waiting forever" = sb_b,
                   "Survival Benefit of Accepting A over waiting for B" = surv_benefit) %>%
            mutate(across(c(2,3,4,5,6,7), percent)) %>%
            kable()
        
    }
    
    
    
    return(out)
    
}

```

## KDPI 80% now vs. wait a year for KDPI 40%

```{r example_80_now_v_40_in_a_year}
wait_for_better(100, 80, 15,
                100+365, 15, 15, 
                median_age, median_d_time, 
                      median_dm, median_prev_transplant, "mean center")
```

Survival for the median recipient (`r median_age` years old, `r median_d_time` years of dialysis at listing, no diabetes) accepting an KDPI 80% kidney after 100 days of waiting compared to waiting an additional 365 days for a KDPI 40% kidney. Both grafts have 12-22 hours of ischemic time.

```{r}
wait_for_better(100, 80, 15,
                100+365, 15, 15, 
                median_age, median_d_time, 
                      median_dm, median_prev_transplant, "mean center", 
                output = "table")
```

```{r}
wait_for_better(100, 80, 15,
                100+365, 15, 15, 
                median_age, median_d_time, 
                      median_dm, median_prev_transplant, "mean center", 
                output = "rmst")
```

## Lives-saved, Life-years saved, and Graft Survival

There are several ethically relevant measures of the efficiency of the DDKT allocation systems and comprehensive multi-principled ethical frameworks should consider all three of these measures of benefit [@persad2009].

-   Lives-saved in a defined interval (the focus of this paper)

-   Total years of graft survival (focus of the top 20% KDPI $\to$ top 20% EPTS rule)

-   Life-years saved with each transplant

In a metric considered for incorporation into the kidney allocation system, Wolfe et. al calculated a quality adjusted measured of life-years saved, the Life-years from transplantation (LYFT) [@wolfe2008a]. $$
\begin{aligned} 
LFYT  & = 1.0*(Median \, years \,  with \,  functioning \,  graft) \\
      &  \:  \:  \:  \:  + 0.8*(Median \,  years \,  after \,  graft \,  failure) \\
      & \:  \:  \:  \:  - 0.8*(Median \,  years \,  without \,  transplantation)
\end{aligned}
$$ While we believe our paper represents several important methodologic improvements in survival modeling over LYFT (detailed below), the LYFT models find the same core result as we did- greater short-term survival benefit of DDKT for the elderly.

![Short-term survival benefit in the LFYT models favors older patients](LFYT_paper.pdf){width="50%"}

However, close inspection of the LYFT equation reveals why younger patients get more LYFT. LYFT is the improvement in **median** quality-adjusted life-years from transplantation. Median years of life is equivalent to the point in time when the predicted survival function is 50%. The younger recipients catch up in LYFT is the extrapolation to the median survival time.

![Long-term survival projections required to calculate LYFT](long_term_projection.pdf){width="50%"}

This projection extends far beyond the support of the data for post-transplant survival and cannot be directly estimated. The authors do this by assuming the relative survival benefit of transplant on the log hazard scale remains constant.

![](extrapolation_slopes.png){width="50%"}

This model of patient survival after graft failure is the least supported by data, estimated by "the difference between lifespan following transplant and the lifespan of the functioning graft". However it is possible that after graft failure the patient would "regress to the mean" and the survival curves would converge.

## Methodology improvements compared to LFYT

1.  Joint semi-proportional hazards model instead of 6 separate cox models
2.  Candidate characteristics interacted with time of transplant, donor characteristics
3.  Avoids extrapolation beyond the end of the data (informative censoring)
4.  No subjective quality-adjustment for dialysis time

## Ethical advantages to lives saved at 5-years over LYFT

Absolute survival benefit over a defined time period, the focus of this paper, is a **fundamentally different** measurement of the transplant efficiency that (if used to rank order candidates) would prioritize very different candidates.

1.  No subjective quality-adjustment for dialysis time

2.  LYFT is a pure life-years saved system, which is will save **fewer** lives at shorter time point

3.  LYFT severely disadvantages the elderly

4.  Lives saved at 5-years better identifies the "most urgent" candidates per Final Rule

## Ethical advantages of LYFT over to lives saved at 5-years

1.  Fair innings: right to priortize younger people because they are "worse off" for getting end-stage renal disease at a younger age

    -   10-years of survival benefit for a 30 year old is better than 5-years of survival benefit for a 70 year old.

2.  Directly accounts for benefits of graft survival

# Next steps and questions for discussion

-   Limited set of covariates: EPTS candidate variables, KDRI, and ischemic time

-   Racial and gender equity- evaluate for unintended consequences

    -   hypothesis that racial and ethnic minority groups will have *higher* short-term survival benefit

-   Model does not directly account for non-proportional hazards of transplant (high risk of death immediately post-transplant)

    -   Risk of death days 0-30 greater with transplant than waiting
    -   Can extend model structure to estimate this

-   Need inputs into the transplantation now compared to waiting until a better kidney is available calculation

    -   Will depend on geography and candidate waiting time

    -   Especially important for high-priority candidates

        -   i.e. Top 20% EPTS, high donor supply with 250 mile acuity circle

# To do

-   Calculate the survival benefit of the median transplant recipient at each center?

-   Racial, and gender equity

-   Remaining modeling decisions

    -   We decided against replacing KDPI with components for practical reasons

        -   Should we fix pediatric portion?

# Supplement

# References

```{r}
# Old code

# log_hazard_w_tx_no_re_linear_itime <- function(Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, model= full_me_model, ...){
#   # 
#   # if(between(kdpi, 1, 99) != TRUE){
#   #   return("please enter an integer KDPI value between 1-99")
#   # }
# 
#   no_dial <- ifelse(d_time == 0, 1,0)
#   age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
#   log_dial_time <- log(d_time + 1)
#   tx_kdri <- KDRI_raw(kdpi)
#   #print(tx_kdri)
#   shifted_tx_kdri <- shift_kdri(tx_kdri)
#   #print(shifted_tx_kdri)
#   
#   user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX, ischemic_time, shifted_tx_kdri)
#   
#   names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX",
#                                   "ischemic_time", "shifted_tx_kdri")
#   
#   model <- full_me_model
#   
#   fixed_effects <- fixef(model)
#   x_vars <- names(fixed_effects)
#   
#   #print(paste0("center intercept =", int_ref))
#   #print(paste0("center tx effect  =", tx_ref))
#   
#   h_out <- unname(fixed_effects['tx']) +
#     ischemic_time*unname(fixed_effects['ischemic_time'])+ 
#     shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri'])
#     ischemic_time*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:ischemic_time'])
#   
#   #print(paste0("log hazard after ischemic time", h_out))
# 
#   
#   for (x in names(user_patient_params)) {
#         value <- unname(user_patient_params[x])
#           #print(x)
#           #print(value)
#         if (!x %in% c("shifted_tx_kdri", "ischemic_time")){
#           
#           #print("added")
#           int_var <- paste0(x, ":tx")
#           kdri_int <- paste0(x, ":shifted_tx_kdri")
#           
#           
#           # print(fixed_effects[x])
#           # print(fixed_effects[int_var])
#           # print(unname(fixed_effects[kdri_int]))
#           
#           add_hz <- value*(unname(fixed_effects[x]) + 
#                              unname(fixed_effects[int_var]) + 
#                              unname(fixed_effects[kdri_int])*shifted_tx_kdri)
#           
#           #print(add_hz)
#           
#       	  h_out <- h_out + add_hz
#         } 
#   }
#   
#   
#   return(h_out)
# 
# }
```

```{r}
# log_hazard_w_tx_linear_i_time <- function(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, model= full_me_model, ...){
#   #
#   # if(between(kdpi, 1, 99) != TRUE){
#   #   return("please enter an integer KDPI value between 1-99")
#   # }
# 
#   no_dial <- ifelse(d_time == 0, 1,0)
#   age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
#   log_dial_time <- log(d_time + 1)
#   tx_kdri <- KDRI_raw(kdpi)
#   #print(tx_kdri)
#   shifted_tx_kdri <- shift_kdri(tx_kdri)
#   #print(shifted_tx_kdri)
# 
#   user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX, ischemic_time, shifted_tx_kdri)
# 
#   names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX",
#                                   "ischemic_time", "shifted_tx_kdri")
# 
#   model <- full_me_model
# 
#   fixed_effects <- fixef(model)
#   x_vars <- names(fixed_effects)
#   ref <- data.frame(ranef(model)[[1]])
#   ref$center <- row.names(ref)
#   tx_ref <- filter(ref, center == ctr_id)$tx
#   int_ref <- filter(ref, center == ctr_id)$Intercept
# 
#   #print(paste0("center intercept =", int_ref))
#   #print(paste0("center tx effect  =", tx_ref))
# 
#   h_out <- tx_ref + unname(fixed_effects['tx']) +int_ref +
#     ischemic_time*unname(fixed_effects['ischemic_time'])+
#     shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri'])
#     ischemic_time*shifted_tx_kdri*unname(fixed_effects['shifted_tx_kdri:ischemic_time'])
# 
#   #print(paste0("log hazard after ischemic time", h_out))
# 
# 
#   for (x in names(user_patient_params)) {
#         value <- unname(user_patient_params[x])
#           #print(x)
#           #print(value)
#         if (!x %in% c("shifted_tx_kdri", "ischemic_time")){
# 
#           #print("added")
#           int_var <- paste0(x, ":tx")
#           kdri_int <- paste0(x, ":shifted_tx_kdri")
# 
# 
#           # print(fixed_effects[x])
#           # print(fixed_effects[int_var])
#           # print(unname(fixed_effects[kdri_int]))
# 
#           add_hz <- value*(unname(fixed_effects[x]) +
#                              unname(fixed_effects[int_var]) +
#                              unname(fixed_effects[kdri_int])*shifted_tx_kdri)
# 
#           #print(add_hz)
# 
#       	  h_out <- h_out + add_hz
#         }
#   }
# 
# 
#   return(h_out)
# 
# }


```

```{r ischemic_time_check, eval = FALSE}
# Sanity Checks
recips <- to_model %>%
  filter(tx ==1) %>% 
  mutate(time = t_2 - t_1,
         i_time_quartile = cut_number(ischemic_time, 4))


levels_i_time <- c(levels(recips$i_time_quartile), "unknown")

recips <- recips %>%
  mutate(i_time_quartile = ifelse(is.na(i_time_quartile), "unknown", as.character(i_time_quartile)),
         i_time_quartile = factor(i_time_quartile, levels = levels_i_time)
  )

# gg_survplot <- function(strata_var, df, label){
#   
#   df <- df %>% filter(is.na({{strata_var}})== FALSE)
#   
#   
#   str_vector <- select(df, {{strata_var}})[[1]]
#   str_levels <- unique(str_vector)
#   
#   fit <- survfit(Surv(df[["time"]], df[["dead"]]) ~ str_vector)
# 
#   tibble(counts = fit$strata,
#        sequence = names(fit$strata)) %>%
#   uncount(counts) %>%
#   cbind(
#     tibble(time = fit$time,
#        survival = fit$surv,
#        lower = fit$lower,
#        upper = fit$upper)
#   ) %>%
#   filter(time <= 1825) %>%
#   ggplot(aes(x= time, y = survival, ymin = lower, ymax = upper, fill = sequence, color = sequence)) +
#   geom_step() +
#   scale_x_continuous(breaks = seq(0, 5*365, 365)) +
#   geom_ribbon(alpha = 0.15, size =0) + lims(y = c(0.5,1)) +
#     labs(fill = label, color = label)
#   
# }
# 
# gg_survplot(i_time_quartile, recips, label = "Ischemic time quartile") +
#   labs(y = "Post-transplant patient survival", x = "Days (post-transplant)")

i_time_model <- survfit(Surv(time, dead) ~i_time_quartile, data = recips)


survminer::ggsurvplot(i_time_model, xlim = c(0,5*365), ylim = c(0.5, 1), 
                      censor = FALSE, conf.int = TRUE, break.time.by = 365,
                      legend = "right", ylab= "Post-transplant patient survival")


summary(coxph(Surv(time, dead) ~ i_time_quartile, data = recips))
```
