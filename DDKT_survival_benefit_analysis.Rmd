---
title: "Saving More Lives with Deceased Donor Kidney Transplantation"
author: "William F Parker, MD, PhD,^1^, Yolanda Becker MD^1^, Robert D Gibbons, PhD^1^" 
date: "^1^University of Chicago"
output:
  word_document:
    reference_docx: word_style_times_new_roman_1.docx
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
    includes:
      in_header: "preamble.tex"
    #citation_package: natbib
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
bibliography: references.bib
csl: national-academy-science-letters.csl
urlcolor: blue
always_allow_html: true
---

```{r packages, echo=FALSE, cache=FALSE, include=FALSE}
library(survival)
library(coxme)
library(tidyverse)
library(gtsummary)
library(furrr)
library(kableExtra)
library(gridExtra)
library(lubridate)
no_cores <- availableCores() - 1
```

```{r global_options, include=FALSE, cache = FALSE}
library(knitr)
opts_chunk$set(cache = TRUE, echo=FALSE, warning=FALSE, message=FALSE, linewidth=60)
options(scipen = 999)
```

```{r functions}
#Convenience functions 
numextract <- function(string){
  as.numeric(str_extract(string, "\\-*\\d+\\.*\\d*"))
}
comma <- function(x) format(x, digits = 3, big.mark = ",")
comma_1 <- function(x) format(x, digits = 1, big.mark = ",")
comma_2 <- function(x) format(x, digits = 2, big.mark = ",")
comma_p <- function(x){
  if (x < 0.001){
    return("< 0.001")
  }
  if (x<0.01 & x>=0.001){
    paste("=", format(x, digits = 3, big.mark = ","))
  }
  else{
    paste("=", format(x, digits = 2, big.mark = ","))
  }
} 

```


```{=tex}
\begin{center}
A commissioned paper for \textbf{A Fairer and More Equitable, Cost-Effective, and Transparent System of Donor Organ Procurement, Allocation, and Distribution}, an ad-hoc study committee of the National Academies of Sciences, Engineering, and Medicine.

July, 2021
\end{center}
```

\pagebreak
```{=tex}
\begin{singlespace}
\setcounter{tocdepth}{2}
\tableofcontents
\end{singlespace}
```

\pagebreak
# Executive Summary

## Background 
Kidney transplantation is the definitive treatment for end-stage renal disease, but this life-saving treatment is absolutely scarce with demand greatly exceeding the limits of supply. Only a quarter of candidates receive a deceased donor kidney transplant within five years of listing, and a newly listed candidate is more likely to die or be removed from the list than receive a transplant. Substantial inefficiencies and inequities in the Kidney Allocation System (KAS) exacerbate the harms caused by the organ shortage. Transplant programs discard 1 in 5 deceased donor kidneys recovered for transplantation due to an incorrect perception of low benefit. The Department of Health and Human Services Final Rule states that the Organ Procurement and Transplant Networks (OTPN) should rank candidates by medical urgency to make the best use of organs, however KAS ignores this requirement.

## Objective
Estimate the lives saved by deceased donor kidney transplantation and assess the compliance of kidney allocation policy with the Final Rule.

## Methodology
Using the records of all adult deceased donor kidney candidates listed from 2005-2010 (N = 64,589), we developed a novel mixed-effects model of the survival benefit of deceased donor kidney transplantation. Our model improves upon the existing literature by accounting for center effects, time-dependent covariates, non-proportional hazards, and interactions between candidate and donor variables in a single joint model of the pre and post-transplantation periods.

## Key results

* Deceased donor kidney transplantation was associated with an improvement in estimated five-year survival from 50.8% to 82.4%, an absolute benefit of 31.6%, or one life saved for every 3.16 transplants. 
* There was wide variation in the benefit of survival benefit of transplantation depending on recipient characteristics
  * Older patients, patients with more dialysis time, and patients with diabetes are at high risk of death on the wait-list and have a greater survival benefit from transplantation.
  * Specifically, transplanting patients with diabetes and more than five years of dialysis time saves twice as many lives as transplanting patients without diabetes preemptively (before initiation of dialysis).
  * We developed a web application [Survival Benefit of Decease Donor Kidney Transplantation Calculator](https://wparker-uchicago.shinyapps.io/DDKT_survival_benefit/) to estimate the survival benefit for any candidate at a particular center
* Transplanting patients with higher medical urgency would save more lives than transplanting patients with high estimated post-transplant survival. 
  * Recipients in the top 20% Estimated Post-transplant Survival (EPTS) category have lower than average survival benefit within the first five years following transplantation. 
* There is a significant survival benefit associated with transplantation of high Kidney Donor Profile Index (KDPI) kidneys. 
  * For every four transplants with KDPI $\geq 85\%$ kidneys, one life is saved within the first five years post-transplantation 
  * Within five years, candidates are typically better off taking a higher KDPI kidney when offered compared to waiting for a lower KDPI graft. 
  * We developed a web application to assist transplant programs in incorporating survival benefit into [shared decision-making for accept-reject decisions](https://wparker-uchicago.shinyapps.io/DDKT_survival_benefit_compare/).
* Center of transplantation had a greater association with survival benefit than the donor KDPI
  * the survival benefit of the median KDPI (43%) donor kidney varied from 20% to 48% (IQR 29, 35%) between centers 
  * In contrast, the average improvement in survival benefit of a KDPI 15% kidney compared to a KDPI 60% kidney was only 3.5% (IQR 2,4.7%)
* Non-white recipients have more dialysis time at transplant and are more likely to have diabetes, leading to a larger age-adjusted survival benefit from transplantation than white recipients.
  * The median Black recipient waits two years longer on dialysis before transplantation compared to White recipients.
  * Equity improvements in access to transplantation for minority populations would also be efficient (save more lives)

## Policy recommendations for the Kidney Allocation System

Incorporating survival benefit into deceased donor kidney allocation would align kidney allocation policy with the Final Rule, save more lives, and reduce racial/ethnic disparities in kidney transplantation. Specifically, our results suggest the following policy changes:

* Require transplant programs to document shared-decision making that includes a discussion of survival benefit before making accept-reject decisions for deceased donor organs
* Instruct the Organ Procurement and Transplant Network to study the following changes to the Kidney Allocation System 
  * Eliminate points for pre-dialysis waiting time 
  * Eliminate top 20% EPTS priority
* Evaluate transplant centers by survival benefit, not post-transplant survival
  * Create an incentive for centers to select medically urgent candidates with the most to gain from transplantation
  * Applies to all solid organ transplantation


\pagebreak


# Introduction

Deceased donor organs are absolutely scarce. Thousands of patients fortunate enough to get listed will die on the waiting list every year [@hart2021], and countless others who would benefit from a transplant lack access. While efforts to expand the donor pool and encourage transplantation of marginal donors are critical to minimize the shortage, the fact remains that demand for organ transplantation will exceed supply in the U.S. for the foreseeable future. Policymakers at the Organ Procurement and Transplant Network (OPTN) must confront a tragic choice; they must rank order human beings for a life-saving, medically necessary therapy.

The Department of Health and Human Services' Final Rule directs the OPTN to design organ allocation policies "to achieve the best use of donated organs" [@e-cfr:t]. Specifically, the OPTN must rank candidates from "most to least medically urgent" while "taking into account... that life-sustaining technology allows alternative approaches." The survival benefit from a transplant, or each candidates' improvement in survival from organ transplantation, represents a direct quantification of the efficiency principles in the Final Rule, statistically quantifying the "lives saved" from each transplant. Like liver, heart, and lung transplantation [@krakauer2005; @merion2005; @singh2014; @parker2019; @egan2006], kidney transplantation dramatically improves recipient survival compared to remaining on dialysis [@wolfe1999; @schnitzler2005; @orandi2016; @Cohen2017]. Dialysis may be a "life-sustaining measure," but it is much less effective at sustaining life than kidney transplantation.

However, compared to the other solid organ allocation systems, the current Kidney Allocation System (KAS) does not rank-order candidates by medical urgency as required by the Final Rule. KAS ranks candidates mainly by waiting time, with increased priority for hard-to-match highly sensitized patients and candidates with high Expected Post-Transplant Survival (EPTS). The policy does explicitly prioritize candidates without viable options for dialysis access, appreciating that kidney transplantation is acutely life-saving for these candidates. However, this limited policy measure fails to account for the widely varying risk of death while waiting on dialysis [@unitedstatesrenaldatasystem2020].

Compounding the fact that the current kidney allocation policy largely ignores medical urgency, U.S. transplant programs discarded 1 in 5 kidneys recovered in 2019 for transplantation [@hart2021], a rate far higher than Europe [@Aubert2019a]. While centers have been more likely to accept hepatitis C-positive donors over time, donors sorted into a lower allocation sequence by the Kidney Donor Profile Index (KDPI) [@kdpi_guide] score have a substantially higher probability of discard [@hart2021]. Less than 5% of sequence A and B kidneys (KDPI \< 35%) were discarded compared to 20% of sequence C kidneys (KDPI 35-85%) and 60% of sequence D kidneys (KDPI\> 85%) [@hart2021]. Accepting a "lower quality" kidney- indicated by either Extended Donor Criteria, increased risk for disease transmission (IRD), or Kidney Donor Profile Index (KDPI) over 70%- leads to a significant survival benefit at five years post-transplant compared to waiting for a better organ for the vast majority of patients [@merion2005a; @massie2014; @bowring2018]. Similarly, graft survival at three years is higher with accepting a high KDPI now rather than waiting for a better graft, except for very high priority candidates in a high local donor supply environment [@wey2018]. The high discard rate reduces both the total lives saved by the system and outcomes for individual patients.

We present a model of the survival benefit of deceased donor kidney transplantation (DDKT) that improves upon the existing literature by accounting for center effects, time-dependent covariates, non-proportional hazards, and interactions between candidate and donor variables. We specifically designed the model to generate an estimate  **Lives Saved per Transplant within 5 years (LiST-5)** and developed an accessible end-application that presents more information than KDPI and allows transplant programs and patients to compare deceased donor kidney offers. We developed this improved survival benefit model of deceased donor kidney transplantation to address four key aims:

1.  **Demonstrate how the current Kidney Allocation System is inconsistent with the Final Rule.** A rigorous survival benefit model with easy to interpret outputs is necessary to conclusively demonstrate how the current ranking of candidates on the wait-list fails to meet the Final Rule requirements of transplanting the patients with the most to gain.
2.  **Improve shared decision-making in accept-reject decisions for deceased donor kidney offers.** Part of the low acceptance rates of higher KDPI kidneys may be that patients and transplant physicians have an incomplete representation of the survival benefit of kidney transplantation relative to remaining on the wait-list. Incorporating accessible representations of survival benefit would improve shared decision-making between patients and their physicians and can reduce discards.
3.  **Improve the evaluation of transplant center performance.** Transplant programs are currently evaluated based on post-transplant survival, not survival benefit. While assessments of post-transplant survival are case-mix adjusted for medical urgency by the SRTR, this is fundamentally different than evaluating centers based on the number of lives saved per kidney transplant. We aimed to demonstrate the potential advantages of assessing program performance based on lives saved with transplantation instead of post-transplant survival.
4.  **Determine the potential impact of incorporating survival benefit into kidney allocation on racial/ethnic disparities in kidney transplantation.** While the Kidney Allocation System improved the raw transplantation rates for people from underserved populations who are fortunate enough to gain access to the list [@Hart2021; @Melanson2017], significant structural inequities remain embedded in the system. Black patients are less likely to be listed for transplantation [@Zhang2018] and have less than half the chance of receiving preemptive transplantation compared to White patients [@King2019]. The disparities continue after listing. Transplant programs are more likely to place Black and Hispanic in "inactive" status, and highly-sensitized Black patients are significantly less likely to be transplanted [@Kulkarni2019]. Therefore, determining how incorporating survival benefit into the Kidney Allocation System could mitigate or exacerbate structural racism in kidney transplantation is critical

# Methods

## Data Source and Study Population

This study was a secondary analysis of de-identified, pre-collected data and was granted exemption status by the University of Chicago Biological Sciences Division/University of Chicago Medical Center IRB to be performed without patient consent. This study used data from the [SRTR (Scientific Registry of Transplant Recipients)](https://www.srtr.org/about-the-data/the-srtr-database/). The SRTR data system includes data on all donors, wait-listed candidates, and transplant recipients in the United States, submitted by the members of the OPTN. The Health Resources and Services Administration, U.S. Department of Health and Human Services provides oversight to the activities of the OPTN and SRTR contractors.

We analyzed the records of all adult ($\geq 18$ years of age at listing), kidney-alone candidates listed between January 1st, 2005 and December 31st, 2010. We extracted the candidate covariates included in the Estimated Post-Transplant Survival Model (EPTS): age, dialysis time, diabetic status, and history of previous organ transplant [@eptscal]. We included one initial observation per candidate, defining the beginning of the wait-list period as the date of the first registration for candidates with multiple registrations. The observation time interval spans from the date of initial listing until transplant, death (including deaths after de-listing), or last time observed on the wait-list (for untransplanted candidates who do not have a recorded death date). The SRTR dataset includes monthly updates from the National Technical Information Service's (NTIS) [Death Master File](https://dmf.ntis.gov/) to capture deaths after de-listing that transplant programs do not record. We chose 2005-2010 in order to have a full ten years of follow-up to follow the cohort from the time of listing until transplantation or death and therefore generate an estimate of LiST-5 that is unlikely to be biased by informative censoring. 

For candidates that received a deceased donor kidney transplant, we created 1-3 additional observations with their updated candidate covariates, donor KDPI (mapped to 2019 percentiles), and cold ischemic time to capture the varying risk of death post-transplant over time [@massie2014]. The first observation begins at the time of transplant and ends at death or 30 days post-transplant. The second begins at day 30 post-transplant and ends at death or day 180. The last observation spans from day 180 post-transplant to death or last follow-up time. See **Table S1** in the appendix for a more detailed description of the data.

## Survival benefit model
The primary outcome was the survival benefit of deceased donor kidney transplantation at five years post-transplantation estimated with a mixed-effects Cox proportional hazard model with transplant treated as a time-dependent predictor variable [@parker2019; @ripatti2000; @therneau2003], a single joint model of the pre and post-transplant period. This model accounts for the non-proportional hazard of transplantation by estimating the hazard of death in four distinct periods: 1) pre-transplant, 2) within 30 days post-transplant, 3) day 30-180 post-transplant, and 4) beyond 180 days post-transplantation. The model has a center-level random intercept and random transplant effect, which accounts for the clustering of patients within centers and allows for the risk of death with and without transplantation to vary at the center level.

We restricted the patient-level model covariates to the variables currently readily available at the time of organ allocation: candidate characteristics used in the EPTS score (age, diabetes status, duration of dialysis, and history of previous organ transplantation), donor KDPI, and ischemic time. We included all interaction terms previously found to influence wait-list or post-transplant survival and chose to retain all the interaction terms regardless of significance to control for selection behaviors by transplant physicians [@bae2019a]. Data from after transplantation, such as the timing of post-transplant graft failure, does not enter into the model. We estimated the model by maximum likelihood with the `coxme` package in `R` [@therneau2018_coxme].

To calculate the absolute estimated survival with and without transplantation, we multiplied each patient's time-dependent predicted hazard ratio with a Nelson-aalen estimate of the baseline hazard (**Figure S1**) [@parker2019]. This technique allows quantification of survival benefit on a clinically relevant and intuitive scale. We calculated the five-year survival with and without transplant and survival benefit for all recipients in our study cohort. We then estimated the mean, median, and intraquartile range of all three outcomes. See the **supplemental material** for a technical description of the model, additional methodology, and complete statistical code.

## Association of medical urgency and EPTS with survival benefit
We determined the association of five-year mortality without a transplant (medical urgency as estimated by the model) and the OTPN Estimated Post-Transplant Survival score (2019 EPTS percentiles) with survival benefit. To specifically evaluate the compliance of the top 20% KDPI to the top 20% EPTS policy with the Final Rule, we compared the survival benefit of a 15% KPDI donor kidney to a 60% KDPI donor kidney by EPTS score. Finally, we determined the association between the candidate variables that compose EPTS (age, dialysis, history of diabetes, and previous transplantation) with survival benefit. Specifically, we calculated the survival benefit of a preemptive transplant compared to the benefit of transplanting a patient on dialysis.

## Association of transplant center with survival benefit

Following the approach employed by the Center for Medicare and Medicaid Services [@krumholz2006; @shahian2005], we used the empirical Bayes estimates of each center's intercept and transplant effect to calculate the average survival benefit across kidney transplant programs, case-mix adjusting for donor variables. Specifically, we estimated the survival benefit of deceased donor kidney transplantation at each center at KDPI 15%, median KDPI, and KDPI 60% (with median ischemic time). We did not case-mix adjust for candidate covariates because transplant programs are responsible for selecting candidates for the wait-list from a large pool of potential candidates for transplantation [@Saran2020].


## Lives saved by high KDPI kidneys and shared-decision making tool

When considering a deceased donor kidney offer, the proper counter-factual is not waiting indefinitely on dialysis without transplantation. Turning down a particular kidney perceived to be low quality may give a candidate the ability to accept a subsequent offer for a better graft, assuming they survive to receive the next offer. Therefore we applied our model to construct the estimated survival function for waiting a designated time before receiving a deceased donor kidney transplant (see **Supplement** for details).

In 2019, transplant programs discarded 60% of kidneys from deceased donors with KDPI  $> 85\%$ despite the high established survival benefit of these organs [@hart2021]. We estimate the number of lives saved by KDPI $> 85\%$ donor kidneys in recipients undergoing deceased donor kidney transplantation in 2019.

## Association of race/ethnicity with survival benefit

We calculated the summary statistics of all model covariates by racial/ethnic group. We then estimated the average survival benefit for first-time solid organ recipients by racial/ethnic group. To avoid confounding by differences in age distribution between racial/ethnic groups, we age-adjusted using the direct-standardization by age decile. Because our study cohort was listed before the implementation of the Kidney Allocation System in 2014, we determined trends in the key model covariates of dialysis time and preemptive transplants (transplants performed before the start of dialysis) for each racial/ethnic group from 2000-2010.

We performed all analyses using `R` version 3.6.1 (R Foundation for Statistical Computing). We used 2-sided statistical tests and a p-value of \< 0.05 to reject the null hypothesis.

# Results

## Description of the study population



```{r fit_fe_models, eval = FALSE}
#empty_model <- "Surv(t_1, t_2, dead) ~ tx"

# epts_kdri <- "Surv(t_1, t_2, dead) ~ raw_epts*tx + tx_kdri + tx_kdri:raw_epts"

# full_can_cov_kdri <-  "Surv(t_1, t_2, dead) ~ (mean_centered_age + dialysis_time_years + diabetes + CAN_PREV_TX)*tx + tx_kdri + (mean_centered_age + dialysis_time_years + diabetes + CAN_PREV_TX):tx_kdri"

# epts_covariates <- "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + tx_kdri + (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):tx_kdri + ischemic_time + ischemic_time:tx_kdri"

# no_shift_kdri <-  "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + tx_kdri + (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):tx_kdri + ischemic_time + ischemic_time:tx_kdri"

# full_plus_i_time_quartiles <- "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + tx_kdri + (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):tx_kdri + i_time_low + i_time_high + i_time_unknown + i_time_low:tx_kdri + i_time_high:tx_kdri + i_time_unknown:tx_kdri"


empty_model <- "Surv(t_1, t_2, dead) ~ tx+ immediate_post_trans + second_post_trans_int"

no_ints <- "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + 
tx_kdri + 
(age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):tx_kdri + 
i_time_low + i_time_high + i_time_unknown +  
immediate_post_trans + second_post_trans_int"
  
  
no_dm_ints <- "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx + 
tx_kdri + 
(age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):tx_kdri + 
(age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*immediate_post_trans + 
(age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*second_post_trans_int +
immediate_post_trans:tx_kdri + second_post_trans_int:tx_kdri + 
i_time_low + i_time_high + i_time_unknown"

full_model <- "Surv(t_1, t_2, dead) ~ (age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*tx +
(age_floor_25 + log_dial_time + no_dial + CAN_PREV_TX):diabetes +
(age_floor_25 + log_dial_time + no_dial + CAN_PREV_TX):diabetes:tx +
tx_kdri + 
(age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX):tx_kdri + 
(age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*immediate_post_trans + 
(age_floor_25 + log_dial_time + no_dial + diabetes + CAN_PREV_TX)*second_post_trans_int +
immediate_post_trans:tx_kdri + second_post_trans_int:tx_kdri + 
i_time_low + i_time_high + i_time_unknown"

  
#formulas <- c(epts_covariates, full_plus_i_time_quartiles, final_model)

formulas <- c(empty_model, no_ints, no_dm_ints, full_model)

fe_models <- vector(mode = "list", length(formulas))
hz_list <- vector(mode = "list", length(formulas))

for (i in seq_along(formulas)) {
  coxph_fe <- coxph(as.formula(formulas[[i]]), extended_to_model)
  print(formulas[[i]])
  print(coxph_fe)
  fe_models[[i]] <- coxph_fe

  #estimate baseline hazard function when all covariates equal to zero 
  # Status 1A, after "Status 1A", low risk donor
  basehz <- basehaz(coxph_fe, centered=FALSE) 
  # %>% 
  #   mutate(hz_t = if_else(time ==1, hazard, (hazard - lag(hazard))/(time -lag(time))), 
  #          hz_t_time = if_else(time ==1, hz_t*time, hz_t*(time -lag(time))), 
  #          cum_hz = cumsum(hz_t_time)) %>% select(time, hz_t)

  hz_list[[i]] <- basehz
}
```

```{r fit_me_model, eval =FALSE}
formulas <- c(full_model)
me_models <-  vector(mode = "list", length(formulas))  

for (i in seq_along(formulas)) {
  f_coxme <- as.formula(paste(formulas[[i]], " + (1+ tx|center)"))
  start_time <- Sys.time()
  cur_model <- coxme(f_coxme, data = extended_to_model)
  me_models[[i]] <- cur_model
  end_time <- Sys.time()
  diff_time <- end_time - start_time
  print(f_coxme)
  print(diff_time)
}

save.image("model_fit_extended.RData")
```

```{r load_data_and_recreate_raw_epts}
load("model_fit_extended.Rdata")

extended_to_model <- extended_to_model %>%
    mutate(raw_epts = 0.047*age_floor_25 - 0.015*diabetes*age_floor_25+
           0.398*CAN_PREV_TX- 0.237*diabetes*CAN_PREV_TX+
           0.315*log(dialysis_time_years + 1)- 0.099*diabetes*log(dialysis_time_years + 1) +
           0.130*no_dial - 0.348*no_dial +  
           1.262*diabetes
         )
```

```{r epts_mapping_function}
epts_mapping_table <-read_csv("epts_mapping_table_2019.csv") %>%
  mutate(midpoint = (max-min)/2 + min,
         EPTS = row_number()-1) %>%
  filter(EPTS > 0 & EPTS<100)


EPTS_mapper <- function(raw_EPTS, mapping_table =epts_mapping_table){
    df <- mapping_table %>%
    mutate(cur_EPTS = raw_EPTS) %>%
    filter(cur_EPTS> min & cur_EPTS < max)
    
  EPTS_max <- max(mapping_table$max)
  EPTS_min <- min(mapping_table$min)

  if (nrow(df) > 0){
    return(df$EPTS)
  }
  if (raw_EPTS > EPTS_max){
    return(100)
  }
  if (raw_EPTS < EPTS_min) {
    return(0)
  }
}
```

```{r map_EPTS, eval = FALSE}
plan(multisession, workers = no_cores)
EPTS <- future_map_dbl(extended_to_model$raw_epts, EPTS_mapper)
save(EPTS, file = "EPTS_values.Rdata")
```

```{r load_EPTS}
load("EPTS_values.Rdata")
extended_to_model <- extended_to_model %>%
  cbind(EPTS) 
```

```{r sample_counts}
n_adults_pre_center_filter <- waitlist %>% nrow()

candidates <- extended_to_model %>%
  group_by(PX_ID) %>%
  arrange(t_1) %>%
  filter(row_number() == 1)

n_candidates <- candidates %>%
  nrow()

n_recips_total <- to_model %>%
  filter(tx ==1) %>% 
  nrow()

n_recips_minus_centers <- extended_to_model %>% 
  filter(tx ==1 & immediate_post_trans ==1) %>%
  select(PX_ID, center, age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX, 
         tx,immediate_post_trans, second_post_trans_int, i_time_low, i_time_high, i_time_unknown, tx_kdri, t_1, t_2, dead) %>%
  nrow()

recips <- extended_to_model %>% 
  filter(tx ==1 & immediate_post_trans ==1) %>%
  select(PX_ID, center, age, age_floor_25, dialysis_time_years, log_dial_time, no_dial, diabetes, CAN_PREV_TX, 
         tx,immediate_post_trans, second_post_trans_int, 
         ischemic_time, i_time_low, i_time_high, i_time_unknown, tx_kdri, 
         t_1, t_2, dead, 
         raw_epts, EPTS,
         REC_TX_DT) %>%
  na.omit()

n_recips <- recips %>% nrow()

no_trans <- n_candidates - n_recips
dead_no_trans <- extended_to_model %>% 
  filter(tx ==0 & dead ==1) %>%
  nrow()

wait_end_fu <- n_candidates - n_recips - dead_no_trans

mean_fu <-extended_to_model %>%
  group_by(PX_ID) %>%
  arrange(t_2) %>%
  filter(row_number() == n()) %>%
  filter(t_2>0) %>%
  ungroup() %>%
  group_by(tx, dead) %>%
  summarise(mean_f_up = mean(t_2))

mean_fu_survivor_recip <- filter(mean_fu, tx ==1 & dead==0)$mean_f_up/365
```

```{r add_race_data}
cand_kipa <- haven::read_sas("data/cand_kipa.sas7bdat")

extended_to_model <- extended_to_model %>%
  left_join(cand_kipa %>% select(PX_ID, CAN_RACE)) %>%
  mutate(race = case_when(
    CAN_RACE == 16 ~ "Black",
    CAN_RACE == 2000 ~ "Hispanic/Latino",
    CAN_RACE == 8 ~ "White",
    CAN_RACE %in% c(64, 128) ~ "Asian/Pacific Islander",
    TRUE ~ "Other"
  ))

recips <- recips %>%
  left_join(cand_kipa %>% select(PX_ID, CAN_RACE)) %>%
  mutate(race = case_when(
    CAN_RACE == 16 ~ "Black",
    CAN_RACE == 2000 ~ "Hispanic/Latino",
    CAN_RACE == 8 ~ "White",
    CAN_RACE %in% c(64, 128) ~ "Asian/Pacific Islander",
    TRUE ~ "Other"
  ))
```

```{r demographics}
gender_counts <- candidates %>%
  left_join(cand_kipa %>% select(PX_ID, CAN_GENDER)) %>%
  ungroup() %>%
  count(CAN_GENDER)
```

There were `r n_adults_pre_center_filter %>% comma()` adult candidates listed for deceased donor kidney transplantation between January 1st, 2005 and December 31st, 2010. We excluded `r (n_adults_pre_center_filter - n_candidates)` candidates who were listed at a low volume center and `r comma(n_recips_minus_centers-n_recips)` for missing data. Out of the remaining `r comma(n_candidates)` candidates (mean age `r round(mean(candidates$age))` at listing, `r round(100*gender_counts[[2,2]]/nrow(candidates))`% male), `r n_recips %>% comma()` (`r comma(100*(n_recips)/(n_candidates))` %) had received a transplant by the end of followup (March 1st, 2021) (**Table 1**). Of the remaining `r comma(n_candidates - n_recips)` candidates who did not receive a transplant, `r comma(dead_no_trans)` (`r round(100*dead_no_trans/no_trans)`%) died by the end of followup. Mean follow-up for surviving transplant recipients was `r round(mean_fu_survivor_recip,1)` years.

```{r map_KDPI_recips, eval = FALSE}
plan(multisession, workers = no_cores)
recip_kdpi <- future_map_dbl(recips$tx_kdri, KDPI_mapper)
save(recip_kdpi, file = "recipient_kdpi_values.Rdata")
```

```{r load_recip_kpdi}
load("recipient_kdpi_values.Rdata")

recips <- recips %>%
  cbind(kdpi = recip_kdpi)
```

```{r median_recipient_details}
median_t_transplant <-  round(median(recips$t_1, na.rm = TRUE))
median_d_time <- round(median(recips$dialysis_time_years, na.rm = TRUE), digits =1)

median_dm <- median(recips$diabetes)
mean_dm <-  mean(recips$diabetes)

median_prev_transplant <- median(recips$CAN_PREV_TX, na.rm = TRUE)
mean_prev_transplant <- mean(recips$CAN_PREV_TX, na.rm = TRUE)

median_age <- round(median(recips$age, na.rm = TRUE))
median_ischemic_time <- mean(recips$ischemic_time, na.rm = TRUE)
median_kdpi <- median(recip_kdpi, na.rm = TRUE)
```

### Table 1A: Candidate characteristics at the time of listing

```{r candidate_table, results = 'asis'}
tbl_summary(extended_to_model %>% 
              filter(tx ==0) %>%
              left_join(cand_kipa %>% select(PX_ID, CAN_GENDER)) %>%
              mutate(Male = ifelse(CAN_GENDER == "M",1,0)) %>%
              mutate("Follow-up time (censored by transplant)" = t_2-t_1) %>% 
              select("Age" = age,
                     "Dialysis time (years)" = dialysis_time_years,
                     "Listed pre-dialysis" = no_dial,
                     "History of diabetes" = diabetes,
                     "History of previous organ transplant" = CAN_PREV_TX,
                     "EPTS % (2019)" = EPTS,
                     "Male gender" = Male,
                     "Race/ethnicity" = race
                     # "Follow-up time (censored by transplant)",
                     # "Observed pre-transplant deaths" = dead
                     )
) %>% as_gt()
```

### Table 1B: Recipient characteristics at the time of transplant

```{r recip_table, results = 'asis'}
tbl_summary(extended_to_model %>%
              filter(PX_ID %in% recips$PX_ID & tx ==1) %>%
              group_by(PX_ID) %>%
              filter(row_number() == n()) %>%
              ungroup() %>%
              left_join(recips %>% select(PX_ID, kdpi)) %>%
              mutate("Post-transplant follow-up time (years)" = (t_2 - t_1)/365,
                     "Time on wait-list pre-transplant (years)" = t_1/365)%>% 
              left_join(cand_kipa %>% select(PX_ID, CAN_GENDER)) %>%
              mutate(Male = ifelse(CAN_GENDER == "M",1,0)) %>%
              select("Age" = age,
                     #"Time on wait-list pre-transplant (years)",
                     "Dialysis time (years)" = dialysis_time_years,
                     "Preemptive transplant" = no_dial,
                     "History of diabetes" = diabetes,
                     "History of previous organ transplant" = CAN_PREV_TX,
                     "EPTS % (2019)" = EPTS,
                     #"Transplant date range" = REC_TX_DT,
                     "Waiting time pre-transplant (days)" = t_1,
                     "KDPI % (2019)" = kdpi,
                     "Ischemic time (hours)" = ischemic_time,
                     "Male Gender" = Male,
                     "Race/ethnicity" = race
                     #"Post-transplant follow-up time (years)",
                     #"Observed post-transplant deaths" = dead
            )) %>% as_gt()
```

## The survival benefit of deceased donor kidney transplantation

```{r identify_model}
i_time_cuts <- quantile(recips$ischemic_time, na.rm = TRUE, probs = c(0.25, 0.75))
full_me_model <- me_models[[1]]
full_base_hz <- hz_list[[4]]
```

```{r log_hazard_function}
sum_hazard <- function(param_list,start_hazard, covariate_values, model_coef){
        h_out <- start_hazard
        
        for (wp in param_list ) {

          params <- str_split(wp, ":")
          value <- prod(sapply(params[[1]], function(x) unname(covariate_values[x])))
          #print(value)
          beta <- unname(model_coef[wp])
          #print(beta)
          add_hz <- value*beta
          #print(add_hz)
          h_out <- h_out + add_hz
  
        }
        return(h_out)
}


log_hazard <- function(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, 
                            ischemic_time, kdpi,
                            period = "wait",
                            model= full_me_model,
                            icuts = i_time_cuts,
                            ...){
  
  no_dial <- ifelse(d_time == 0, 1,0)
  age_floor_25 <- ifelse(Age < 25, 0, Age - 25)
  log_dial_time <- log(d_time + 1)
  tx_kdri <- KDRI_raw(kdpi)

  i_time_low <- ifelse(ischemic_time <= icuts[[1]], 1, 0)
  i_time_high <- ifelse(ischemic_time > icuts[[2]], 1, 0)
  
  user_patient_params <- c(age_floor_25, log_dial_time, no_dial, diabetes, CAN_PREV_TX, 
                           i_time_low, i_time_high, tx_kdri)
  
  names(user_patient_params) <- c("age_floor_25", "log_dial_time", "no_dial", "diabetes", "CAN_PREV_TX",
                                  "i_time_low", "i_time_high", "tx_kdri")
  
  user_patient_params[["i_time_unknown"]] <- 0

  fixed_effects <- fixef(model)
  x_vars <- names(fixed_effects)
  ref <- data.frame(ranef(model)[[1]])
  ref$center <- row.names(ref)
  
  if (ctr_id == "mean center"){
    tx_ref <- 0
    int_ref <- 0
  } else {
      tx_ref <- filter(ref, center == ctr_id)$tx
      int_ref <- filter(ref, center == ctr_id)$Intercept
  }
  
  if (period == "wait"){
    entered_params <- c(user_patient_params, "tx" =0, "immediate_post_trans"=0, "second_post_trans_int" =0)
    entered_params[["tx_kdri"]] <- 0
    entered_params[["i_time_low"]] <- 0
    entered_params[["i_time_high"]] <- 0
    st_hazard <- int_ref
  }
  
  if (period == "post_1"){
      entered_params <- c(user_patient_params, "tx" =1, "immediate_post_trans"=1, "second_post_trans_int" =0)
      st_hazard <- int_ref + tx_ref
  }
  
  if (period == "post_2"){
      entered_params <- c(user_patient_params, "tx" =1, "immediate_post_trans"=0, "second_post_trans_int" =1)
      st_hazard <- int_ref + tx_ref
  }
  
    if (period == "post_3"){
      entered_params <- c(user_patient_params, "tx" =1, "immediate_post_trans"=0, "second_post_trans_int" =0)
      st_hazard <- int_ref + tx_ref
  }
  # print(x_vars)
  # print(st_hazard)
  # print(entered_params)
  # print(fixed_effects)
  h_out <- sum_hazard(x_vars, st_hazard, entered_params, fixed_effects)
  return(h_out)

}
```

```{r calculate_log_hr, eval = FALSE}
l_wait <- list(ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- recips$ischemic_time,
          kdpi <- recip_kdpi)

l_post_1 <- list(ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- recips$ischemic_time,
          kdpi <- recip_kdpi,
          period <- rep("post_1", length(recips$age)))


l_post_2 <- list(ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- recips$ischemic_time,
          kdpi <- recip_kdpi,
          period <- rep("post_2", length(recips$age)))

l_post_3 <- list(ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- recips$ischemic_time,
          kdpi <- recip_kdpi,
          period <- rep("post_3", length(recips$age)))


poss_log_hazard <- possibly(log_hazard, NA)
wait_log_hr <- pmap_dbl(l_wait, poss_log_hazard)
post_1_hr <- pmap_dbl(l_post_1, poss_log_hazard)
post_2_hr <- pmap_dbl(l_post_2, poss_log_hazard)
post_3_hr <- pmap_dbl(l_post_3, poss_log_hazard)


hr_0_30 <-  post_1_hr - wait_log_hr
hr_30_180 <- post_2_hr - wait_log_hr
hr_180_plus <- post_3_hr - wait_log_hr


hr_transplant <- tibble(PX_ID = recips$PX_ID, 
                        hr_0_30, hr_30_180, hr_180_plus)

write_csv(hr_transplant, "log_hr_transplant_recips.csv")
```

```{r summarize_hr_transplant}
hr_transplant <- read_csv("log_hr_transplant_recips.csv")
pct <- function(x, q) quantile(x, probs = q, na.rm = TRUE)[[1]]

hr_tx_sum <- hr_transplant %>%
  select(-PX_ID) %>%
  pivot_longer(everything()) %>%
  group_by(name) %>%
  summarise(mean =  mean(value, na.rm = TRUE),
            median =  median(value, na.rm = TRUE),
            pct_25 =  pct(value, 0.25),
            pct_75 = pct(value, 0.75),
            sd  = sd(value, na.rm = TRUE),
            obs = n())


 ## Table: Hazard ratio of transplantation by time after transplant
# hr_tx_sum %>%
#   select(name, median, pct_25, pct_75) %>%
#   mutate_if(is.numeric, exp) %>%
#   arrange(-median) %>%
#   mutate("Period post-transplant" = case_when(
#     name == "hr_0_30" ~"Day < 30",
#     name == "hr_30_180" ~"Day 30-180",
#     TRUE ~ "Day > 180"
#   ),
#   "IQR" = paste0("(",round(pct_25, 2), 
#                  " - ", round(pct_75, 2), ")")) %>%
#   select("Period post-transplant", "Median HR" = median, "IQR") %>%
#   kable(digits = 2)
```

Compared to not receiving a transplant, deceased donor kidney transplantation was associated with an increased risk of death during the first 30 days post-transplantation, median hazard ratio [HR] `r filter(hr_tx_sum, name == "hr_0_30")$median %>% exp() %>% round(2)` (IQR [`r filter(hr_tx_sum, name == "hr_0_30")$pct_25 %>% exp() %>% round(2)` - `r filter(hr_tx_sum, name == "hr_0_30")$pct_75 %>% exp() %>% round(2)`]). During day 30-180 post-transplantation, the risk of death was lower with a transplant than waiting, HR `r filter(hr_tx_sum, name == "hr_30_180")$median %>% exp() %>% round(2)` (IQR [`r filter(hr_tx_sum, name == "hr_30_180")$pct_25 %>% exp() %>% round(2)` - `r filter(hr_tx_sum, name == "hr_30_180")$pct_75 %>% exp() %>% round(2)`]). Beyond 180 days post-transplantation, the survival benefit of deceased donor kidney transplant continued to increase, HR `r filter(hr_tx_sum, name == "hr_180_plus")$median %>% exp() %>% round(2)` (IQR [`r filter(hr_tx_sum, name == "hr_180_plus")$pct_25 %>% exp() %>% round(2)` - `r filter(hr_tx_sum, name == "hr_180_plus")$pct_75 %>% exp() %>% round(2)`]) ( **Figure S2**). The full model results are in **Table S2** and the Harrell's c-statistic was 0.69.

```{r survival_benefit_function}
percent <- function(x, digits = 1, format = "f", ...) {      
  paste0(formatC(x * 100, format = format, digits = digits, ...), "%")
}

survival_benefit <-  function(t_transplant, 
                              ctr_id, 
                              Age, d_time, diabetes, CAN_PREV_TX, 
                              ischemic_time, kdpi,
                              output = "plot",  
                              me_model = full_me_model, 
                              isch_cuts = i_time_cuts,
                              b_hazard = full_base_hz,
                              post_tx_int_1 = 30,
                              post_tx_int_2 = 180){

  
  log_hr_w <- log_hazard(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                     model = me_model, icuts = isch_cuts, period = "wait")
  
  log_hr_post_1 <- log_hazard(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                     model = me_model, icuts = isch_cuts, period = "post_1") 
  
  log_hr_post_2 <- log_hazard(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                     model = me_model, icuts = isch_cuts, period = "post_2")              

  log_hr_post_3 <- log_hazard(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, ischemic_time, kdpi, 
                                     model = me_model, icuts = isch_cuts, period = "post_3")    
                              
  cum_hz <- filter(b_hazard, time == t_transplant)$hazard
  
  df <- b_hazard %>%
  mutate(hazard = hazard- lag(hazard),
                   hazard = ifelse(is.na(hazard), 0, hazard)) %>%
  filter(time >= t_transplant) %>%
  mutate(
    time = time - t_transplant,
    hazard_wait = hazard*exp(log_hr_w),
    hazard_tx = case_when(
      time < post_tx_int_1 ~ hazard*exp(log_hr_post_1),
      time < post_tx_int_2 ~ hazard*exp(log_hr_post_2),
      TRUE ~ hazard*exp(log_hr_post_3)
      ),
    H_tx = cumsum(hazard_tx),
    H_wait = cumsum(hazard_wait),
    S_tx = exp(-H_tx),
    S_wait = exp(-H_wait),
    S_tx_better = ifelse(S_tx >= S_wait, S_tx, NA),
    S_tx_worse = ifelse(S_tx <= S_wait, S_tx, NA),
    S_wait_better = ifelse(S_wait >= S_tx, S_wait, NA),
    S_wait_worse = ifelse(S_wait <= S_tx, S_wait, NA))
  
  if (output == "dataframe"){
    return(df)
  }
  
  if (is.numeric(output)){
    last_ob <- df %>%
      filter(time == output)
  
    if (nrow(last_ob) > 0){
      return(last_ob %>% 
               select(S_tx, S_wait) %>%
               mutate(benefit = S_tx - S_wait))
    } else {
      
      return(tibble(S_tx = NA, S_wait = NA, benefit = NA) %>%
               mutate_all(as.numeric))
    }
  }
  

  # if (output == "wait_5"){
  #       last_ob <- df %>%
  #     filter(time == 1825)
  #     
  #       if (nrow(last_ob) > 0){
  #           return(last_ob$S_wait)
  #         } else {
  #           return(NA)
  #         }
  # }
  
  plot <- df %>%
              filter(time < 365*5) %>%
              mutate(years_from_transplant = time/365,
                     tx_dot = ifelse(years_from_transplant==0, 1, NA),
                     benefit = S_tx - S_wait) %>%
              ggplot(aes(x = years_from_transplant)) +
              geom_ribbon(aes(ymin = S_wait_worse, ymax = S_tx_better, fill = "Survival Benefit"), alpha = 0.5) +
              geom_step(aes(y = S_tx, color = "Post-Transplant"), size = 1.1) +
              geom_step(aes(y = S_wait, color = "Waitlist"), size = 1.1) +
              geom_point(aes(y= tx_dot, shape= "Transplant"), size = 5, colour = "darkgreen") +
                scale_x_continuous(breaks = seq(0, 5)) + 
               ggthemes::theme_gdocs() +
                   labs(y = "Survival", x = "Time (years after transplant)", shape = "") +
                guides(shape = guide_legend(order = 1), color = guide_legend(order = 2), fill = guide_legend(order = 3))
  
  if (output == "plot"){
      return(plot +
               scale_color_manual(name = "Survival function", values=c("blue", "red")) +
               scale_fill_manual(name = NULL, values=c("skyblue")) +
               lims(y = c(0,1))
             )
  }
  
  if (output == "plot_w_benefit"){
      return(plot + 
               geom_step(aes(y = benefit, color = "Survival benefit"), size = 1.1) + 
               scale_color_manual(name = "Survival function", values=c("blue", "darkgreen", "red")) +
               scale_fill_manual(name = NULL, values=c("darkgreen")) 
             )
  }

  if (output == "rmst"){
    rmst_df <-df %>%
        mutate(days = (S_tx - S_wait)*(time-lag(time)),
               days = ifelse(row_number() == 1, 0, days),
         rmst = cumsum(days))
      return(
         paste0("DDKT would improve survival by ", round(filter(rmst_df, time == 5*365)$rmst/365, digits = 1), " years on average within the first 5 years following transplant")
        )
    }
  if (output == "table"){
        benefit_df <- df %>%
      filter(time %in% c( 365, 3*365, 5*365))


    return(
      benefit_df %>%
      mutate(S_tx = S_tx,
             S_wait = S_wait,
             surv_benefit = S_tx - S_wait,
             years_from_transplant = time/365,
             LiST = round(surv_benefit,2)) %>%
      select("Years from transplant" = years_from_transplant,
             "Survival (transplant)" = S_tx,
             "Survival (waitlist)" = S_wait,
             "Absolute Survival Benefit" = surv_benefit,
             "LiST" = LiST) %>%
          mutate(across(c(2,3,4), percent)) %>%
        kable()
      )

  }
  
    if (output == "list_5"){
      list_5 <- df %>%
        mutate(benefit = S_tx - S_wait) %>%
        filter(time == 5*365)
      
      return(
          round(list_5$benefit, digits = 2)
        )
    }

}
```

```{r calculate_5yr_survival_benefits, eval = FALSE}
l <- list(trans_time <- recips$t_1,
          ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- recips$ischemic_time,
          kdpi <- recip_kdpi,
          output <- rep(1825, length(recips$t_1)))

possibly_sb <- possibly(survival_benefit, 
                        otherwise = tibble(S_tx = NA, S_wait = NA, benefit = NA) %>%
                          mutate_all(as.numeric))

recip_5yr <- pmap_dfr(l, possibly_sb)
write_csv(recip_5yr, file = "five_year_outcomes_derivaion_cohort.csv")

# cur_recips <- read_csv("adult_ddkt_recips_2019.csv")
# 
# cur_recip_kdpi <- map_dbl(cur_recips$tx_kdri, KDPI_mapper)
# 
# 
# l_cur <- list(trans_time <- cur_recips$t_1,
#           ctr <- cur_recips$center,
#           Age <- cur_recips$age,
#           d_time <- cur_recips$dialysis_time_years,
#           diabetes <- cur_recips$diabetes,
#           CAN_PREV_TX <- cur_recips$CAN_PREV_TX,
#           ischemic_time <- cur_recips$REC_COLD_ISCH_TM,
#           kdpi <- cur_recip_kdpi,
#           output <- rep(1825, length(cur_recips$t_1)))
# 
# 
# cur_recip_5yr <- pmap_dfr(l_cur, possibly_sb)
# 
# cur_recip_5yr
# 
# write_csv(cur_recip_5yr, file = "five_year_outcomes_2019.csv")
```

```{r load_5yr_benefits}
recip_5yr <- read_csv(file = "five_year_outcomes_derivaion_cohort.csv")

#cur_recip_5yr <- read_csv("five_year_outcomes_2019.csv")
```

```{r recip_df_for_plots}
to_plot <- recips %>%
  cbind(recip_5yr) %>%
  mutate(waitlist_risk = cut(100*(1-S_wait), breaks = seq(0, 100, 1), labels = FALSE),
         age_floor_25 = ifelse(age <25, 0, age-25),
         log_dial_time = log(dialysis_time_years + 1),
         no_dial = ifelse(dialysis_time_years == 0, 1, 0),
         raw_epts = 0.047*age_floor_25 - 0.015*diabetes*age_floor_25+
           0.398*CAN_PREV_TX- 0.237*diabetes*CAN_PREV_TX+
           0.315*log(dialysis_time_years + 1)- 0.099*diabetes*log(dialysis_time_years + 1) +
           0.130*no_dial - 0.348*no_dial +  
           1.262*diabetes)
```

```{r summary_stats_benefit}
mean_wait <- round(100*summary(to_plot$S_wait)["Mean"][[1]], 1)

mean_post <- round(100*summary(to_plot$S_tx)["Mean"][[1]],1)

mean_benefit <- round(100*summary(to_plot$benefit)["Mean"][[1]],1)

wait_IQR <- paste0(round(100*summary(to_plot$S_wait)[[2]]), "% ,", round(100*summary(to_plot$S_wait)[[5]]), "%")

post_IQR <- paste0(round(100*summary(to_plot$S_tx)[[2]]), "% ,", round(100*summary(to_plot$S_tx)[[5]]), "%")

benefit_IQR <- paste0(round(100*summary(to_plot$benefit)[[2]]),"%, ", round(100*summary(to_plot$benefit)[[5]]), "%")
```

The large long-term risk reduction associated with deceased donor kidney transplantation led to a large absolute survival benefit by five years. For the N = `r comma(n_recips)` in the study cohort, transplantation was associated with an improvement in estimated five-year survival from `r mean_wait`% to `r mean_post`%, an absolute benefit of `r mean_benefit`%. This benefit corresponds to one life saved within five years for every `r round(1/summary(to_plot$benefit)["Mean"][[1]], 2)` transplants.

### The association of survival benefit with medical urgency and Estimated Post-Transplant Survival (EPTS)

```{r lower_upper_IQR_benefit}
lower_IQR_recip <- to_plot %>%
  mutate(find_25 = abs(benefit - quantile(to_plot$benefit, na.rm = TRUE, probs = 0.25)[[1]])) %>%
  arrange(find_25) %>%
  filter(row_number()  ==1)

upper_IQR_recip <- to_plot %>%
  mutate(find_75 = abs(benefit - quantile(to_plot$benefit, na.rm = TRUE, probs = 0.75)[[1]])) %>%
  arrange(find_75) %>%
  filter(row_number()  ==1)

#max_benefit <- max(to_plot$benefit, na.rm = TRUE)

#max_waitlist_risk <- round(100*(1-filter(to_plot, benefit == max_benefit)$S_wait))

#The IQR of five-year survival without a transplant was (`r wait_IQR`) and the IQR of post-transplant survival was (`r post_IQR`). 
```

There was wide variation in the survival benefit of transplantation (IQR `r benefit_IQR`), driven by significant variation in risk of death with and without transplantation by candidate characteristics (**Table S2**). The IQR of five-year survival without a transplant was (`r wait_IQR`) and the IQR of post-transplant survival was (`r post_IQR`). The 25th percentile recipient by survival benefit had an estimated five-year survival without transplantation of `r round(100*lower_IQR_recip$S_wait)`% which improved to `r round(100*lower_IQR_recip$S_tx)`% with transplantation, an absolute survival benefit of `r round(100*lower_IQR_recip$benefit)`%. The 75th percentile recipient had a lower absolute estimated five-year survival without transplantation `r round(100*upper_IQR_recip$S_wait)`% and with transplantation `r round(100*upper_IQR_recip$S_tx)`%, however a much larger benefit from transplantation `r round(100*upper_IQR_recip$benefit)`% (**Figure 1**)

```{r}
max_benefit <- to_plot %>%
  group_by(waitlist_risk) %>%
  summarise(mean_benefit= mean(benefit, na.rm = TRUE)) %>%
  arrange(-mean_benefit) %>%
  filter(row_number() ==1)
```

Overall, there was a strong positive correlation between the risk of death without a transplant (medical urgency) and survival benefit ($\rho=$ `r round(cor(to_plot$benefit, -to_plot$S_wait, use = "complete.obs"), 2)`) (**Figure 2**). The maximum benefit from deceased donor kidney transplantation was a `r round(max_benefit$mean_benefit)` LiST-5 when five-year mortality without a transplant was `r max_benefit$waitlist_risk`%, corresponding to ten lives saved with every `r 10*round(1/max_benefit$mean_benefit,1)` transplants (within the first five years).


```{r donor_adjusted_benefits, eval=FALSE}
# set ischemic time and KDPI to the median, keep other candidate characteristics the same
l_donor_adjust <- list(trans_time <- recips$t_1,
          ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- rep(median_ischemic_time, length(recips$t_1)),
          kdpi <- rep(median_kdpi, length(recips$t_1)),
          output <- rep(1825, length(recips$t_1)))

possibly_sb <- possibly(survival_benefit, 
                        otherwise = tibble(S_tx = NA, S_wait = NA, benefit = NA) %>%
                          mutate_all(as.numeric))

plan(multisession, workers = no_cores)
recip_5yr_donor_adjust <- future_pmap_dfr(l_donor_adjust, possibly_sb)
write_csv(recip_5yr_donor_adjust, file = "five_year_outcomes_derivaion_cohort_donor_adjusted.csv")


l_kdpi_15 <- list(trans_time <- recips$t_1,
          ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- rep(median_ischemic_time, length(recips$t_1)),
          kdpi <- rep(15, length(recips$t_1)),
          output <- rep(1825, length(recips$t_1)))

recip_5yr_kdpi_15 <- pmap_dfr(l_kdpi_15, possibly_sb)

write_csv(recip_5yr_kdpi_15, file = "five_year_outcomes_derivaion_cohort_kdpi_15.csv")

l_kdpi_60 <- list(trans_time <- recips$t_1,
          ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- rep(median_ischemic_time, length(recips$t_1)),
          kdpi <- rep(60, length(recips$t_1)),
          output <- rep(1825, length(recips$t_1)))

recip_5yr_kdpi_60 <- pmap_dfr(l_kdpi_60, possibly_sb)

write_csv(recip_5yr_kdpi_60, file = "five_year_outcomes_derivaion_cohort_kdpi_60.csv")


l_kdpi_85 <- list(trans_time <- recips$t_1,
          ctr <- recips$center,
          Age <- recips$age,
          d_time <- recips$dialysis_time_years,
          diabetes <- recips$diabetes,
          CAN_PREV_TX <- recips$CAN_PREV_TX,
          ischemic_time <- rep(median_ischemic_time, length(recips$t_1)),
          kdpi <- rep(85, length(recips$t_1)),
          output <- rep(1825, length(recips$t_1)))

recip_5yr_kdpi_85 <- pmap_dfr(l_kdpi_85, possibly_sb)

write_csv(recip_5yr_kdpi_85, file = "five_year_outcomes_derivaion_cohort_kdpi_85.csv")
```

```{r load_in_kdpi_adjust}
recip_5yr_donor_adjust <- read_csv("five_year_outcomes_derivaion_cohort_donor_adjusted.csv")
recip_5yr_kdpi_15 <- read_csv("five_year_outcomes_derivaion_cohort_kdpi_15.csv")
recip_5yr_kdpi_60 <- read_csv("five_year_outcomes_derivaion_cohort_kdpi_60.csv")
recip_5yr_kdpi_85 <- read_csv("five_year_outcomes_derivaion_cohort_kdpi_85.csv")
```

```{r epts_benefit_table}
EPTS_benefit_table <- to_plot %>%
  select(EPTS, benefit) %>%
  cbind(recip_5yr_kdpi_15 %>% select(benefit_15 = benefit)) %>%
  cbind(recip_5yr_kdpi_60 %>% select(benefit_60 = benefit)) %>%
  mutate(epts_quintile = cut(EPTS, breaks = seq(0, 100, 20)))%>%
  #select("Survival Benefit" = 100*benefit) %>%
  group_by(epts_quintile) %>%
  na.omit() %>%
  summarise(kdpi_15 = mean(benefit_15, na.rm = TRUE),
            kdpi_60 = mean(benefit_60, na.rm = TRUE),
            total= n(),
            var_15 = var(benefit_15, na.rm = TRUE),
            var_60 = var(benefit_60, na.rm = TRUE),
            cov = cov(benefit_15, benefit_60)) %>%
  mutate(difference = kdpi_15- kdpi_60,
         var_diff = var_15 + var_60 + 2*cov,
         se_diff = sqrt(var_diff/(total-1)),
         low_ci_diff = difference - 1.96*se_diff,
         up_ci_diff = difference + 1.96*se_diff
         ) %>%
  select(
    "EPTS" = epts_quintile,
    "KDPI 15 (%)" = kdpi_15,
    "KDPI 60 (%)"= kdpi_60,
    "Improvement with lower KDPI kidney" = difference,
    low_ci_diff,
    up_ci_diff
  ) %>%
  mutate_if(is.numeric, function(x) round(100*x, 1)) %>%
  mutate("95% CI" = paste0("(", low_ci_diff, ",", up_ci_diff, ")")) %>%
  select(-low_ci_diff, -up_ci_diff) 


```

There was a strong correlation between EPTS score (2019 percentile) and survival benefit (`r round(cor(to_plot$EPTS, to_plot$benefit, use = "complete.obs"), 2)`), meaning that recipients with low EPTS % had *lower* survival benefit (**Table 2**, **Figure 3**). There was a strong correlation between EPTS scores and five-year mortality without transplantation `r round(cor(to_plot$EPTS, -to_plot$S_wait, use = "complete.obs"), 2)`, meaning recipients with lower EPTS % tended to be less medically urgent.

### Table 2: Survival benefit by EPTS quintile and KDPI
```{r benefit_by_EPTS_table}
EPTS_benefit_table %>%
  kable(digits = 1, 
        booktabs = T) %>%
  kableExtra::kable_styling(latex_options = c("hold_position"))
```

\pagebreak

### Figure 1: Survival benefit of deceased donor kidney transplantation for the 25th and 75th percentile recipient

```{r figure_1}
low_plot <- survival_benefit(lower_IQR_recip$t_1, lower_IQR_recip$center, lower_IQR_recip$age, lower_IQR_recip$dialysis_time_years, lower_IQR_recip$diabetes, lower_IQR_recip$CAN_PREV_TX,
                 lower_IQR_recip$ischemic_time,
                 lower_IQR_recip$kdpi)

up_plot <- survival_benefit(upper_IQR_recip$t_1, upper_IQR_recip$center, upper_IQR_recip$age, upper_IQR_recip$dialysis_time_years, upper_IQR_recip$diabetes, upper_IQR_recip$CAN_PREV_TX,
                 upper_IQR_recip$ischemic_time,
                 upper_IQR_recip$kdpi)

g_legend<-function(a.gplot){
tmp <- ggplot_gtable(ggplot_build(a.gplot))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]
return(legend)}

surv_beneift_legend <- g_legend(up_plot + theme(legend.position = "bottom", legend.title = element_blank()))

grid.arrange(arrangeGrob(low_plot + 
                           theme(legend.position="none",
                                 title = element_text(size = 8)) +
                           labs(title =expression(paste(25^th," percentile"))),
                         up_plot +  
                           theme(legend.position="none",
                                 title = element_text(size = 8)) + 
                           labs(title = expression(paste(75^th," percentile"))),
                         nrow=1),
             surv_beneift_legend,
             nrow=2,heights=c(10, 2.5))
```

Survival benefit of deceased donor kidney transplantation for the 25th and 75th percentile recipient. The 25th percentile recipient had an estimated five-year survival without transplantation of `r round(100*lower_IQR_recip$S_wait)`%, which improved to `r round(100*lower_IQR_recip$S_tx)`% with transplantation, an absolute survival benefit of `r round(100*lower_IQR_recip$benefit)`. The 75th percentile recipient had a lower absolute estimated five-year survival without transplantation `r round(100*upper_IQR_recip$S_wait)`% and with transplantation `r round(100*upper_IQR_recip$S_tx)`%, however a much larger benefit from transplantation `r round(100*upper_IQR_recip$benefit)`%.
\pagebreak







### KDPI and EPTS interaction
```{r dialysis_time}
preemeptive <- to_plot %>%
  filter(no_dial ==1) %>%
  group_by(diabetes) %>%
  summarise(mean = mean(benefit, na.rm = TRUE),
            n = n()) %>%
  mutate(sd = sqrt(mean*(1-mean)),
         low_ci = mean - 1.96*sd/(sqrt(n-1)),
         up_ci = mean + 1.96*sd/(sqrt(n-1)))

no_dm_pre <- round(100*preemeptive["mean"][[1]][1],1)
no_dm_pre_low <- round(100*preemeptive["low_ci"][[1]][1],1)
no_dm_pre_up <- round(100*preemeptive["up_ci"][[1]][1],1)


dm_pre <- round(100*preemeptive["mean"][[1]][2],1)
dm_pre_low <- round(100*preemeptive["low_ci"][[1]][2],1)
dm_pre_up <- round(100*preemeptive["up_ci"][[1]][2],1)

long_dialysis <- to_plot %>%
  filter(dialysis_time_years>=5) %>%
  group_by(diabetes) %>%
  summarise(mean = mean(benefit, na.rm = TRUE),
            n = n()) %>%
  mutate(sd = sqrt(mean*(1-mean)),
         low_ci = mean - 1.96*sd/(sqrt(n-1)),
         up_ci = mean + 1.96*sd/(sqrt(n-1)))



no_dm_long <- round(100*long_dialysis["mean"][[1]][1],1)
no_dm_long_low <- round(100*long_dialysis["low_ci"][[1]][1],1)
no_dm_long_up <- round(100*long_dialysis["up_ci"][[1]][1],1)


dm_long <- round(100*long_dialysis["mean"][[1]][2],1)
dm_long_low <- round(100*long_dialysis["low_ci"][[1]][2],1)
dm_long_up <- round(100*long_dialysis["up_ci"][[1]][2],1)
```

There was a significant interaction between EPTS and KDPI. Top 20% EPTS recipients (currently receive priority for Top 20% kidneys) gain a `r as.numeric(EPTS_benefit_table[1,2])`% improvement in five-year survival with a KDPI 15% kidney compared to a `r as.numeric(EPTS_benefit_table[1,3])`% improvement with a KDPI 60% kidney. In contrast, a recipients in the highest risk quartile (EPTS 80-100%) gain `r as.numeric(EPTS_benefit_table[5,2])`% in five-year survival with a KDPI 15% kidney compared to `r as.numeric(EPTS_benefit_table[5,3])`% with a KDPI 60%, a significantly greater benefit from the higher quality graft (p\< 0.01).



### The association of dialysis time and diabetes with survival benefit
```{r average_benefit_covariates}
linear_model <- lm(benefit ~ age + dialysis_time_years + no_dial + diabetes + CAN_PREV_TX + kdpi + ischemic_time, to_plot)

year_age_effect <- as.numeric(round(100*linear_model$coefficients["age"], 1))
diabetes_effect <- as.numeric(round(100*linear_model$coefficients["diabetes"], 1))

hx_prev_effect <-as.numeric(round(100*linear_model$coefficients["CAN_PREV_TX"], 1))
dial_year_effect <- as.numeric(round(100*linear_model$coefficients["dialysis_time_years"], 1))

preemptive_effect <- as.numeric(round(100*linear_model$coefficients["no_dial"], 1))

kdpi_effect <- as.numeric(round(100*linear_model$coefficients["kdpi"], 1))
```

All candidate covariates that generate higher EPTS scores (age, history of diabetes, dialysis time, and previous transplant) were associated with greater medical urgency and had strong, independent associations with survival benefit (**Table S2**). On average, each year of recipient age increased five-year survival benefit by `r year_age_effect`%, a history of previous solid organ transplant by `r hx_prev_effect`%, and a history of diabetes by `r diabetes_effect`%. Each additional year on dialysis increased five-year survival benefit by `r dial_year_effect`%. Preemptive transplants were associated with `r preemptive_effect`% less survival benefit at five years. 

The average five-year survival benefit for a preemptive transplantation in a patient without diabetes was `r no_dm_pre` (95% CI `r no_dm_pre_low`%, `r no_dm_pre_up`%). Preemptive transplantation in patients with diabetes was associated with a five-year survival benefit of `r dm_pre` (95% CI `r dm_pre_low`%, `r dm_pre_up`%) (**Figure 4**).

In contrast, the average survival benefit for recipients without diabetes with more than five years of dialysis was `r no_dm_long`% (95% CI`r no_dm_long_low`%, `r no_dm_long_up`%). For recipients with diabetes and more than five years of dialysis time at transplant, the average survival benefit was `r dm_long`% (95% CI`r dm_long_low`%, `r dm_long_up`%).


### Donor KDPI and survival benefit
```{r kdpi_85_benefit}
recips_over_time <- read_csv("DDKT_adult_recipients_2010-2020.csv")


kdpi_85_benefit <- to_plot %>%
  filter(kdpi>=85) %>%
    summarise(mean = mean(benefit, na.rm = TRUE),
            n = n()) %>%
  mutate(sd = sqrt(mean*(1-mean)),
         low_ci = mean - 1.96*sd/(sqrt(n-1)),
         up_ci = mean + 1.96*sd/(sqrt(n-1)))


kdpi_85_mean <- round(100*kdpi_85_benefit["mean"][[1]][1],1)
kdpi_85_low <- round(100*kdpi_85_benefit["low_ci"][[1]][1],1)
kdpi_85_up <- round(100*kdpi_85_benefit["up_ci"][[1]][1],1)



recip_2019 <- recips_over_time %>%
  filter(year(REC_TX_DT) == 2019) 

kdpi_2019 <- map_dbl(recip_2019$tx_kdri, KDPI_mapper)

kdpi_over_85_2019 <- recip_2019 %>%
  cbind(kdpi_2019) %>%
  filter(kdpi_2019 >= 85) %>%
  nrow()

lives_lost_no_85 <- round(0.01*kdpi_85_mean*kdpi_over_85_2019)
```


There was a small but statistically significant interaction between donor KDPI and survival benefit. For every 1% increase in KDPI, the five-year survival benefit decreased by `r kdpi_effect`%. The average five-year survival benefit of a KDPI  $\geq 85\%$ donor kidney was  `r kdpi_85_mean`% (95% CI `r kdpi_85_low`%, `r kdpi_85_up`%), corresponding to one life saved for every four transplants on average. In 2019, there were `r comma(kdpi_over_85_2019)` transplants performed with  KDPI  $\geq 85\%$ donor kidneys.  If these transplants were not performed, an estimated `r lives_lost_no_85` people would die within five years.




\pagebreak

```{r fig_2, eval = FALSE}
### Figure 2: Survival benefit of deceased donor kidney transplantation by the risk of death without a transplant
to_plot %>%
  mutate(S_wait = cut(100*(S_wait), breaks = seq(0, 100, 1), labels = FALSE)) %>%
  group_by(S_wait) %>%
  summarise(benefit = mean(benefit, na.rm = TRUE),
            S_tx = mean(S_tx, na.rm = TRUE)) %>%
  mutate(waitlist_risk = 100-S_wait) %>%
  ggplot(aes(x = waitlist_risk, ymin= S_wait, ymax = 100*S_tx)) + 
  #geom_linerange() + 
  geom_segment(aes(xend = waitlist_risk, y = S_wait,  
                   #color = 100*benefit,
                   yend = 100*S_tx,
                   linetype = "Survival benefit")) + 
  geom_point(aes(y = S_wait, shape = "Without transplantation", color = "Without transplantation"), ) + 
  geom_point(aes(y = 100*S_tx, shape = "Transplantation", color ="Transplantation")) +
  labs(y = "Survival (%)", x = "Risk of death within five years without a transplant (%)", shape = "", color = "", linetype = "") +
  scale_shape_manual(values = c(17,16)) +
  scale_color_manual(values = c("darkgreen", "red")) + 
  ggthemes::theme_gdocs()
```

### Figure 2: Survival benefit of deceased donor kidney transplantation by risk of death without a transplant

```{r fig_2_alt}
to_plot %>%
  group_by(waitlist_risk) %>%
  summarise(mean_benefit = mean(benefit, na.rm = TRUE),
            median_benefit = median(benefit, na.rm = TRUE),
            pct_25 = pct(benefit, 0.25),
            pct_75 = pct(benefit, 0.75),
            total_tx = n(),
            sd_benefit = sd(benefit, na.rm = TRUE)) %>%
  mutate( sd_benefit = sqrt(mean_benefit*(1-mean_benefit))) %>%
  filter(total_tx > 100) %>%
  mutate(lower_ci = mean_benefit- 1.96*sd_benefit/sqrt(total_tx-1),
         lower_ci = ifelse(lower_ci < 0, 0, lower_ci),
         upper_ci = mean_benefit + 1.96*sd_benefit/sqrt(total_tx-1)) %>%
  #mutate(diabetes = ifelse(diabetes == 1, "Diabetes", "No Diabetes")) %>%
  ggplot(aes(x = waitlist_risk, y = 100*mean_benefit, ymin = 100*lower_ci, ymax = 100*upper_ci)) +
    # ggplot(aes(x = waitlist_risk, y = 100*median_benefit, ymin = 100*pct_25, ymax = 100*pct_75)) +
  geom_point() + geom_errorbar() +
  ggthemes::theme_gdocs() + labs(x = "Five-year mortality risk without transplant", y = "Five-year survival benefit")  + lims(y = c(0, 60))
```

Survival benefit of deceased donor kidney transplantation by the risk of death without a transplant. There is a roughly linear relationship between medical urgency and survival benefit until the most urgent candidates (five-year mortality risk without a transplantation \> 75%). Only for the most highly urgent candidates (mortality without transplant \> 95%) does the survival benefit of transplantation begins to decline.
\pagebreak


```{r fig_2_list}
to_plot %>%
  group_by(waitlist_risk) %>%
  summarise(mean_benefit = mean(benefit, na.rm = TRUE),
            median_benefit = median(benefit, na.rm = TRUE),
            pct_25 = pct(benefit, 0.25),
            pct_75 = pct(benefit, 0.75),
            total_tx = n(),
            sd_benefit = sd(benefit, na.rm = TRUE)) %>%
  mutate( sd_benefit = sqrt(mean_benefit*(1-mean_benefit))) %>%
  filter(total_tx > 100) %>%
  mutate(lower_ci = mean_benefit- 1.96*sd_benefit/sqrt(total_tx-1),
         lower_ci = ifelse(lower_ci < 0, 0, lower_ci),
         upper_ci = mean_benefit + 1.96*sd_benefit/sqrt(total_tx-1)) %>%
  #mutate(diabetes = ifelse(diabetes == 1, "Diabetes", "No Diabetes")) %>%
  ggplot(aes(x = waitlist_risk, 
             y = mean_benefit, 
             ymin = lower_ci, ymax = upper_ci)) +
  geom_point() + geom_errorbar() +
  ggthemes::theme_gdocs() + labs(x = "Five-year mortality risk without transplant (%)", y = "LiST-5")  + lims(y = c(0, 0.6))

ggsave("LiST_waitlist.pdf")
```

### Figure 3: Survival benefit of deceased donor kidney transplantation by Estimated Post-Transplant Survival (EPTS) percentile

```{r epts_plot}
to_plot %>%
  group_by(EPTS) %>%
  summarise(mean_benefit = mean(benefit, na.rm = TRUE),
            #sd_benefit = sd(benefit, na.rm = TRUE),
            total_tx = n()) %>%
  filter(total_tx > 1) %>%
  mutate(sd_benefit = sqrt(mean_benefit*(1-mean_benefit)),
         lower_ci = mean_benefit- 1.96*sd_benefit/sqrt(total_tx-1),
         upper_ci = mean_benefit + 1.96*sd_benefit/sqrt(total_tx-1),
         top_20 = ifelse(EPTS < 21, "Top 20%", ">20%")) %>%
  #mutate(diabetes = ifelse(diabetes == 1, "Diabetes", "No Diabetes")) %>%
  ggplot(aes(x = EPTS, y = 100*mean_benefit, ymin = 100*lower_ci, ymax = 100*upper_ci, color = top_20)) +
  geom_point() + geom_errorbar() +
  ggthemes::theme_gdocs() +
  labs(x = "EPTS % (2019)", y = "Survival Benefit (5-year)", color = "EPTS group")

ggsave("ddkt_sb_by_EPTS.pdf")
```

Survival benefit of deceased donor kidney transplantation by Estimated Post-Transplant Survival (EPTS) percentile (2019 OPTN mapping table). The candidates in the top 20% EPTS (highest expected post-transplant survival) have significantly lower benefit from transplantation when compared to candidates with EPTS \> 20%.
```{r}
wait_by_dtime <- to_plot %>%
  filter(dialysis_time_years >0 & dialysis_time_years< 5.5) %>%
  mutate(d_time_years = case_when(
    dialysis_time_years == 0 ~ 0,
    TRUE ~ round(dialysis_time_years))) %>%
    group_by(d_time_years) %>%
      summarise(median_wait = median(t_1, na.rm = TRUE)) %>%
  filter(d_time_years != 0)

wait_by_dtime
```

```{r dialysis_time_calc}
dtime_list <- seq(0, 5, 1)

median_wait_preemptive <- filter(to_plot, dialysis_time_years ==0)$t_1%>% median(na.rm = TRUE)

med_dialysis_time_no_premept <- filter(to_plot, dialysis_time_years >0)$dialysis_time_years %>% median(na.rm = TRUE)

median_wait_dialysis <- filter(to_plot, dialysis_time_years >0)$t_1%>% median(na.rm = TRUE)

median_wait_preemptive <- filter(to_plot, dialysis_time_years ==0)$t_1%>% median(na.rm = TRUE)



wait_by_dtime <- tibble(dtime_list) %>%
  mutate(median_wait = median_wait_preemptive + 365*dtime_list)

l_dtime <- list(trans_time <- rep(wait_by_dtime$median_wait, 2),
          ctr <- rep("mean center",2*length(dtime_list)),
          Age <- rep(median_age, 2*length(dtime_list)),
          d_time <- rep(dtime_list, 2),
          diabetes <- c(rep(0, length(dtime_list)), rep(1, length(dtime_list))),
          CAN_PREV_TX <- rep(0, 2*length(dtime_list)),
          ischemic_time <-  rep(median_ischemic_time, 2*length(dtime_list)),
          kdpi <-  rep(median_kdpi, 2*length(dtime_list)),
          output <- rep(1825, 2*length(dtime_list)))

possibly_sb <- possibly(survival_benefit, 
                        otherwise = tibble(S_tx = NA, S_wait = NA, benefit = NA) %>%
                          mutate_all(as.numeric))

survival_benefit_dialysis_time <- pmap_dfr(l_dtime, possibly_sb) %>%
  cbind(dialysis_time = rep(dtime_list, 2),
        diabetes =c(rep(0, length(dtime_list)), rep(1, length(dtime_list))))

survival_benefit_dialysis_time
```

\pagebreak 
### Figure 4: Survival benefit by time on dialysis and history of diabetes
```{r benefit_dialysis_time_plot}
survival_benefit_dialysis_time %>%
  mutate(diabetes = ifelse(diabetes ==1, "Diabetes", "No Diabetes")) %>%
  ggplot(aes(x = dialysis_time,
             y = 100*benefit, fill = diabetes))+
  facet_wrap(~diabetes) + 
  geom_bar(stat = "Identity", position = "dodge" ) +
  scale_x_continuous(breaks = seq(0,5, 1)) + 
  labs(x = "Dialysis time (years)", fill = "", y = "Five-year survival benefit")+
  ggthemes::theme_gdocs()

ggsave("dialysis_time_benefit.pdf")

```
Five-year survival benefit of deceased donor kidney transplantation by dialysis time and history of diabetes for the median age recipient (`r median_age` years old) transplanted with a `r median_kdpi`% donor kidney with `r round(median_ischemic_time)` hours of ischemic time. Waiting time for preemptive transplants was `r median_wait_preemptive` compared to `r median_wait_dialysis`.


### Figure 4 (alt): Survival benefit by time on dialysis and history of diabetes
```{r benefit_dialysis_time_plot_list}
survival_benefit_dialysis_time %>%
  mutate(diabetes = ifelse(diabetes ==1, "Diabetes", "No Diabetes")) %>%
  ggplot(aes(x = dialysis_time,
             y = benefit, fill = diabetes))+
  facet_wrap(~diabetes) + 
  geom_bar(stat = "Identity", position = "dodge" ) +
  scale_x_continuous(breaks = seq(0,5, 1)) + 
  labs(x = "Dialysis time (years)", fill = "", y = "LiST-5")+
  ggthemes::theme_gdocs()

ggsave("dialysis_time_LiST.pdf")
```


```{r survival_benefit_by_kdpi, eval = FALSE}
### Figure 5: Average Survival Benefit of Deceased Donor Kidney Transplanation by Donor KDPI
# Average survival benefit by KDPI % (2019) for adult recipients initially listed from 2005-2010.
to_plot %>%
  group_by(kdpi) %>%
  summarise(mean = mean(benefit, na.rm = TRUE),
            n = n()) %>%
    mutate(sd = sqrt(mean*(1-mean)),
         low_ci = mean - 1.96*sd/(sqrt(n-1)),
         up_ci = mean + 1.96*sd/(sqrt(n-1))) %>%
  ggplot(aes(x = kdpi, y = 100*mean, ymin = 100*low_ci, ymax = 100*up_ci)) +
  geom_point() + geom_errorbar() +
  ggthemes::theme_gdocs() +
  labs(x = "KDPI % (2019)", y = "Survival Benefit (5-year)")
```


### Figure X: Lives Saved with Transplant (LiST) with a preemptive transplant compared to the median recipient on dialysis

```{r}

dial_dm_plot <- survival_benefit(median_wait_dialysis, "mean center", median_age, med_dialysis_time_no_premept, 1, 0,
                 median_ischemic_time,
                 median_kdpi)

dial_no_dm_plot <- survival_benefit(median_wait_dialysis, "mean center", median_age, med_dialysis_time_no_premept, 0, 0,
                 median_ischemic_time,
                 median_kdpi)


prempt_plot <- survival_benefit(median_wait_preemptive, "mean center", median_age, 0, 0, 0,
                 median_ischemic_time,
                 median_kdpi)

prememptive_vs_plot <- grid.arrange(arrangeGrob(prempt_plot + 
                           theme(legend.position="none",
                                 title = element_text(size = 8)) +
                           labs(title = "Preemptive"),
                         dial_no_dm_plot  +  
                           theme(legend.position="none",
                                 title = element_text(size = 8)) + 
                           labs(title = "On dialysis"),
                         nrow=1),
             surv_beneift_legend,
             nrow=2,heights=c(10, 3))


ggsave("dial_no_dm_vs_preemptive.pdf", plot = prememptive_vs_plot)
```


```{r}
survival_benefit(median_wait_dialysis, "mean center", median_age, med_dialysis_time_no_premept, 0, 0,
                 median_ischemic_time,
                 median_kdpi,
                 output = "table")
```

```{r}
survival_benefit(median_wait_preemptive, "mean center", median_age, 0, 0, 0,
                 median_ischemic_time,
                 median_kdpi, output = "table")
```


```{r}
# high_risk <- to_plot %>%
#   mutate(high_risk = ifelse(S_wait <= summary(to_plot$S_wait)["3rd Qu."], 1, 0)) %>%
#   filter(high_risk ==1) %>%
#   arrange(S_wait)
# 
# med_s_wait_high <- median(high_risk$S_wait, na.rm = TRUE)
# 
# median_high_risk_tx <- high_risk %>%
#   filter(S_wait == med_s_wait_high)
# 
# median_high_risk_tx
# 
# high_urgency_plot <- survival_benefit(median_high_risk_tx$t_1, median_high_risk_tx$center, 
#                  median_high_risk_tx$age, median_high_risk_tx$dialysis_time_years,
#                  median_high_risk_tx$diabetes, median_high_risk_tx$CAN_PREV_TX,
#                  median_high_risk_tx$ischemic_time,
#                  median_high_risk_tx$kdpi)
#                  
# 
# low_EPTS <- to_plot %>%
#   mutate(low_EPTS = ifelse(raw_epts <= summary(to_plot$raw_epts)["1st Qu."], 1, 0)) %>%
#   filter(low_EPTS ==1)
# 
# 
# med_epts <- median(low_EPTS$raw_epts, na.rm = TRUE)
# 
# median_low_epts <- low_EPTS %>%
#   mutate(diff = abs(raw_epts- med_epts)) %>%
#   arrange(diff) %>%
#   filter(row_number()==2)
# 
# median_low_epts$t_1
# 
# low_EPTS_plot <- survival_benefit(median_low_epts$t_1,
#                                   median_low_epts$center,
#                  median_low_epts$age, median_low_epts$dialysis_time_years,
#                  median_low_epts$diabetes, median_low_epts$CAN_PREV_TX,
#                  median_low_epts$ischemic_time,
#                  median_low_epts$kdpi)
```

```{r}
# high_urgency_plot_low_kdpi <- survival_benefit(median_high_risk_tx$t_1, median_high_risk_tx$center, 
#                  median_high_risk_tx$age, median_high_risk_tx$dialysis_time_years,
#                  median_high_risk_tx$diabetes, median_high_risk_tx$CAN_PREV_TX,
#                  median_high_risk_tx$ischemic_time,
#                  15)
# 
# high_urgency_plot_high_kdpi <- survival_benefit(median_high_risk_tx$t_1, median_high_risk_tx$center, 
#                  median_high_risk_tx$age, median_high_risk_tx$dialysis_time_years,
#                  median_high_risk_tx$diabetes, median_high_risk_tx$CAN_PREV_TX,
#                  median_high_risk_tx$ischemic_time,
#                  85)
# 
# low_EPTS_plot_low_kdpi <- survival_benefit(median_low_epts$t_1,
#                                   median_low_epts$center,
#                  median_low_epts$age, median_low_epts$dialysis_time_years,
#                  median_low_epts$diabetes, median_low_epts$CAN_PREV_TX,
#                  median_low_epts$ischemic_time,
#                  15)
# 
# low_EPTS_plot_high_kdpi <- survival_benefit(median_low_epts$t_1,
#                                   median_low_epts$center,
#                  median_low_epts$age, median_low_epts$dialysis_time_years,
#                  median_low_epts$diabetes, median_low_epts$CAN_PREV_TX,
#                  median_low_epts$ischemic_time,
#                  85)
# 
# epts_by_kdpi <- grid.arrange(arrangeGrob(low_EPTS_plot_low_kdpi + 
#                            theme(legend.position="none",
#                                  title = element_text(size = 8)) +
#                            labs(title = "KDPI 15%"),
#                          low_EPTS_plot_high_kdpi  +  
#                            theme(legend.position="none",
#                                  title = element_text(size = 8)) + 
#                            labs(title = "KDPI 85%"),
#                          nrow=1),
#              surv_beneift_legend,
#              nrow=2,heights=c(10, 3))
# 
# 
# ggsave("epts_by_kdpi.pdf", epts_by_kdpi)
# 
# 
# high_urgency_by_kdpi <- grid.arrange(arrangeGrob(high_urgency_plot_low_kdpi + 
#                            theme(legend.position="none",
#                                  title = element_text(size = 8)) +
#                            labs(title = "KDPI 15%"),
#                          high_urgency_plot_high_kdpi  +  
#                            theme(legend.position="none",
#                                  title = element_text(size = 8)) + 
#                            labs(title = "KDPI 85%"),
#                          nrow=1),
#              surv_beneift_legend,
#              nrow=2,heights=c(10, 3))
# 
# 
# ggsave("high_urgency_by_kdpi.pdf", high_urgency_by_kdpi)
```


```{r}
to_plot %>%
  select(EPTS, S_wait, benefit) %>%
  cbind(recip_5yr_kdpi_15 %>% select(benefit_15 = benefit),
        recip_5yr_kdpi_60 %>% select(benefit_60 = benefit),
        recip_5yr_kdpi_85 %>% select(benefit_85 = benefit)) %>%
  mutate(risk_group = case_when(
    EPTS <= 20 ~ "Top 20% EPTS",
    S_wait <= summary(to_plot$S_wait)["3rd Qu."] ~ "Top 20% Urgent")) %>%
  na.omit() %>%
  group_by(risk_group) %>%
  summarise(kdpi_15 = mean(benefit_15, na.rm = TRUE),
            kdpi_85 = mean(benefit_85, na.rm = TRUE),
            total= n(),
            var_15 = var(benefit_15, na.rm = TRUE),
            var_85 = var(benefit_85, na.rm = TRUE),
            cov = cov(benefit_15, benefit_85)) %>%
  mutate(difference = kdpi_15- kdpi_85,
         var_diff = var_15 + var_85 + 2*cov,
         se_diff = sqrt(var_diff/(total-1)),
         low_ci_diff = difference - 1.96*se_diff,
         up_ci_diff = difference + 1.96*se_diff
         ) %>%
  select(
    "Group" = risk_group,
    "LiST-5 with KDPI 15 (%)" = kdpi_15,
    "LiST-5 with KDPI 85 (%)"= kdpi_85,
    "Improvement with lower KDPI kidney" = difference,
    low_ci_diff,
    up_ci_diff
  ) %>%
  #mutate_if(is.numeric, function(x) round(100*x, 1)) %>%
  mutate("95% CI" = paste0("(", low_ci_diff, ",", up_ci_diff, ")")) %>%
  select(-low_ci_diff, -up_ci_diff) %>%
  write_csv("epts_vs_urgency.csv")
```


\pagebreak
## Between-center variation in the survival benefit

```{r median_recip_full_adjust, eval = FALSE}
# l_ctrs_dm <- list(t_transplant <- rep(median_t_transplant, length(centers)),
#                             ctrs <- centers,
#           Age <- rep(median_age, length(centers)),
#           d_time <- rep(median_d_time, length(centers)),
#           diabetes <- rep(1, length(centers)),
#           CAN_PREV_TX <- rep(0, length(centers)),
#           ischemic_time <- rep(median_ischemic_time, length(centers)),
#           kdpi <- rep(median_kdpi, length(centers)),
#           output <- rep(1825, length(centers))
# )
# 
# possibly_sb <- possibly(survival_benefit, 
#                         otherwise = tibble(S_tx = NA, S_wait = NA, benefit = NA) %>%
#                           mutate_all(as.numeric))
# 
# sb_by_center_dm <- pmap_dfr(l_ctrs_dm, possibly_sb)
```

```{r benefit_by_center_df}
centers <- rownames(ranef(full_me_model)$center)
benefit_by_center <- recips %>%
  select(center) %>%
  cbind(recip_5yr_donor_adjust) %>%
  group_by(center) %>%
  na.omit() %>%
  select(benefit) %>%
  summarise(mean  = mean(benefit),
            median = median(benefit),
            sd = sd(benefit),
            pct_25 = pct(benefit, 0.25),
            pct_75 = pct(benefit, 0.75),
            total_tx = n()) %>%
  mutate(low_ci = mean - 1.96*sd/sqrt(total_tx-1),
         up_ci = mean + 1.96*sd/sqrt(total_tx-1),
         kdpi = median_kdpi) %>%
  ungroup() %>%
  arrange(mean) %>%
  mutate(rank = row_number())

kdpi_15_benefit_center <- recips %>%
  select(center) %>%
  cbind(recip_5yr_kdpi_15) %>%
  group_by(center) %>%
  na.omit() %>%
  select(benefit) %>%
  summarise(mean  = mean(benefit),
            median = median(benefit),
            sd = sd(benefit),
            pct_25 = pct(benefit, 0.25),
            pct_75 = pct(benefit, 0.75),
            total_tx = n()) %>%
  mutate(low_ci = mean - 1.96*sd/sqrt(total_tx-1),
         up_ci = mean + 1.96*sd/sqrt(total_tx-1),
         kdpi = 15) %>%
  ungroup() %>%
  arrange(mean) %>%
  mutate(rank = row_number())

kdpi_60_benefit_center <- recips %>%
  select(center) %>%
  cbind(recip_5yr_kdpi_60) %>%
  group_by(center) %>%
  na.omit() %>%
  select(benefit) %>%
  summarise(mean  = mean(benefit),
            median = median(benefit),
            sd = sd(benefit),
            pct_25 = pct(benefit, 0.25),
            pct_75 = pct(benefit, 0.75),
            total_tx = n()) %>%
  mutate(low_ci = mean - 1.96*sd/sqrt(total_tx-1),
         up_ci = mean + 1.96*sd/sqrt(total_tx-1),
         kdpi = 60) %>%
  ungroup() %>%
  arrange(mean) %>%
  mutate(rank = row_number())

benefit_by_center <- benefit_by_center %>%
  rbind(kdpi_15_benefit_center) %>%
  rbind(kdpi_60_benefit_center)
```

```{r risk_iqr_by_centers}
iqr <- function(x, d=0) paste0(round(100*quantile(x, na.rm = TRUE)[[2]], digits = d), ",", round(100*quantile(x, na.rm = TRUE)[[4]], digits = d))

wait_summary_centers <- recips %>%
  select(center) %>%
  cbind(recip_5yr_donor_adjust) %>%
  group_by(center) %>%
  summarise(mean_wait = mean(S_wait, na.rm = TRUE))

min_ctr_wait <- round(100*min(wait_summary_centers$mean_wait))
max_ctr_wait <- round(100*max(wait_summary_centers$mean_wait))
wait_list_iqr_center <- iqr(wait_summary_centers$mean_wait)

post_summary_centers <- recips %>%
  select(center) %>%
  cbind(recip_5yr_donor_adjust) %>%
  group_by(center) %>%
  summarise(mean_post = mean(S_tx, na.rm = TRUE))

min_ctr_post <- round(100*min(post_summary_centers$mean_post))
max_ctr_post <- round(100*max(post_summary_centers$mean_post))
post_list_iqr_center <- iqr(post_summary_centers$mean_post)

corr_wait_post <- cor(wait_summary_centers$mean_wait, post_summary_centers$mean_post)

min_benefit <- round(100*min(filter(benefit_by_center, kdpi ==43)$mean))
max_benefit <- round(100*max(filter(benefit_by_center, kdpi ==43)$mean))

benefit_iqr_center <- iqr(filter(benefit_by_center, kdpi ==43)$mean)


diff_vector <- recip_5yr_kdpi_15$benefit - recip_5yr_kdpi_60$benefit
diff_15_60 <- round(100*mean(diff_vector, na.rm =TRUE), 1)

diff_iqr <- iqr(diff_vector,1)
```

There were large, statistically significant transplant center effects on the risk of death with and without transplantation (see **Table S2B** for center effects on log hazard scale). The average five-year risk of death without a transplant ranged from `r min_ctr_wait`% to `r max_ctr_wait`% (IQR [`r wait_list_iqr_center`%]). There was less between-center variation in the average five-year post-transplant survival with a median KDPI kidney (`r median_kdpi`%), ranging from `r min_ctr_post`% to `r max_ctr_post`% (IQR [`r post_list_iqr_center`%]). The correlation between average center risk of death with and without transplantation was strongly positive ($\rho$ = `r round(corr_wait_post, 2)`). The significant between-center variation in the risk of death with and without transplantation translates into substantial between-center in the survival benefit of DDKT (**Figure 5**). 

The five-year survival benefit is associated with a median KDPI (`r median_kdpi`%) donor kidney varied from `r min_benefit`% to `r max_benefit`% (IQR `r benefit_iqr_center`%). In contrast, the average improvement in survival benefit of a KDPI 15% kidney compared to a KDPI 60% kidney was only `r diff_15_60`% (IQR `r diff_iqr`%).


### Figure W: LiST-5 of transplanation at a high and low benefit center
```{r}
high_benefit_center <- survival_benefit(median_t_transplant, 100,
                                        median_age, median_d_time, 0, 0,
                 median_ischemic_time,
                 median_kdpi)
```

```{r}
low_benefit_center <- survival_benefit(median_t_transplant, 63,median_age, median_d_time, 0, 0,
                 median_ischemic_time,
                 median_kdpi)
```
```{r}
high_low_benefit_center_example <- grid.arrange(arrangeGrob(low_benefit_center +
                           theme(legend.position="none",
                                 title = element_text(size = 8)) +
                           labs(title = "Low benefit center"),
                         high_benefit_center  +
                           theme(legend.position="none",
                                 title = element_text(size = 8)) +
                           labs(title = "High benefit center"),
                         nrow=1),
             surv_beneift_legend,
             nrow=2,heights=c(10, 3))

ggsave("high_low_benefit_center.pdf", high_low_benefit_center_example)
```
```{r}
survival_benefit(median_t_transplant, 63,median_age, median_d_time, 0, 0,
                 median_ischemic_time,
                 median_kdpi,
                 output = "table")
```

```{r}
survival_benefit(median_t_transplant, 100,median_age, median_d_time, 0, 0,
                 median_ischemic_time,
                 median_kdpi,
                 output = "table")
```

## Shared-decision making: Take the offer or wait for a better one?

```{r wait_for_better_function}
wait_for_better <- function(t_a, kdpi_a, i_time_a,
                            t_b, kdpi_b, i_time_b,
                            Age, d_time, diabetes, CAN_PREV_TX, ctr_id = "mean center", 
                            output = "plot",  me_model = full_me_model, 
                            isch_cuts = i_time_cuts, b_hazard = full_base_hz,
                            post_tx_int_1 = 30, post_tx_int_2 = 180){

  df <- survival_benefit(t_a, ctr_id, Age, d_time, diabetes, CAN_PREV_TX, i_time_a, kdpi_a,
                   output = "dataframe") %>%
    select(time, hazard, hazard_wait, S_a = S_tx, S_wait)
  
  
  log_hr_post_1 <- log_hazard(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, i_time_b, kdpi_b, 
                                     model = me_model, icuts = isch_cuts, period = "post_1") 
  
  log_hr_post_2 <- log_hazard(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, i_time_b, kdpi_b, 
                                     model = me_model, icuts = isch_cuts, period = "post_2")              

  log_hr_post_3 <- log_hazard(ctr_id, Age, d_time, diabetes, CAN_PREV_TX, i_time_b, kdpi_b, 
                                     model = me_model, icuts = isch_cuts, period = "post_3") 
  
  t_b <- t_b - t_a
   
  df <- df %>%
    mutate(hazard_b = case_when(
      time < t_b ~ hazard_wait,
      time < t_b + post_tx_int_1 ~ hazard*exp(log_hr_post_1),
      time < t_b + post_tx_int_2 ~ hazard*exp(log_hr_post_2),
      TRUE ~ hazard*exp(log_hr_post_3)
    ),
    H_b = cumsum(hazard_b),
    S_b = exp(-H_b),
    years_from_first_offer = time/365,
               kidney_a = case_when(years_from_first_offer == 0 ~ S_a),
               kidney_b = case_when(time == t_b ~ S_b),
               transplant = case_when(
                   #years_from_first_offer == 0 ~ "First Offer",
                   time == t_b ~ "Receive Kidney B"
               ),
               transplant_surv = case_when(
                   #years_from_first_offer == 0 ~ S_a,
                   time == t_b ~ S_b
               ),
               s_a_better = ifelse(S_a >= S_b, S_a, NA),
               s_a_worse = ifelse(S_b >= S_a, S_a, NA),
               s_b_better = ifelse(S_b >= S_a, S_b, NA),
               s_b_worse = ifelse(S_a >= S_b, S_b, NA)
        ) %>%
        filter(time < t_b + 365*5)
  
    if (all(is.na(df$s_a_worse))) {
        p <- df %>% 
            ggplot(aes(x =years_from_first_offer)) +
            geom_ribbon(aes(ymax = s_a_better, ymin = s_b_worse, fill = "Benefit of A"), alpha = 0.75) 
        
    } else if (all(is.na(df$s_b_worse))) {
        p <- df %>% 
            ggplot(aes(x =years_from_first_offer)) +
            geom_ribbon(aes(ymax = s_b_better, ymin = s_a_worse, fill = "Benefit of B"), alpha = 0.75)
        
    } else {
        p <- df %>% 
            ggplot(aes(x =years_from_first_offer)) +
            geom_ribbon(aes(ymax = s_a_better, ymin = s_b_worse, fill = "Benefit of A"), alpha = 0.75) + 
            geom_ribbon(aes(ymax = s_b_better, ymin = s_a_worse, fill = "Benefit of B"), alpha = 0.75)
        
    }    
    
    if (all(is.na(df$s_b_worse))) {
        p <- p +            
            lims(y = c(0, 1)) +
            ggthemes::theme_gdocs() +
            scale_x_continuous(breaks = seq(0,10, 1)) + 
            scale_color_manual(values = c("darkgreen", "blue", "red")) + 
            scale_fill_manual(values = c("skyblue")) + 
            labs(x = "Years from first offer", 
                 y = "Survival",
                 shape = "Transplant",
                 color = "Scenario",
                 fill = "")
    } else {
        p <- p +            
            lims(y = c(0, 1)) +
            ggthemes::theme_gdocs() +
            scale_x_continuous(breaks = seq(0,10, 1)) + 
            scale_color_manual(values = c("darkgreen", "blue", "red")) + 
            scale_fill_manual(values = c("forestgreen", "skyblue")) + 
            labs(x = "Years from first offer", 
                 y = "Survival",
                 shape = "Transplant",
                 color = "Scenario",
                 fill = "")
    }
    
    if (output == "plot") {

        out <- p +        
            geom_step(aes(y = S_a, color = "Take A now"), size = 0.7) +
            geom_step(aes(y = S_b, color = "Wait for B"), size = 0.7) +
            geom_point(aes(y = kidney_a, shape ="Kidney A"), size = 3) + 
            geom_point(aes(y = kidney_b, shape ="Kidney B"), size = 3) +
            ggrepel::geom_label_repel(aes(y = transplant_surv, label = transplant),
                                      min.segment.length = 0,
                                      nudge_y = -0.15)
    } 
    
    if (output == "wait_plot"){

        out <- p + 
            geom_step(aes(y = S_a, color = "Take kidney A now"), size = 0.7) +
            geom_step(aes(y = S_wait, color = "Waitlist"), size = 0.7)+
            geom_step(aes(y = S_b, color = "Wait for kidney B"), size = 0.7) +
            geom_point(aes(y = kidney_a, shape ="Kidney A"), size = 3) + 
            geom_point(aes(y = kidney_b, shape ="Kidney B"), size = 3) +
            ggrepel::geom_label_repel(aes(y = transplant_surv, label = transplant),
                                      min.segment.length = 0,
                                      nudge_y = -0.15)
          
    }
    
    
    if (output == "rmst"){
        
        df <- df %>%
            mutate(surv_diff = S_a - S_b)
        
        prob_death_pre_b <- (1- filter(df, time == t_b)$S_b)
        
        
        rmst_df <-df %>%
            mutate(days = (S_a - S_b)*(time-lag(time)),
                   days = ifelse(row_number() == 1, 0, days),
                   rmst = cumsum(days)) 
        
        days_a <- round(filter(rmst_df, time == 5*365)$rmst, digits = 1)
        
        if (days_a < 0){
            out <-  paste0("waiting ", 
                           (t_b), " days for a ", kdpi_b, "% KDPI kidney would increase survival by ", 
                           (-days_a), " days on average within the first 5 years following transplant compared to accepting a ", kdpi_a," KDPI kidney now. The probability the patient dies while waiting for the ", kdpi_b, "% KDPI kidney is ", 
                           round(100*prob_death_pre_b), "%.")
        } else {
            out <-  paste0("accepting a ", kdpi_a, "% KDPI Kidney now would increase survival by ", 
                           days_a, " days on average within the first 5 years following transplant compared to waiting ",(t_b), " days for a ", kdpi_b, "% KDPI Kidney. The probability the patient dies while waiting for the ", kdpi_b, "% KDPI kidney is ", round(100*prob_death_pre_b), "%.")
            
        }
        
    }
    
    if (output == "table"){
        benefit_df <- df %>%
            filter(time %in% c(365, 3*365, 5*365))
        
        
        out <- benefit_df %>%
            mutate(surv_benefit = S_a - S_b,
                   sb_a = S_a - S_wait,
                   sb_b = S_b - S_wait,
                   years_from_first_offer = time/365) %>%
            select("Years from first offer" = years_from_first_offer , 
                   "Survival (accept A)" = S_a,
                   "Survival (wait for B)" = S_b,
                   "Survival (waitlist)" = S_wait, 
                   "Survival Benefit of Accepting A compared to waiting forever" = sb_a,
                   "Survival Benefit of wating for B compared to waiting forever" = sb_b,
                   "Survival Benefit of Accepting A over waiting for B" = surv_benefit) %>%
            mutate(across(c(2,3,4,5,6,7), percent)) 
        
    }
    
    
    
    return(out)
}
```

The decision to take an offer or wait for a better one was highly non-linear and both candidates and wait time specific (web application to assist physicians and patients in shared-decision making is available at <https://wparker-uchicago.shinyapps.io/DDKT_survival_benefit_compare/>). For the median recipient (`r median_age` years old, `r median_d_time` years of dialysis at time of first offer), `r wait_for_better(median_t_transplant, 60, 20, median_t_transplant + 300, 15, 20,median_age, median_d_time, 0, 0,output = "rmst")` (**Figure 6**).


\pagebreak
### Figure 5: Between-center variation in the survival benefit of deceased donor kidney transplantation

```{r center_estimates_plot}
benefit_by_center %>%
  #mutate(rank = row_number()) %>%
  ggplot(aes(x = rank, y = 100*mean, ymin = 100*low_ci, ymax = 100*up_ci, color = factor(kdpi))) +
  geom_line(size = 1.2) + 
  #geom_errorbar() + 
  #facet_wrap(~Diabetes) + 
  ggthemes::theme_gdocs() + 
  lims(y = c(0,55)) +
  labs(y = "Five-year survival benefit", x= "Center rank", color = "KDPI")
```

Five-year survival benefit of deceased donor kidney transplantation with a KDPI 15%, KDPI 43%(median KDPI), and KDPI 60% donor (N = `r centers %>% length()`). DDKT transplantation programs in the US. Estimates generated by averaging the survival benefit of all recipients transplanted at that center, adjusting for KDPI and ischemic time. Center random intercept and transplant effect are empirical Bayes estimates. The five-year survival benefit is associated with a median KDPI (`r median_kdpi`%) donor kidney varied from `r min_benefit`% to `r max_benefit`% (IQR `r benefit_iqr_center`%). In contrast, the average improvement in survival benefit of a KDPI 15% kidney compared to a KDPI 60% kidney was only `r diff_15_60` (IQR `r diff_iqr`%).
\pagebreak

### Figure 6: Survival under accepting a 60% KDPI kidney now compared to waiting 300 days for a 15% KDPI kidney for the median recipient without diabetes

```{r compare_example}
wait_for_better(median_t_transplant, 60, 20,
                median_t_transplant + 300, 15, 20,
                median_age, median_d_time, 0, 0,
                output = "wait_plot")

text_shared_decision <- wait_for_better(median_t_transplant, 60, 20,
                median_t_transplant + 300, 15, 20,
                median_age, median_d_time, 0, 0,
                output = "rmst")
```
Estimated survival for three scenarios: transplantation now (green), waiting and then undergoing transplantation with a lower KDPI kidney (blue), and waiting indefinitely without transplantation (red). For this `r median_age` year-old patient without diabetes who has `r median_d_time` years of dialysis at time and has waited `r median_t_transplant` days on the waitlist, `r text_shared_decision`

\pagebreak


## Survival benefit by race/ethnicity

```{r summary_stats_by_race_ethnicity}
race_means_old <- to_plot%>%
  group_by(race) %>%
  select(age, dialysis_time_years, diabetes, CAN_PREV_TX, t_1, EPTS, S_wait, S_tx, benefit) %>%
  summarise_all(function(x) mean(x, na.rm = TRUE)) %>%
  mutate(t_1 = round(t_1))

race_median_old <- to_plot%>%
  group_by(race) %>%
  select(age, dialysis_time_years, diabetes, CAN_PREV_TX, t_1, EPTS, S_wait, S_tx, benefit) %>%
  summarise_all(function(x) median(x, na.rm = TRUE)) %>%
  mutate(t_1 = round(t_1))

white_means_old <- to_plot%>%
  mutate(White = ifelse(race == "White", race, "Non-White")) %>%
  group_by(White) %>%
  select(age, dialysis_time_years, diabetes, CAN_PREV_TX, t_1, EPTS, S_wait, S_tx, benefit, no_dial) %>%
  summarise_all(function(x) mean(x, na.rm = TRUE)) %>%
  mutate(t_1 = round(t_1))


white_median_old <- to_plot%>%
  mutate(White = ifelse(race == "White", race, "Non-White")) %>%
  group_by(White) %>%
  select(age, dialysis_time_years, diabetes, CAN_PREV_TX, t_1, EPTS, S_wait, S_tx, benefit) %>%
  summarise_all(function(x) median(x, na.rm = TRUE)) %>%
  mutate(t_1 = round(t_1))
```

Summary statistics for key model variables by race/ethnicity can be found in **Table 3**. For an adult candidate listed 2005-2010, the median white recipients waited `r filter(white_median_old, White == "White")$t_1` days for transplantation compared to `r filter(white_median_old, White == "Non-White")$t_1` days for the median non-white recipient, `r filter(white_median_old, White == "Non-White")$t_1- filter(white_median_old, White == "White")$t_1` days longer (p\<0.01). White recipients were more likely to be transplanted preemptively (`r round(100*filter(white_means_old, White == "White")$no_dial, 1)`% vs. `r round(100*filter(white_means_old, White == "Non-White")$no_dial, 1)`%, p \< 0.01) and the median recipient waited `r round(filter(white_median_old, White == "Non-White")$dialysis_time_years - filter(white_median_old, White == "White")$dialysis_time_years, 1)` fewer years on dialysis prior to transplantation (`r round(filter(white_median_old, White == "White")$dialysis_time_years, 1)` vs. `r round(filter(white_median_old, White == "Non-White")$dialysis_time_years, 1)`, p \< 0.01).

```{r epts_characteristics_by_race, eval = FALSE}
# race_means_old %>%
#   mutate(
#          diabetes = paste0(round(100*diabetes), "%"),
#          prev_tx = paste0(round(100*CAN_PREV_TX), "%")) %>%
#   select("Race"= race, 
#          "Years on dialysis" = dialysis_time_years, 
#          "Age" = age, 
#          "Diabetes" = diabetes,
#          "History of Previous transplant" = prev_tx,
#          "EPTS % (2019)" = EPTS,
#          "Surival without transplant" = S_wait,
#          "Survival benfit" = benefit
#          ) %>%
#   knitr::kable(digits = 2)
#   #kable_styling(latex_options = c("striped", "scale_down")) %>%

tbl_summary(to_plot%>%
              mutate("Risk of death without transplant (5-year) %" = 100*(1-S_wait),
                     "Post-transplant survival (5-year) %" = 100*(S_tx),
                     ) %>%
              filter(race != "Other") %>%
  select("Age" = age , 
         "Previous transplant" =CAN_PREV_TX, 
         "Diabetes" = diabetes, 
         "Dialysis (years)" =dialysis_time_years, 
         "Wait list time" = t_1, 
         "Preemptive transplant" = no_dial,
          #"KDPI %(2019)" =kdpi,
         #  "EPTS %(2019)" =EPTS, 
         # "Risk of death without transplant (5-year) %", 
         # "Post-transplant survival (5-year) %", 
         # "Survival Benefit (5-year) %" =benefit, 
         race), by = race, missing = "no")%>% 
  as_kable_extra(booktabs = TRUE,
                 caption = "\\textbf{Table 3: EPTS characteristics by racial/ethnic group, 2005-2010}") %>%
  kableExtra::kable_styling(font_size = 7,
                            latex_options = c("hold_position"))
```

```{r benefit_by_race}

age_distribution <- to_plot %>%
  na.omit() %>%
  filter(CAN_PREV_TX == 0) %>%
  mutate(age_group = cut(age, breaks = c(0, 30, seq(40, 70, 10), 100))) %>%
  count(age_group) %>%
  mutate(pct = n/sum(n))


age_adjusted_rates_by_race <- to_plot %>%
  na.omit() %>%
  filter(CAN_PREV_TX == 0) %>%
  mutate(age_group = cut(age, breaks = c(0, 30, seq(40, 70, 10), 100))) %>%
  group_by(race, age_group) %>%
  summarise(mean_benefit = mean(benefit),
            mean_wait_surv = mean(S_wait),
            mean_post_surv = mean(S_tx),
            total_tx = n()) %>%
  ungroup() %>%
  left_join(age_distribution) %>%
  mutate(weighted_rate = mean_benefit*pct,
         weighted_wait_s = mean_wait_surv*pct,
         weighted_post_s = mean_post_surv*pct) %>%
  group_by(race) %>%
  summarise(mean_benefit = sum(weighted_rate),
            mean_wait = sum(weighted_wait_s),
            mean_post_s = sum(weighted_post_s),
            total_tx = sum(total_tx)) %>%
  mutate("Survival benefit %" = 100*mean_benefit,
         "Mortality without transplant %" = 100*(1-mean_wait))
```

After age-adjustment, the average white recipient in our cohort had a five-year survival benefit `r round(100*filter(age_adjusted_rates_by_race, race == "White")$mean_benefit,1)`%, significantly lower than Black recipients (`r round(100*filter(age_adjusted_rates_by_race, race == "Black")$mean_benefit,1)`%), Hispanic recipients (`r round(100*filter(age_adjusted_rates_by_race, race == "Hispanic/Latino")$mean_benefit,1)`%), and Asian/pacific islander recipients (`r round(100*filter(age_adjusted_rates_by_race, race == "Asian/Pacific Islander")$mean_benefit,1)`%) (**Table 4**, p\<0.01) for all comparisons).


## Racial disparities in dialysis time and preemptive transplantation
```{r race_trends_df}

race_trends <- recips_over_time %>%
  mutate(year = year(REC_TX_DT),
         no_dial = ifelse(dialysis_time_years == 0, 1, 0)) %>%
  group_by(year, race) %>% 
  summarise(mean_d_time = mean(dialysis_time_years),
            median_d_time = median(dialysis_time_years),
            lower_5 = pct(dialysis_time_years, 0.05),
            upper_95 = pct(dialysis_time_years, 0.95),
            lower_25 = pct(dialysis_time_years, 0.25),
            upper_75 = pct(dialysis_time_years, 0.75),
            pre_emeptive = mean(no_dial))
```

Racial disparities in dialysis time persisted from 2010-2020 despite the implementation of KAS in 2014 (**Figure 7**). In 2013, the median dialysis time for a White recipient was `r round(filter(race_trends, race == "White" & year ==2013)$median_d_time, 1)` years compared to `r round(filter(race_trends, race == "Black" & year ==2013)$median_d_time, 1)` years for Black recipients. In 2019, the median dialysis time for a White recipient was `r round(filter(race_trends, race == "White" & year ==2019)$median_d_time, 1)` years compared to `r round(filter(race_trends, race == "Black" & year ==2019)$median_d_time, 1)` years for Black recipients. The disparity in preemptive transplants increased (**Figure 8**). In 2013, `r round(100*filter(race_trends, race == "White" & year ==2013)$pre_emeptive)`% of White recipients received a preemptive transplant compared to `r round(100*filter(race_trends, race == "Black" & year ==2013)$pre_emeptive)`% of Black recipients. In 2019, `r round(100*filter(race_trends, race == "White" & year ==2019)$pre_emeptive)`% of White recipients received a preemptive transplant compared to `r round(100*filter(race_trends, race == "Black" & year ==2019)$pre_emeptive)`% of Black recipients.

\pagebreak
### Table 3: EPTS characteristics by racial/ethnic group, 2005-2010
```{=tex}
\begin{table}[!h]
\centering
\begin{tabular}[t]{lllll}
\toprule
Characteristic & Asian/Pacific Islander & Black  & Hispanic/Latino  & White \\
& N = 4,378 & N = 20,705 & N = 9,709 & N = 28,941 \\
\midrule
Age & 56 (45, 63) & 52 (43, 61) & 53 (42, 61) & 57 (47, 65)\\
Previous transplant & 407 (9.3\%) & 2,370 (11\%) & 1,067 (11\%) & 5,184 (18\%)\\
Diabetes & 1,573 (36\%) & 7,554 (36\%) & 4,160 (43\%) & 9,112 (31\%)\\
Dialysis (years) & 4.1 (2.1, 6.5) & 4.4 (2.6, 6.7) & 4.7 (2.6, 7.2) & 2.5 (0.8, 4.2)\\
Wait list time & 1,108 (511, 1,842) & 946 (420, 1,567) & 993 (418, 1,785) & 644 (239, 1,161)\\
\addlinespace
Preemptive transplant & 303 (6.9\%) & 1,080 (5.2\%) & 490 (5.0\%) & 4,444 (15\%)\\
\bottomrule
\multicolumn{5}{l}{\rule{0pt}{1em}\textsuperscript{1} Median (IQR); n (\%)}\\
\end{tabular}
\end{table}
```

After age-adjustment, the average white recipient in our cohort had a five-year survival benefit of 29.3\%, significantly lower than Black
recipients (32.6\%), Hispanic recipients (33.1\%), and Asian/pacific
islander recipients (33.3\%) (\textbf{Table 4}, p\textless0.01) for all comparisons).
```{r table_4, eval =FALSE}
age_adjusted_rates_by_race %>%
  arrange(-mean_benefit) %>%
  filter(race != "Other") %>%
  select("Race/ethnicity" = race,
         "Mortality without transplant %",
         "Survival benefit %") %>%
  kable(digits = 1, 
        booktabs = T,
        caption = "\\textbf{Table 4: Age-adjusted five-year mortality without a transplant and survival benefit by racial/ethnic group}") %>%
  kableExtra::kable_styling(latex_options = c("hold_position"))

```

### Table 4: Age-adjusted five-year mortality without a transplant and survival benefit by racial/ethnic group
```{=tex}
\begin{table}[!h]
\centering
\begin{tabular}[t]{lrr}
\toprule
Race/ethnicity & Mortality without transplant \% & Survival benefit \%\\
\midrule
Asian/Pacific Islander & 51.2 & 33.3\\
Hispanic/Latino & 52.7 & 33.1\\
Black & 52.0 & 32.6\\
White & 45.4 & 29.3\\
\bottomrule
\end{tabular}
\end{table}
```

5-year mortality without a transplant (medical urgency) and survival benefit for first-time deceased donor kidney transplant recipients by race/ethnicity, age-adjusted using direct-standardization with age bins of (0,30),(30,40), (40,50), (50,60), (70+).

\pagebreak
### Figure 7: Trends in median dialysis time by race/ethnicity

```{r plot_median_dialysis_trend}
race_trends %>%
  filter(race != "Other") %>%
  ggplot(aes(x = year, y = median_d_time, color = race)) +
  geom_vline(aes(xintercept = 2014.463, linetype ="KAS implemented")) + 
  geom_line() + geom_point() + 
  #geom_errorbar() + 
  scale_linetype_manual(values = "dashed") + 
  ggthemes::theme_gdocs() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
  labs(color = "Race/Ethnicity", linetype = "", y = "Median dialysis time (years) at transplant", x = "Year") + 
  lims(y = c(0,7)) + 
  scale_x_continuous(breaks = seq(2010, 2020)) 
```

Trends in the median dialysis time at transplant by race/ethnicity. Despite the 2014 change to give candidates credit for pre-listing dialysis time, a large (\>two year) disparity in dialysis time at transplant persists through 2020. Other race/ethnicity groups not shown.
\pagebreak

### Figure 8: Trends in preemptive transplants by race/ethnicity

```{r plot_preemptive_trend}
race_trends %>%
  filter(race != "Other") %>%
  ggplot(aes(x = year, y = 100*pre_emeptive, color = race)) +
  geom_vline(aes(xintercept = 2014.463, linetype ="KAS implemented")) + 
  geom_line() + geom_point() + 
  #geom_errorbar() + 
  scale_linetype_manual(values = "dashed") + 
  ggthemes::theme_gdocs() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) + 
  labs(color = "Race/Ethnicity", linetype = "", y = "Adult pre-emeptive transplants (%)", x = "Year") + 
  scale_x_continuous(breaks = seq(2010, 2020)) + lims(y = c(0,22))
```

Proportion of deceased donor kidney transplants performed preemptively (before the initiation of dialysis) by race/ethnicity over time, as first reported by King et al @King2019.
\pagebreak


# Discussion

In this registry cohort analysis, we found significant variation in the survival benefit of kidney transplantation between patients. Older patients, patients with more dialysis time, and patients with diabetes are at high risk of death on the wait-list and have a greater survival benefit from transplantation. Transplanting patients with higher medical urgency would save more lives than transplanting patients with high estimated post-transplant survival. Recipients in the top 20% EPTS category have lower than average survival benefit within the first five years following transplantation. Within five years, candidates are typically better off taking a higher KDPI kidney when offered compared to waiting for a lower KDPI graft. Adjusting for age, non-white recipients have a higher risk of death on the wait-list *and* a larger survival benefit from transplantation, driven by more dialysis time and higher rates of diabetes.

## Implications for top 20% EPTS priority

Dialysis may be a life-sustaining therapy, but it is far from perfect. The finding that high-quality kidneys from the top 20% KDPI donors confer *more* survival benefit to medically urgent candidates is consistent with prior results [@bae2019] and has immediate policy implications. The current policy of prioritizing the top 20% KDPI kidneys for the top 20% EPTS candidates is inefficient for saving lives. The highest-quality kidneys would save more lives if allocated to higher-risk candidates. While maximizing graft survival is an ethically important consideration, the Final Rule indicates that saving lives by transplanting medically urgent candidates is *at least* as important as total graft years.

## Lives-saved vs. Life-years from transplant (LYFT)

Our approach estimates the **lives saved** with each transplant over a defined time interval (5 years) instead of estimating the total "life-years" gained over the length of a kidney transplant. This difference in outcome explains why our model identifies different "high benefit" groups than Life-Years From Transplant (LFYT) [@wolfe2008]. There are two main arguments for the Kidney Allocation System to focus on lives-saved (short-term survival benefit) instead of LYFT, one technical and one normative.

First, calculation of LYFT requires estimation of the long-term benefits of kidney transplantation with minimal data. While younger patients have more potential lifespan and theoretically more potential life-years to gain, the actual calculation of LYFT has to rely on long-term extrapolations well beyond the support of the available data. Specifically, Wolfe et al. assumed that the relative survival benefit of transplant on the log hazard scale remains constant *even after graft failure*. However, it is more likely that after graft failure, the risk of death would regress to the risk of death on dialysis.

Second, lives saved on a shorter defined interval better identifies "medically urgent" candidates with high short-term benefits from transplantation. The Final Rule does not contain any text about maximizing total quality-adjusted life-years gained by the system. Instead, the regulation clearly states candidates should be ranked "most to least medically urgent (taking into account...that life sustaining technology allows alternative approaches to setting priority ranking for patients)". We argue that short-term survival benefit achieves this aim of the Final Rule, accounting for the risk of death on dialysis while avoiding futile transplants and making "best use of donated organs."

## Racial/ethnic disparities in survival benefit

Applying our model to deceased donor kidney recipients in 2020, we found that non-white recipients have greater age-adjusted survival benefits than white recipients. This result reflects how the racial disparities in access to transplantation make the system less efficient. Longer dialysis time at listing means non-white candidates are at higher risk of death on the wait-list before transplantation. The current kidney allocation system compounds this disparity by prioritizing candidates with less dialysis time via the top 20% EPTS priority for the top 20% KDPI kidneys.

The persistent racial disparities in preemptive transplantation and median dialysis time are archetypal examples of structural racism in healthcare. There is no explicit racially discriminatory language in the Kidney Allocation System. Nevertheless, non-white recipients wait two years longer on dialysis before receiving a transplant. The OPTN has a moral obligation to modify KAS to counteract this structural disparity. The data in this report and others [@King2019] demonstrate that counting pre-waiting listing dialysis time was insufficient. The recent expansion of geographic sharing may mitigate the disparity somewhat, but the OPTN must study more immediate solutions. For example, eliminating any points for pre-dialysis wait-list time could dramatically improve equity *and*, as shown by our model, save more lives. Thus there would be no equity-efficiency trade-off when addressing racial/ethnic disparities in KAS; correcting the structural racism would save more lives overall.

## Eliminating points for pre-dialysis waiting time

Ku et al. have shown that higher eGFR thresholds for Black patients could alleviate disparities in transplantation [@Ku2021]. However, our results suggest a more radical course of action would reduce disparities in transplantation and save more lives. The predominantly white preemptive transplant recipients have significantly lower survival benefit.

If the goal of kidney allocation policy is to save lives, it is neither fair nor efficient to perform low benefit preemptive transplants. It is twice as efficient when the system transplants a patient who has suffered over five years of dialysis and a history of diabetes compared to a non-diabetic preemptive transplant. The OPTN should study the consequences of eliminating any pre-dialysis waiting time on overall graft survival and lives saved by the system.

## Limitations

Our study has several limitations. First, our model had a c-statistic of 0.69, which represents good but not excellent discrimination. This suggests that our model should not be used as the only candidate ranking criterion in the kidney allocation system. Limiting the covariates to those currently used in the Kidney Allocation System may have reduced model performance. However, the model has the same accuracy as the EPTS model while predicting risk in 4 distinct time periods [@eptscal]. Therefore, our survival benefit estimates could be used to balance medical urgency with other ethically relevant factors in scarce resource allocation. Second, our center estimates are not case-mix adjusted for observed candidate covariates to reflect center selection practices. However, the prevalence of chronic kidney disease and potential candidates' demographics vary considerably across the country [@Saran2020], so adjustment for specific candidate covariates (e.g., age) may be appropriate. Third, increased risk of death (medical urgency) at a transplant center may reflect poor pre-transplantation care rather than truly higher medical risk. However, when transplanted, these higher-risk candidates receive dramatic improvements in survival, indicating high-quality post-transplantation care. Finally, we focused on the five-year survival benefit in this study to demonstrate the enormous benefit on a clinically relevant scale. However, policymakers will need to use shorter time frames or hazard ratios to evaluate programs more rapidly in practice.

## Conclusion

Deceased donor kidney transplant candidates have a widely varying risk of death without a transplant. In general, transplanting higher-risk candidates saves more lives in the first five years. The current Kidney Allocation System ignores the Final Rule requirements to rank-order candidates by medical urgency. Severe racial/ethnic disparities persist within deceased donor kidney allocation, which the OPTN must directly address by radical policy changes such as eliminating pre-dialysis waiting time points. With a shift in focus to survival benefit, deceased donor kidney transplantation can save more lives and improve equity.


```{r, eval=FALSE}
to_plot %>%
  mutate(S_wait = cut(100*(S_wait), breaks = seq(0, 100, 1), labels = FALSE)) %>%
  group_by(S_wait) %>%
  summarise(benefit = mean(benefit, na.rm = TRUE),
            S_tx = mean(S_tx, na.rm = TRUE)) %>%
  mutate(waitlist_risk = 100-S_wait) %>%
  ggplot(aes(x = 100*benefit, ymin= S_wait, ymax = 100*S_tx)) + 
  #geom_linerange() + 
  geom_segment(aes(xend = 100*benefit, y = S_wait,  
                   #color = 100*benefit,
                   yend = 100*S_tx), alpha = 0.5) + 
  geom_point(aes(y = S_wait, shape = "Without transplantation", color = "Without transplantation"), ) + 
  geom_point(aes(y = 100*S_tx, shape = "Transplantation", color ="Transplantation")) +
  labs(y = "Survival (%)", x = "Survival benefit (%)", shape = "", color = "") +
  scale_shape_manual(values = c(17,16)) +
  scale_color_manual(values = c("darkgreen", "red")) + 
  ggthemes::theme_gdocs()
```

```{r, eval = FALSE}
### Figure: Survival benefit of deceased donor kidney transplantation by estimated post-transplant survival
to_plot %>%
  mutate(post_transplant = cut(100*S_tx, breaks = seq(0, 100, 1), labels = FALSE)) %>%
  group_by(post_transplant) %>%
  summarise(mean_benefit = mean(benefit, na.rm = TRUE),
            sd_benefit = sd(benefit, na.rm = TRUE),
            total_tx = n()) %>%
  filter(total_tx > 1) %>%
  mutate(lower_ci = mean_benefit- 1.96*sd_benefit/sqrt(total_tx-1),
         upper_ci = mean_benefit + 1.96*sd_benefit/sqrt(total_tx-1)) %>%
  #mutate(diabetes = ifelse(diabetes == 1, "Diabetes", "No Diabetes")) %>%
  ggplot(aes(x = post_transplant, y = 100*mean_benefit, ymin = 100*lower_ci, ymax = 100*upper_ci)) +
  geom_point() + geom_errorbar() +
  ggthemes::theme_gdocs() + labs(x = "Five-year Estimated Post-transplant Survival", y = "Five-year survival benefit") 
```






\pagebreak
# References
